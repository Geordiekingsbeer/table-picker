<script>
        const SUPABASE_URL = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
        const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
        const _supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

        const CURRENT_TENANT_ID = 'R-VERIFIED-Z99';
        const statusElement = document.getElementById('status');

        async function loadReports() {
            try {
                // 1. Fetch Engagement Funnel Data (REMOVED .single())
                const { data: funnelData, error: funnelError } = await _supa
                    .from('v_engagement_funnel')
                    .select('*')
                    .eq('tenant_id', CURRENT_TENANT_ID);

                if (funnelError) {
                    throw new Error(funnelError.message);
                }

                const funnel = funnelData && funnelData.length > 0 ? funnelData[0] : {};
                
                if (Object.keys(funnel).length === 0) {
                    statusElement.textContent = `Report loaded, but no data found for Tenant: ${CURRENT_TENANT_ID}.`;
                    statusElement.style.backgroundColor = '#ffcc80';
                    return;
                }
                
                const linksOpened = funnel.total_links_opened || 0;
                const paidBookings = funnel.total_paid_bookings || 0;
                const conversionRate = (linksOpened > 0) ? ((paidBookings / linksOpened) * 100).toFixed(2) + '%' : '0.00%';

                document.getElementById('kpi-link-opened').textContent = linksOpened;
                document.getElementById('kpi-checkout-started').textContent = funnel.total_checkout_started || 0;
                document.getElementById('kpi-paid').textContent = paidBookings;
                document.getElementById('kpi-rate').textContent = conversionRate;


                // 2. Fetch Table Demand Metrics (REMOVED .single())
                const { data: metricsData, error: metricsError } = await _supa
                    .from('v_table_booking_metrics')
                    .select('*')
                    .eq('tenant_id', CURRENT_TENANT_ID);
                
                if (metricsError) {
                    throw new Error(metricsError.message);
                }
                
                const metrics = metricsData && metricsData.length > 0 ? metricsData[0] : {};

                document.getElementById('kpi-2-seat').textContent = metrics.count_2_seaters || 0;
                document.getElementById('kpi-4-seat').textContent = metrics.count_4_seaters || 0;
                document.getElementById('kpi-6-seat').textContent = metrics.count_6_seaters || 0;
                
                statusElement.textContent = `Report loaded successfully for Tenant: ${CURRENT_TENANT_ID}`;
                statusElement.style.backgroundColor = '#b7d7a8';

            } catch (error) {
                console.error("Failed to load reports:", error);
                statusElement.textContent = `Error loading reports: ${error.message}`;
                statusElement.style.backgroundColor = '#ff5050';
            }
        }

        loadReports();
    </script>
