<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Pick Your Table</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <style>
        body{
            font-family: Arial, Helvetica, sans-serif;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            background: #f7f7f7;
        }
        
        h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
        }

        /* Date/Time Selector */
        #datetime-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #datetime-controls input {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        #check-availability {
            padding: 6px 12px;
            background-color: #1976d2; /* Blue for action */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        
        #check-availability:hover {
            background-color: #1565c0;
        }

        #container{
            background:url('floorplan.png') no-repeat center center;
            background-size:contain;
            border:1px solid #ccc;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin:20px auto;
            width:480px;
            height:480px;
            background-color: #fff; /* Ensure Konva sits on top of white */
        }
        
        /* Table Status Indicators */
        .status-legend {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
            display: flex;
            gap: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 5px;
            border: 1px solid #aaa;
        }

        #payBtn{
            margin-top:20px;
            padding:12px 24px;
            font-size:16px;
            background:#388e3c; /* Green for payment */
            color:#fff;
            border:none;
            border-radius:4px;
            cursor:pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #payBtn:disabled{
            background:#bbb;
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>
</head>
<body>
    <h2>Tap the table you want</h2>
    
    <div id="datetime-controls">
        <label for="booking-date">Date:</label>
        <input type="date" id="booking-date" value="">
        <label for="booking-time">Time:</label>
        <input type="time" id="booking-time" value="">
        <button id="check-availability">Check Availability</button>
    </div>

    <div id="container"></div>

    <div class="status-legend">
        <div class="legend-item"><span class="legend-color" style="background-color: #b7d7a8;"></span>Available</div>
        <div class="legend-item"><span class="legend-color" style="background-color: #9e9e9e;"></span>Booked</div>
        <div class="legend-item"><span class="legend-color" style="border: 3px solid #ffeb3b;"></span>Selected</div>
    </div>
    
    <button id="payBtn" disabled>Pay £4.99 – Stripe</button>

    <script>
        // Supabase setup
        const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
        const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
        const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

        const stage = new Konva.Stage({ container: 'container', width: 480, height: 480 });
        const layer = new Konva.Layer();
        stage.add(layer);
        
        const payBtn = document.getElementById('payBtn');
        let selectedTableId = null; 
        let selectedGroup = null; 
        let currentBookings = []; // Array to hold bookings for the selected time slot

        const TABLE_COLOR = '#b7d7a8'; // Available
        const BOOKED_COLOR = '#9e9e9e'; // Booked
        const SEAT_COLOR = '#555'; 
        
        // --- Helper Functions (Copied from Admin) ---

        function timeToMinutes(timeStr) {
            const parts = timeStr.split(':').map(Number);
            const hours = parts[0] || 0;
            const minutes = parts[1] || 0;
            return (hours * 60) + minutes;
        }

        function getSupabaseDate() {
            const dateInput = document.getElementById('booking-date').value;
            if (!dateInput) return '';
            // Only need to handle YYYY-MM-DD from the date picker
            return dateInput.match(/^\d{4}-\d{2}-\d{2}$/) ? dateInput : ''; 
        }

        function setDefaultDateTime() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            
            // Set the state variables in the required YYYY-MM-DD format
            const defaultDate = `${year}-${month}-${day}`;
            const defaultTime = '19:00'; 

            document.getElementById('booking-date').value = defaultDate;
            document.getElementById('booking-time').value = defaultTime;
        }

        // --- Booking Logic (Copied from Admin) ---

        async function loadBookings() {
            const selectedDateSupabase = getSupabaseDate();
            const selectedTime = document.getElementById('booking-time').value;

            if (!selectedDateSupabase || !selectedTime) {
                alert('Please select a valid date and time.');
                return false;
            }

            // 1. Fetch all bookings for the date
            const { data, error } = await _supa
                .from('premium_slots') 
                .select('*')
                .eq('date', selectedDateSupabase); 
                
            if(error){ 
                console.error('Error fetching bookings:', error); 
                alert('Could not check availability. Try again later.'); 
                currentBookings = []; 
                return false;
            } 

            // 2. Filter the fetched data using robust numeric time comparison
            const selectedTimeMinutes = timeToMinutes(selectedTime); 

            currentBookings = data.filter(b => {
                const bookingStartMinutes = timeToMinutes(b.start_time);
                const bookingEndMinutes = timeToMinutes(b.end_time);
                
                return selectedTimeMinutes >= bookingStartMinutes && selectedTimeMinutes < bookingEndMinutes;
            });

            updateTableVisuals();
            return true;
        }

        function updateTableVisuals() {
            // Reset all tables to default (Available) and apply booked status
            stage.find('.main-table').forEach(tableRect => {
                const group = tableRect.getParent();
                const tableId = Number(group.id().substring(2)); // Extract numeric ID from 'g-ID'

                const isBooked = currentBookings.some(b => Number(b.table_id) === tableId);
                
                tableRect.fill(isBooked ? BOOKED_COLOR : TABLE_COLOR);
                tableRect.stroke('#000'); // Reset border highlight

                // If the previously selected table is now booked, deselect it
                if (selectedTableId === tableId && isBooked) {
                    selectedTableId = null;
                    selectedGroup = null;
                    payBtn.disabled = true;
                }
            });
            layer.draw();
        }

        // --- Konva Functions (Modified) ---

        async function loadTables() {
            // Fetch layout data first
            const { data, error } = await _supa.from('tables').select('*, rotation').order('id');
            if (error) { console.error(error); return; }
            
            // Clear layer and draw tables based on layout data
            layer.destroyChildren();
            data.forEach(t => {
                const group = drawTable(t);
                const tableRect = group.findOne('.main-table');
                
                group.offset({ x: tableRect.width()/2, y: tableRect.height()/2 });
                group.x(t.x + tableRect.width()/2);
                group.y(t.y + tableRect.height()/2);
                group.rotation(t.rotation || 0); 
            });
            
            // Now load bookings to set initial statuses
            await loadBookings();
        }
        
        function drawTable(t) {
            const group = new Konva.Group({ 
                x: t.x, 
                y: t.y, 
                id: 'g-' + t.id,
            });
            layer.add(group);

            const tableRect = new Konva.Rect({ 
                width: t.w, 
                height: t.h, 
                fill: TABLE_COLOR, 
                stroke: '#000', 
                strokeWidth: 1,
                name: 'main-table' 
            });
            group.add(tableRect);

            // Add click handler to the group
            group.on('click tap', () => selectTable(t.id));

            // 2. Draw seats (using finalized, flush logic - same as admin)
            const baseSeatSize = 12; 
            const seatHalf = baseSeatSize / 2; 

            function makeSeat(x, y, w, h) {
                group.add(new Konva.Rect({ width:w, height:h, fill:SEAT_COLOR, x:x, y:y }));
            }
            
            if (t.w === 30 && t.h === 30) {
                const seatW = baseSeatSize; 
                const seatH = seatHalf;     
                
                makeSeat(t.w/2 - seatW/2, -seatH, seatW, seatH);            
                makeSeat(t.w/2 - seatW/2, t.h, seatW, seatH);                 
                
            } else if (t.w === 30 && t.h === 50) {
                const seatW = seatHalf;     
                const seatH = baseSeatSize; 
                
                const v_spacing = (t.h - 2 * seatH) / 3; 
                
                makeSeat(-seatW, v_spacing, seatW, seatH);                  
                makeSeat(-seatW, v_spacing * 2 + seatH, seatW, seatH);       
                
                makeSeat(t.w, v_spacing, seatW, seatH);                   
                makeSeat(t.w, v_spacing * 2 + seatH, seatW, seatH);           
                
            } else if (t.w === 90 && t.h === 30) {
                const seatW = baseSeatSize; 
                const seatH = seatHalf;     
                
                const h_spacing = t.w / 4; 
                
                for(let i=0; i<3; i++){
                    const x_pos = h_spacing * (i+1) - seatW/2;
                    makeSeat(x_pos, -seatH, seatW, seatH);                      
                    makeSeat(x_pos, t.h, seatW, seatH);                        
                }
            }
            return group;
        }

        function selectTable(id) {
            const group = layer.findOne('#g-' + id);
            const tableRect = group.findOne('.main-table');

            // --- CRITICAL CHECK: Block if booked ---
            if (tableRect.fill() === BOOKED_COLOR) {
                alert('Sorry, this table is booked for the selected time slot.');
                return;
            }
            // ----------------------------------------

            // Deselect previous table
            if (selectedGroup) {
                selectedGroup.findOne('.main-table').stroke('#000');
            }

            selectedGroup = group;
            selectedTableId = id;
            tableRect.stroke('#ffeb3b'); // Highlight selected table
            payBtn.disabled = false;
            layer.draw();
        }

        // --- Event Listeners ---

        document.getElementById('check-availability').onclick = async () => {
            selectedTableId = null;
            selectedGroup = null;
            payBtn.disabled = true;
            await loadBookings();
        };

        // Note: The original payment logic is retained below
        payBtn.onclick = async () => {
            if (!selectedTableId) return;
            // The table must not be currently booked AT THE MOMENT OF PAYMENT
            const currentGroup = layer.findOne('#g-' + selectedTableId);
            if (currentGroup.findOne('.main-table').fill() === BOOKED_COLOR) {
                alert("Error: The selected table was just booked. Please re-check availability.");
                return;
            }

            const email = prompt('Enter your email for confirmation:');
            if (!email) return alert('Email is required');
            try {
                // NOTE: You may need to pass the date/time to your Stripe backend if you want to record the slot booking there.
                const res = await fetch('https://stripe-serverless-git-main-geordies-projects-8a74623d.vercel.app/api/create-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        table_id: selectedTableId, 
                        email: email 
                    })
                });
                const data = await res.json();
                if (data.url) {
                    window.location.href = data.url;    
                } else {
                    console.error(data);
                    alert('Checkout creation failed. See console for details.');
                }
            } catch (err) {
                console.error(err);
                alert('Checkout creation failed. See console for details.');
            }
        };

        // --- Initialization ---
        setDefaultDateTime(); // Set default date/time inputs
        loadTables();         // Load layout and initial bookings
    </script>
</body>
</html>
