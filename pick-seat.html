<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/konva@9/konva.min.js"></script>
<script>
/* ---------- CONFIG/CONSTANTS ---------- */
const STAGE_WIDTH  = 480;
const STAGE_HEIGHT = 480;
const supabaseUrl  = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

// --- Prices (Cents/Pence) ---
const PRICE_2 = 499, PRICE_4 = 999, PRICE_6 = 1499;

// --- Colors & IDs ---
const TABLE_COLOR = '#b7d7a8', BOOKED = '#e0e0e0', STAFF = '#ffffff', HIGHLIGHT = '#ffeb3b';
const SEAT_COLOR = '#555';
const STAFF_IDS = [10, 13, 12, 14, 1]; // Staff Use Only IDs

// --- API URL ---
const STRIPE_CHECKOUT_API_URL = 'https://stripe-serverless-phi.vercel.app/api/create-checkout';

let selectedIds = [], bookings = [], isMulti = false, urlParams = {};
let tableMap = new Map();

/* ---------- UI ELEMENTS & KONVA SETUP ---------- */
const container = document.getElementById('container');
const payBtn = document.getElementById('payBtn');
const multiSelectToggle = document.getElementById('multi-select-toggle');
const customerModal = document.getElementById('customer-modal');
const customerForm = document.getElementById('customer-form');

const stage = new Konva.Stage({container:'container',width:STAGE_WIDTH,height:STAGE_HEIGHT});
const bgLayer = new Konva.Layer(), tblLayer = new Konva.Layer();
stage.add(bgLayer); stage.add(tblLayer);

/* ---------- UTILS ---------- */
function timeToMin(t){ const [h,m] = t.split(':').map(Number); return h*60 + m; }
function getSupabaseDate(){ return document.getElementById('booking-date').value; }

function getPrice(w,h){
  if(w===30 && h===30) return PRICE_2;
  if((w===30 && h===50)||(w===50 && h===30)) return PRICE_4;
  if(w===90 && h===30) return PRICE_6;
  return 0;
}
function totalPence(){ return selectedIds.reduce((t,id)=>t+(tableMap.get(id)?.price||0),0); }
function updateBtn(){
  const p = totalPence();
  payBtn.disabled = !p;
  payBtn.textContent = p ? `Pay £${(p/100).toFixed(2)} – Stripe` : 'Pay for 0 Tables – Stripe';
}

function setDefaultDateTime(){
  const today=new Date(), y=today.getFullYear(), m=String(today.getMonth()+1).padStart(2,'0'), d=String(today.getDate()).padStart(2,'0');
  document.getElementById('booking-date').value=`${y}-${m}-${d}`;
  document.getElementById('booking-time').value='19:00';
}

/* ---------- URL PARAMS & RESIZE ---------- */
function getUrlParams(){
  const u = new URLSearchParams(location.search);
  urlParams.tenant_id = u.get('tenant_id') || 'R-DEMO';
  urlParams.booking_ref = u.get('booking_ref');
  urlParams.source      = u.get('source');
}
function logInitialClick() {
  if (urlParams.booking_ref) console.log(`Tracking: Initial view for booking ${urlParams.booking_ref}`);
}

function resize(){
  const w = container.offsetWidth, scale = w/STAGE_WIDTH;
  stage.width(w); stage.height(STAGE_HEIGHT*scale);
  stage.scale({x:scale,y:scale});
  container.style.height = STAGE_HEIGHT*scale+'px';
  stage.draw();
}
window.addEventListener('resize', resize);

/* ---------- LOAD FLOORPLAN ---------- */
function loadFloorplan(cb){
  const img = new Image();
  img.onload = ()=>{
    const bgImage = new Konva.Image({
      x:0,y:0,image:img,
      width:STAGE_WIDTH,height:STAGE_HEIGHT
    });
    bgImage.listening(false); // critical fix
    bgLayer.add(bgImage);
    bgLayer.draw();
    if(cb) cb(); // tables load, then resize AFTER
  };
  img.src = 'floorplan.png?v='+Date.now();
}

/* ---------- DRAW TABLES ---------- */
function drawSeats(group, t) {
  const baseSeatSize = 10; // match admin version
  const seatHalf = baseSeatSize / 2;
  function makeSeat(x, y, w, h) {
    group.add(new Konva.Rect({ width:w, height:h, fill:SEAT_COLOR, x:x, y:y }));
  }

  if (t.w === 30 && t.h === 30) {
    makeSeat(t.w/2 - baseSeatSize/2, -seatHalf, baseSeatSize, seatHalf);
    makeSeat(t.w/2 - baseSeatSize/2, t.h, baseSeatSize, seatHalf);
  } else if (t.w === 30 && t.h === 50) {
    const v_spacing = (t.h - 2*baseSeatSize)/3;
    makeSeat(-seatHalf, v_spacing, seatHalf, baseSeatSize);
    makeSeat(-seatHalf, v_spacing*2 + baseSeatSize, seatHalf, baseSeatSize);
    makeSeat(t.w, v_spacing, seatHalf, baseSeatSize);
    makeSeat(t.w, v_spacing*2 + baseSeatSize, seatHalf, baseSeatSize);
  } else if (t.w === 50 && t.h === 30) {
    const h_spacing = (t.w - 2 * baseSeatSize) / 3;
    makeSeat(h_spacing, -seatHalf, baseSeatSize, seatHalf);
    makeSeat(h_spacing * 2 + baseSeatSize, -seatHalf, baseSeatSize, seatHalf);
    makeSeat(h_spacing, t.h, baseSeatSize, seatHalf);
    makeSeat(h_spacing * 2 + baseSeatSize, t.h, baseSeatSize, seatHalf);
  } else if (t.w === 90 && t.h === 30) {
    const h_spacing = t.w / 4;
    for(let i=0; i<3; i++){
      const x_pos = h_spacing*(i+1) - baseSeatSize/2;
      makeSeat(x_pos, -seatHalf, baseSeatSize, seatHalf);
      makeSeat(x_pos, t.h, baseSeatSize, seatHalf);
    }
  }
}

function drawTable(t){
  const g = new Konva.Group({
    id:'g-'+t.id,
    table_id:Number(t.id),
    x:t.x,
    y:t.y
  });
  tblLayer.add(g);

  const isStaffUseOnly = STAFF_IDS.includes(t.id);

  const r = new Konva.Rect({
    width:t.w,
    height:t.h,
    fill:isStaffUseOnly ? STAFF : TABLE_COLOR,
    stroke:'#000',
    strokeWidth:1,
    name:'main-table'
  });
  g.add(r);
  drawSeats(g, t);

  g.offset({x:r.width()/2, y:r.height()/2});
  g.x(t.x + r.width()/2);
  g.y(t.y + r.height()/2);
  g.rotation(t.rotation || 0);

  g.on('click tap',()=>selectTable(t.id));
  tableMap.set(t.id,{id:t.id,price:getPrice(t.w,t.h),rect:r,group:g});
  return g;
}

const baseTables = [
  { id:1,x:235,y:110,w:90,h:30,rotation:0 },
  { id:2,x:100,y:30,w:90,h:30,rotation:0 },
  { id:3,x:100,y:150,w:30,h:30,rotation:0 },
  { id:4,x:140,y:220,w:30,h:30,rotation:0 },
  { id:5,x:180,y:300,w:50,h:30,rotation:90 },
  { id:6,x:250,y:330,w:30,h:30,rotation:0 },
  { id:7,x:30,y:300,w:50,h:30,rotation:90 },
  { id:8,x:400,y:100,w:30,h:30,rotation:0 },
  { id:9,x:20,y:180,w:30,h:50,rotation:0 },
  { id:10,x:300,y:240,w:30,h:30,rotation:0 },
  { id:11,x:40,y:80,w:30,h:30,rotation:0 },
  { id:12,x:350,y:350,w:50,h:30,rotation:0 },
  { id:13,x:400,y:280,w:30,h:30,rotation:0 },
  { id:14,x:250,y:180,w:30,h:30,rotation:0 },
  { id:18,x:140,y:280,w:30,h:30,rotation:0 },
  { id:19,x:220,y:280,w:30,h:30,rotation:0 },
  { id:20,x:300,y:280,w:30,h:30,rotation:0 },
  { id:21,x:300,y:180,w:50,h:30,rotation:90 }
];

async function loadTables(){
  tblLayer.destroyChildren();
  tableMap.clear();
  let tablesToDraw = baseTables;

  try {
    const {data:dbData,error} = await _supa.from('tables').select('id,x,y,rotation').order('id');
    if(dbData && dbData.length>0){
      const posMap = new Map(dbData.map(t=>[t.id,t]));
      tablesToDraw = baseTables.map(t=>{
        const dbPos = posMap.get(t.id);
        return dbPos ? {...t,...dbPos} : t;
      });
    } else if (error) console.warn("Could not fetch table positions from Supabase. Using defaults.");
  } catch(e){ console.error("Error fetching positions:", e); }

  tablesToDraw.forEach(t=>drawTable(t));
  await loadBookings();
  resize(); // ✅ now scale after drawing
}

/* ---------- SELECTION ---------- */
function selectTable(id){
  const data = tableMap.get(id);
  if(!data || data.rect.fill()===STAFF || data.rect.fill()===BOOKED){
    alert('This table is not available for online booking.');
    return;
  }
  const idx = selectedIds.indexOf(id);
  if(idx===-1){
    if(!isMulti){ selectedIds.forEach(i=>tableMap.get(i).rect.stroke('#000')); selectedIds=[]; }
    selectedIds.push(id);
    data.rect.stroke(HIGHLIGHT).strokeWidth(3);
  } else {
    selectedIds.splice(idx,1);
    data.rect.stroke('#000').strokeWidth(1);
  }
  updateBtn(); tblLayer.draw();
}

/* ---------- BOOKINGS ---------- */
async function loadBookings(){
  const date = getSupabaseDate();
  const time = document.getElementById('booking-time').value;
  if(!date||!time){ bookings=[]; updateVisual(); return; }

  const {data,error} = await _supa.from('premium_slots').select('*').eq('date',date);
  if(error){ console.error(error); bookings=[]; }
  else {
    const m = timeToMin(time);
    bookings = data.filter(b=> m>=timeToMin(b.start_time) && m<timeToMin(b.end_time));
  }
  updateVisual();
}

function updateVisual(){
  tableMap.forEach((t)=>{
    t.rect.stroke('#000').strokeWidth(1);
    if(STAFF_IDS.includes(t.id)) t.rect.fill(STAFF);
    else t.rect.fill(bookings.some(b=>Number(b.table_id)===t.id)?BOOKED:TABLE_COLOR);
  });
  const currentSelection = [...selectedIds];
  selectedIds = [];
  currentSelection.forEach(id=>{
    const t=tableMap.get(id);
    if(t.rect.fill()===TABLE_COLOR){
      selectedIds.push(id);
      t.rect.stroke(HIGHLIGHT).strokeWidth(3);
    } else t.rect.stroke('#000').strokeWidth(1);
  });
  updateBtn(); tblLayer.draw();
}

/* ---------- STRIPE CHECKOUT ---------- */
payBtn.onclick=()=>{
  if(!selectedIds.length){ alert("Please select a table first."); return; }
  customerModal.style.display='flex';
};

customerForm.onsubmit=async(e)=>{
  e.preventDefault();
  const name=document.getElementById('customer-name').value.trim();
  const email=document.getElementById('customer-email').value.trim();
  const party=parseInt(document.getElementById('party-size').value);
  if(!name||!email||!party){ alert('Please complete all fields.'); return; }
  customerModal.style.display='none';
  const date=getSupabaseDate(), time=document.getElementById('booking-time').value, total=totalPence();
  const successUrl = window.location.origin + window.location.pathname.replace('pick-seat.html','success.html') + window.location.search;
  try{
    payBtn.textContent="Processing..."; payBtn.disabled=true;
    const res=await fetch(STRIPE_CHECKOUT_API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        table_ids:selectedIds, booking_date:date, booking_time:time,
        customer_email:email, customer_name:name, party_size:party,
        total_pence:total, tenant_id:urlParams.tenant_id,
        booking_ref:urlParams.booking_ref, successUrl:successUrl,
        cancelUrl:window.location.href,
      })
    });
    const data=await res.json();
    if(res.ok && data.url){ window.location.href=data.url; }
    else { alert('Checkout failed: ' + (data.error || 'Unknown error.')); console.error(data); }
  }catch(err){ console.error(err); alert('Network error: Could not reach payment service.'); }
  finally { updateBtn(); payBtn.disabled=false; }
};

/* ---------- INIT ---------- */
multiSelectToggle.onclick=()=>{
  isMulti=!isMulti;
  multiSelectToggle.classList.toggle('active',isMulti);
  multiSelectToggle.textContent=isMulti?'Exit Group Selection (Tap Mode)':'Start Group Selection (Tap Mode)';
  selectedIds=[]; updateVisual();
};

document.getElementById('check-availability').onclick=loadBookings;
window.onclick=(e)=>{ if(e.target===customerModal) customerModal.style.display='none'; };

getUrlParams(); logInitialClick(); setDefaultDateTime();
loadFloorplan(loadTables);
</script>
