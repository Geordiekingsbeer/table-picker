// --- In your customer-facing HTML file: Replace the entire payBtn.onclick function ---

payBtn.onclick = async () => {
    if (selectedTableIds.length === 0) return;
    
    const selectedDate = document.getElementById('booking-date').value;
    const selectedTime = document.getElementById('booking-time').value;

    if (!selectedDate || !selectedTime) {
        alert('Please select a valid date and time before proceeding.');
        return;
    }

    // Refresh availability one last time
    await loadBookings();
    
    // Final check for conflicts
    const isAnySelectedTableBooked = selectedTableIds.some(id => {
        const group = layer.findOne('#g-' + id);
        return group.findOne('.main-table').fill() === BOOKED_COLOR;
    });

    if (isAnySelectedTableBooked) {
        alert("Error: One or more selected tables were just booked. Please re-check availability and select again.");
        updateTableVisuals();
        return;
    }

    const email = prompt('Enter your email for confirmation:');
    if (!email) return alert('Email is required');
    
    // --- CRITICAL PRICE CALCULATION AND LOGGING ---
    const totalPence = calculateTotalPence(); 
    console.log('Final Calculated Pence Sent:', totalPence); 
    // ---------------------------------------------
    
    if (totalPence === 0) {
        alert("Error: Selected tables have no defined price (Total is 0).");
        return;
    }

    try {
        const res = await fetch('https://stripe-serverless-phi.vercel.app/api/create-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                table_ids: selectedTableIds, 
                email: email,
                booking_date: selectedDate,
                booking_time: selectedTime,
                total_pence: totalPence // Sending the calculated total
            })
        });
        
        const data = await res.json();
        if (data.url) {
            window.location.href = data.url;    
        } else {
            console.error(data);
            alert('Checkout creation failed. See console for details.');
        }
    } catch (err) {
        console.error(err);
        alert('Checkout creation failed. See console for details.');
    }
};
