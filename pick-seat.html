<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/konva@9/konva.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  /* ---------- CONFIG ---------- */
  const STAGE_WIDTH = 480;
  const STAGE_HEIGHT = 480;

  const TABLE_COLOR = "#b7d7a8";
  const STAFF_COLOR = "#ffffff";
  const BOOKED_COLOR = "#e0e0e0";
  const SEAT_COLOR = "#555";
  const HIGHLIGHT = "#ffeb3b";
  const STAFF_IDS = [10, 13, 12, 14, 1];

  const PRICE_2 = 499, PRICE_4 = 999, PRICE_6 = 1499;

  // Supabase
  const supabaseUrl = "https://Rrjvdabtqzkaomjuiref.supabase.co";
  const supabaseAnon =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg";
  const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

  // Stripe checkout API
  const STRIPE_CHECKOUT_API_URL = "https://stripe-serverless-phi.vercel.app/api/create-checkout";

  /* ---------- STATE ---------- */
  const stage = new Konva.Stage({ container: "container", width: STAGE_WIDTH, height: STAGE_HEIGHT });
  const bgLayer = new Konva.Layer();
  const tblLayer = new Konva.Layer();
  stage.add(bgLayer);
  stage.add(tblLayer);

  const tableMap = new Map();
  let selectedIds = [], bookings = [], isMulti = false;
  let urlParams = {};

  /* ---------- UTILS ---------- */
  function getSupabaseDate() { return document.getElementById('booking-date').value; }
  function timeToMin(t) { const [h, m] = t.split(':').map(Number); return h*60 + m; }

  function getPrice(w,h){
    if(w===30 && h===30) return PRICE_2;
    if((w===30 && h===50)||(w===50 && h===30)) return PRICE_4;
    if(w===90 && h===30) return PRICE_6;
    return 0;
  }

  function totalPence(){ return selectedIds.reduce((t,id)=>t+(tableMap.get(id)?.price||0),0); }
  function updateBtn(){
    const btn = document.getElementById('payBtn');
    const p = totalPence();
    btn.disabled = !p;
    btn.textContent = p ? `Pay £${(p/100).toFixed(2)} – Stripe` : 'Pay for 0 Tables – Stripe';
  }

  function setDefaultDateTime(){
    const today=new Date();
    document.getElementById('booking-date').value = today.toISOString().split('T')[0];
    document.getElementById('booking-time').value = '19:00';
  }

  function getUrlParams(){
    const u = new URLSearchParams(location.search);
    urlParams.tenant_id = u.get('tenant_id') || 'R-DEMO';
    urlParams.booking_ref = u.get('booking_ref');
    urlParams.source = u.get('source');
  }

  /* ---------- FLOORPLAN ---------- */
  function loadFloorplan(cb){
    const img = new Image();
    img.onload = ()=>{
      bgLayer.add(new Konva.Image({image: img, x:0, y:0}));
      bgLayer.draw();
      if(cb) cb();
    };
    img.src = 'floorplan.png';
  }

  /* ---------- TABLES & SEATS ---------- */
  function drawSeats(group, t) {
    const s = 12, half = s / 2;
    const makeSeat = (x, y, w, h) => { group.add(new Konva.Rect({width:w,height:h,fill:SEAT_COLOR,x,y})); };

    if (t.w===30 && t.h===30) { makeSeat(t.w/2-half,-half,s,half); makeSeat(t.w/2-half,t.h,s,half); }
    else if (t.w===30 && t.h===50){
      const v=(t.h-2*s)/3;
      makeSeat(-half,v,half,s); makeSeat(-half,v*2+s,half,s);
      makeSeat(t.w,v,half,s); makeSeat(t.w,v*2+s,half,s);
    }
    else if(t.w===50 && t.h===30){
      const h=(t.w-2*s)/3;
      makeSeat(h,-half,s,half); makeSeat(h*2+s,-half,s,half);
      makeSeat(h,t.h,s,half); makeSeat(h*2+s,t.h,s,half);
    }
    else if(t.w===90 && t.h===30){
      const h = t.w/4;
      for(let i=0;i<3;i++){ const x=h*(i+1)-s/2; makeSeat(x,-half,s,half); makeSeat(x,t.h,s,half); }
    }
  }

  function drawTable(t){
    const g = new Konva.Group({id:'g-'+t.id,x:t.x,y:t.y});
    const isStaff = STAFF_IDS.includes(t.id);
    const r = new Konva.Rect({width:t.w,height:t.h,fill:isStaff?STAFF_COLOR:TABLE_COLOR,stroke:'#000',strokeWidth:1});
    g.add(r);
    drawSeats(g,t);
    g.offset({x:t.w/2,y:t.h/2});
    g.x(t.x+t.w/2); g.y(t.y+t.h/2);
    g.rotation(t.rotation||0);
    g.on('click tap',()=>selectTable(t.id));
    tblLayer.add(g);
    tableMap.set(t.id,{id:t.id,rect:r,group:g,price:getPrice(t.w,t.h)});
  }

  /* ---------- TABLE SELECTION ---------- */
  function selectTable(id){
    const t = tableMap.get(id);
    if(!t || t.rect.fill()===STAFF_COLOR || t.rect.fill()===BOOKED_COLOR){ alert('Table not available online.'); return; }
    const idx = selectedIds.indexOf(id);
    if(idx===-1){
      if(!isMulti){ selectedIds.forEach(i=>{const tt=tableMap.get(i);tt.rect.stroke('#000'); tt.rect.strokeWidth=1;}); selectedIds=[]; }
      selectedIds.push(id); t.rect.stroke(HIGHLIGHT); t.rect.strokeWidth=3;
    } else {
      selectedIds.splice(idx,1); t.rect.stroke('#000'); t.rect.strokeWidth=1;
    }
    updateBtn(); tblLayer.draw();
  }

  /* ---------- LOAD TABLES & BOOKINGS ---------- */
  async function loadTables(){
    tblLayer.destroyChildren();
    tableMap.clear();

    try{
      const { data: tables } = await _supa.from('tables').select('*').order('id');
      tables.forEach(t=>drawTable(t));
      await loadBookings();
    } catch(e){ console.error(e); }
    tblLayer.draw();
  }

  async function loadBookings(){
    const date=document.getElementById('booking-date').value;
    const time=document.getElementById('booking-time').value;
    if(!date||!time){ bookings=[]; return; }
    try{
      const { data } = await _supa.from('premium_slots').select('*').eq('date',date);
      const m=timeToMin(time);
      bookings = data.filter(b=> m>=timeToMin(b.start_time) && m<timeToMin(b.end_time));
    } catch(e){ console.error(e); bookings=[]; }
    updateVisual();
  }

  function updateVisual(){
    tableMap.forEach(t=>{
      t.rect.stroke('#000'); t.rect.strokeWidth=1;
      if(STAFF_IDS.includes(t.id)) t.rect.fill(STAFF_COLOR);
      else t.rect.fill(bookings.some(b=>Number(b.table_id)===t.id)?BOOKED_COLOR:TABLE_COLOR);
    });

    const sel=[...selectedIds]; selectedIds=[];
    sel.forEach(id=>{
      const t=tableMap.get(id);
      if(t.rect.fill()===TABLE_COLOR){ selectedIds.push(id); t.rect.stroke(HIGHLIGHT); t.rect.strokeWidth=3; }
    });
    updateBtn(); tblLayer.draw();
  }

  /* ---------- STRIPE CHECKOUT ---------- */
  document.getElementById('payBtn').onclick=()=>{
    if(!selectedIds.length){ alert("Select a table first."); return; }
    document.getElementById('customer-modal').style.display='flex';
  };

  document.getElementById('customer-form').onsubmit=async(e)=>{
    e.preventDefault();
    const name=document.getElementById('customer-name').value.trim();
    const email=document.getElementById('customer-email').value.trim();
    const party=parseInt(document.getElementById('party-size').value);
    if(!name||!email||!party){ alert('Complete all fields.'); return; }
    document.getElementById('customer-modal').style.display='none';

    const date=document.getElementById('booking-date').value;
    const time=document.getElementById('booking-time').value;
    const total=totalPence();

    const successUrl = window.location.origin + window.location.pathname.replace('pick-seat.html','success.html') + window.location.search;

    try{
      const res = await fetch(STRIPE_CHECKOUT_API_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          table_ids:selectedIds,
          booking_date:date,
          booking_time:time,
          customer_email:email,
          customer_name:name,
          party_size:party,
          total_pence:total,
          tenant_id:urlParams.tenant_id,
          booking_ref:urlParams.booking_ref,
          successUrl:successUrl,
          cancelUrl:window.location.href
        })
      });
      const data=await res.json();
      if(res.ok && data.url) window.location.href=data.url;
      else alert('Checkout failed: ' + (data.error||'Unknown error'));
    } catch(err){ console.error(err); alert('Network error'); }
  };

  /* ---------- MULTI-SELECT TOGGLE ---------- */
  document.getElementById('multi-select-toggle').onclick=()=>{
    isMulti=!isMulti;
    const btn=document.getElementById('multi-select-toggle');
    btn.classList.toggle('active',isMulti);
    btn.textContent = isMulti?'Exit Group Selection':'Start Group Selection';
    selectedIds=[]; updateVisual();
  };

  document.getElementById('check-availability').onclick=loadBookings;
  window.onclick = (event) => { if(event.target===document.getElementById('customer-modal')) document.getElementById('customer-modal').style.display='none'; };

  /* ---------- INIT ---------- */
  getUrlParams();
  setDefaultDateTime();
  loadFloorplan(loadTables);
});
</script>
