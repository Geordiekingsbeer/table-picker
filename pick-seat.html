<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>Reserve Your Table</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<style>
		/* NEW: Gray Background */
		body{
			font-family: Arial, Helvetica, sans-serif;
			text-align: center;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: flex-start;
			padding: 20px 10px;
			background: #e3e3e3; /* Gray background from image */
			min-height: 100vh;
		}
		
		/* NEW: Header Styling */
		h1 {
			font-size: 32px;
			font-weight: 700;
			color: #333;
			margin-bottom: 5px;
		}

		.subtitle {
			font-size: 18px;
			color: #666;
			margin-bottom: 30px;
		}

		.instructions {
			display: none; /* Hide original instructions */
		}

		/* Date/Time Selector - MATCHES VISUAL STYLE */
		#datetime-controls {
			display: flex;
			gap: 10px;
			margin-bottom: 15px;
			align-items: center;
			padding: 0;
			background: none;
			box-shadow: none;
			flex-wrap: nowrap;
			max-width: 480px;
			width: 100%;
		}

		#datetime-controls label {
			display: none; /* Hide labels */
		}
		
		/* New Select/Input Styling */
		#datetime-controls input {
			flex-grow: 1;
			padding: 12px 10px;
			border: 1px solid #ccc;
			border-radius: 4px;
			background-color: white;	
			font-size: 16px;
			color: #333;
			max-width: none;
			font-weight: 500;
			text-align: center;
			
			/* Add space for pseudo-icons */
			padding-left: 10px;	
			/* Reset specific type styling that might conflict */
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
			/* NEW: Force font without slashed zero */
			font-family: Arial, sans-serif; 
		}
		
		/* Custom appearance based on placeholder/external styling in screenshot */
		#booking-date {
			 text-align: left;
			 padding-right: 5px;
		}

		#booking-time {
			 text-align: left;
			 padding-right: 5px;
		}


		/* UPDATED: Check Availability Button matches table color & text is bold */
		#check-availability {
			padding: 12px 10px;
			background-color: #b7d7a8; /* Table Color */
			color: #333; /* Darker text for visibility */
			border: none;
			border-radius: 4px;
			cursor: pointer;
			/* UPDATED: Make text bold */
			font-weight: 600; 
			flex-grow: 1;
			box-shadow: none;
			white-space: nowrap;
		}
		
		#check-availability:hover {
			background-color: #a7c598; /* Slightly darker hover for table color */
		}
		
		/* Multi-Select Toggle Button */
		#multi-select-toggle {
			padding: 10px 15px;
			font-size: 16px;
			font-weight: 500;
			margin-bottom: 20px;
			border-radius: 4px;
			cursor: pointer;
			border: 1px solid #ccc; /* Lighter border to match screenshot */
			background-color: #f7f7f7;	
			color: #333;
			transition: all 0.2s ease;
			white-space: nowrap;
			width: 90vw;
			max-width: 480px;
			box-shadow: 0 1px 3px rgba(0,0,0,0.05);
		}
		
		#multi-select-toggle.active {
			background-color: #1976d2;
			color: white;
			border: 1px solid #1976d2;
		}

		/* Floorplan container */
		#container-wrapper {
			display: flex;
			justify-content: center;
			width: 100%;
			max-width: 480px;	
		}

		#container{
			width: 100%;
			height: auto;
			border: none;	
			box-shadow: none;
			background-color: transparent;
		}

		/* Status Legend */
		.status-legend {
			margin-top: 10px;
			font-size: 14px;
			color: #555;
			display: flex;
			gap: 15px;
			flex-wrap: wrap;
			justify-content: center;
			max-width: 480px;
			width: 100%;
		}
		.legend-item {
			display: flex;
			align-items: center;
		}
		.legend-color {
			width: 15px;
			height: 15px;
			border-radius: 3px;
			margin-right: 5px;
			border: 1px solid #000; 
		}

		#payBtn{
			margin-top:20px;
			padding:12px 24px;
			font-size:16px;
			background:#388e3c;
			color:#fff;
			border:none;
			/* UPDATED: More rounded corners (Pill shape) */
			border-radius: 20px; 
			cursor:pointer;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
			width: 90vw;
			max-width: 480px;
		}
		#payBtn:disabled{
			background:#bbb;
			cursor: not-allowed;
			box-shadow: none;
		}

		/* MODAL STYLES */
		.modal {
			display: none;	
			position: fixed;	
			z-index: 1001;	
			left: 0;
			top: 0;
			width: 100%;	
			height: 100%;	
			overflow: auto;	
			background-color: rgba(0,0,0,0.4);	
			justify-content: center;
			align-items: center;
		}

		.modal-content {
			background-color: #fefefe;
			padding: 30px;
			border: 1px solid #888;
			width: 90%;	
			max-width: 400px;
			border-radius: 10px;
			box-shadow: 0 5px 15px rgba(0,0,0,0.3);
			margin: 10vh auto;
		}
		
		.modal-content h3 { margin-top: 0; }
		.modal-content input[type="text"], 
		.modal-content input[type="number"], 
		.modal-content input[type="email"] {
			width: 100%;
			padding: 10px;
			margin-bottom: 15px;
			border: 1px solid #ccc;
			border-radius: 5px;
			box-sizing: border-box;
		}
		/* Small input adjustment for the checkbox */
		.modal-content input[type="checkbox"] {
		    width: auto;
		    margin-bottom: 0;
		}

		#confirm-booking-btn {
			background-color: #388e3c;
			color: white;
			padding: 10px 20px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			width: 100%;
		}
	</style>
</head>
<body>
	<h1 class="header-title" style="font-size: 24px;">Reserve Your Table</h1>
	<p class="subtitle" style="font-size: 16px;">Select your preferred seating</p>
	
	<div id="datetime-controls">
		<input type="date" id="booking-date" value="" placeholder="dd/mm/yyyy" style="text-align: left;">
		<input type="time" id="booking-time" value="" placeholder="--:--" style="text-align: left;">
		<button id="check-availability">Check Availability</button>
	</div>

	<button id="multi-select-toggle" data-active="false">Start Group Selection (Tap Mode)</button>

	<div id="container-wrapper">	
		<div id="container"></div>
	</div>

	<div class="status-legend">
		<div class="legend-item"><span class="legend-color" style="background-color: #b7d7a8;"></span>Premium Available</div>
		<div class="legend-item"><span class="legend-color" style="background-color: #e0e0e0;"></span>Booked (Premium)</div>
		<div class="legend-item"><span class="legend-color" style="background-color: #ffffff;"></span>Staff Use Only (N/A)</div>	
	</div>
	
	<button id="payBtn" disabled>Pay for 0 Tables – Stripe</button>

	<div id="customer-modal" class="modal">
		<div class="modal-content">
			<h3>Confirm Reservation Details</h3>
			<form id="customer-form">
				<input type="text" id="customer-name" placeholder="Full Name" required>
				<input type="number" id="party-size" placeholder="Party Size (e.g., 4)" min="1" required>
				<input type="email" id="customer-email" placeholder="Email for Receipt" required>
				
				<!-- NEW: Opt-In Box and Compliance Note -->
				<div style="margin-top: 10px; margin-bottom: 20px; text-align: left;">
				    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer;">
				        <input type="checkbox" id="opt-in-promos" style="width: auto; margin: 0; transform: scale(1.2);">
				        <span>Send me restaurant discounts and updates in my area</span>
				    </label>
				    <p style="font-size: 11px; color: #888; margin-top: 5px;">
				        We'll use this information to send you local offers. You can unsubscribe anytime.
				    </p>
				</div>
				<!-- END NEW HTML -->
				
				<button type="submit" id="confirm-booking-btn">Proceed to Payment</button>
			</form>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="https://unpkg.com/konva@9/konva.min.js"></script>
	<script>
	// --- START OF JAVASCRIPT ---

	// --- Konva Stage Dimensions (The fixed, internal dimensions of your floorplan) ---
	const STAGE_WIDTH = 480;	
	const STAGE_HEIGHT = 480;	
	// ---------------------------------------------------------------------------------

	// Supabase setup
	const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
	const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
	const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

	const container = document.getElementById('container');

	// --- TWO-LAYER SETUP (Matching Admin File) ---
	const stage = new Konva.Stage({ container: 'container', width: STAGE_WIDTH, height: STAGE_HEIGHT });
	const backgroundLayer = new Konva.Layer(); // For the floorplan image
	stage.add(backgroundLayer);
	const layer = new Konva.Layer(); // For the tables
	stage.add(layer);
	// ---------------------------------------------
	
	const payBtn = document.getElementById('payBtn');
	const customerModal = document.getElementById('customer-modal');
	const customerForm = document.getElementById('customer-form');
	const multiSelectToggle = document.getElementById('multi-select-toggle');	

	let selectedTableIds = [];	
	let currentBookings = [];	
	let tableDataMap = new Map();	
	let isMultiSelectMode = false;	

    // NEW: Global parameters object for tracking data
    let URL_PARAMS = {
        tenant_id: null,
        booking_ref: null,
        source: null,
    };

	// --- Price Constants in Cents/Pence ---
	// Your Requested Prices: £4.99, £9.99, £14.99
	const PRICE_2_SEATER = 499;	// £4.99
	const PRICE_4_SEATER = 999;	// £9.99 
	const PRICE_6_SEATER = 1499; // £14.99 
	// --------------------------------------

	const TABLE_COLOR = '#b7d7a8';		
	const BOOKED_COLOR = '#e0e0e0';		
	const UNAVAILABLE_COLOR = '#ffffff';
	const SEAT_COLOR = '#555';	
	const HIGHLIGHT_COLOR = '#cfe2f3'; // Using the old value to ensure the color is visible
	
	// Table 17 is available for booking
	const STAFF_USE_TABLE_IDS = [10, 13, 12, 14, 1];
	
	// --- Helper Functions ---
    
    // NEW: Function to read the URL parameters
    function getUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        
        URL_PARAMS.tenant_id = urlParams.get('tenant_id');
        URL_PARAMS.booking_ref = urlParams.get('booking_ref');
        URL_PARAMS.source = urlParams.get('source');

        // Use a default for local testing if tenant_id is missing
        if (!URL_PARAMS.tenant_id) {
             URL_PARAMS.tenant_id = 'R-DEMO'; 
        }
    }
    
	// NEW: Function to log the initial click event (Using UPSERT)
	async function logInitialClick() {
		// Only log if we have a valid booking reference
		if (!URL_PARAMS.booking_ref) {
			return;
		}
		
        // 1. Check if the row already exists
        const { data: existingData, error: selectError } = await _supa
            .from('engagement_tracking')
            .select('view_link_count')
            .eq('booking_ref', URL_PARAMS.booking_ref)
            .maybeSingle();

        let newCount = 1;
        if (existingData) {
            // Row exists, increment the count
            newCount = existingData.view_link_count + 1;
        }

        // 2. Perform UPSERT (or update the count)
		const { error: upsertError } = await _supa
			.from('engagement_tracking')
			.upsert([
                {
                    tenant_id: URL_PARAMS.tenant_id,
                    booking_ref: URL_PARAMS.booking_ref,
                    // If inserting new, set view_link_count to 1
                    view_link_count: 1, 
                }
            ], { onConflict: 'booking_ref' })
            .update({ view_link_count: newCount }, { onConflict: 'booking_ref' }); // Update existing row's count

		if (upsertError) {
			console.error('Error logging initial link click:', upsertError);
		} else {
			console.log(`Tracking: Logged/Updated link_click for booking ${URL_PARAMS.booking_ref}. New Count: ${newCount}`);
		}
	}
	// ---------------------------------------------------


	function timeToMinutes(timeStr) {
		const parts = timeStr.split(':').map(Number);
		const hours = parts[0] || 0;
		const minutes = parts[1] || 0;
		return (hours * 60) + minutes;
	}

	function getSupabaseDate() {
		return document.getElementById('booking-date').value;	
	}
	
	function getTablePrice(w, h) {
		if (w === 30 && h === 30) return PRICE_2_SEATER;
		if ((w === 30 && h === 50) || (w === 50 && h === 30)) return PRICE_4_SEATER;
		if (w === 90 && h === 30) return PRICE_6_SEATER;
		return 0;
	}

	function calculateTotalPence() {
		let totalPence = 0;
		selectedTableIds.forEach(id => {
			const data = tableDataMap.get(id);
			if (data) {
				totalPence += data.price;
			}
		});
		return totalPence;
	}

	function updatePayButton(totalPence) {
		const totalDollars = (totalPence / 100).toFixed(2);
		if (totalPence > 0) {
			payBtn.disabled = false;
			payBtn.textContent = `Pay £${totalDollars} – Stripe`;
		} else {
			payBtn.disabled = true;
			payBtn.textContent = `Pay for 0 Tables – Stripe`;
		}
	}

	function setDefaultDateTime() {
		// --- THIS SECTION WAS CRASHING ---
		const today = new Date();
		const year = today.getFullYear();
		const month = String(today.getMonth() + 1).padStart(2, '0');
		const day = String(today.getDate()).padStart(2, '0');
		
		const defaultDate = `${year}-${month}-${day}`;
		const defaultTime = '19:00';	

		// CRITICAL FIX: The JS must find the elements by ID to set their initial values
		const dateInput = document.getElementById('booking-date');
		const timeInput = document.getElementById('booking-time');

		if (dateInput) dateInput.value = defaultDate;
		if (timeInput) timeInput.value = defaultTime;
		// ------------------------------------
	}
	
	// --- KONVA RESIZE FUNCTION (Proven Admin Logic) ---
	function resizeStage() {
		const containerWidth = container.offsetWidth;
		const scale = containerWidth / STAGE_WIDTH;

		stage.width(containerWidth);
		stage.height(STAGE_HEIGHT * scale);
		stage.scale({ x: scale, y: scale });

		container.style.height = `${STAGE_HEIGHT * scale}px`;

		stage.draw();
	}
	// -------------------------------------------------------------

	// --- Background/Floorplan Loading (Admin Style) ---
	
	function loadFloorplan(callback) {
		const imageObj = new Image();
		imageObj.onload = function() {
			const floorplan = new Konva.Image({
				x: 0, y: 0, image: imageObj, width: STAGE_WIDTH, height: STAGE_HEIGHT,
			});
			backgroundLayer.add(floorplan);
			
			backgroundLayer.draw();
			
			resizeStage();	
			
			if (callback) callback();
		};
		// Add cache buster to force new image load
		imageObj.src = 'floorplan.png?v=' + new Date().getTime();	
	}

	// --- Booking Logic ---

	async function loadBookings() {
        // If tenant ID is missing (only for a broken live link), stop loading bookings.
        if (!URL_PARAMS.tenant_id) return false; 

		const selectedDateSupabase = document.getElementById('booking-date').value;
		const selectedTime = document.getElementById('booking-time').value;

		if (!selectedDateSupabase || !selectedTime) {
			currentBookings = [];	
			updateTableVisuals();
			return false;
		}

		const { data, error } = await _supa
			.from('premium_slots')	
			.select('*')
			.eq('date', selectedDateSupabase); 
            // NOTE: The tenant_id filter is removed to avoid database schema conflicts.
			
		if(error){	
			console.error('Error fetching bookings:', error);	
			alert('Could not check availability. Try again later.');	
			currentBookings = [];	
			return false;
		}	

		const selectedTimeMinutes = timeToMinutes(selectedTime);	

		currentBookings = data.filter(b => {
			const bookingStartMinutes = timeToMinutes(b.start_time);
			const bookingEndMinutes = timeToMinutes(b.end_time);
			
			return selectedTimeMinutes >= bookingStartMinutes && selectedTimeMinutes < bookingEndMinutes;
		});

		updateTableVisuals();
		return true;
	}


	function updateTableVisuals() {
		const currentSelection = [...selectedTableIds];	
		selectedTableIds = [];	
		
		stage.find('.main-table').forEach(tableRect => {
			const group = tableRect.getParent();
			const tableId = Number(group.id().substring(2));	
			
			if (STAFF_USE_TABLE_IDS.includes(tableId)) {
				tableRect.fill(UNAVAILABLE_COLOR);
			} else {
				const isBooked = currentBookings.some(b => Number(b.table_id) === tableId);
				tableRect.fill(isBooked ? BOOKED_COLOR : TABLE_COLOR);
			}
			
			// Reset stroke
			tableRect.stroke('#000');	
			tableRect.strokeWidth(1);
		});
		
		// Re-apply selection highlights for available tables
		currentSelection.forEach(id => {
			const group = layer.findOne('#g-' + id);
			if (!group) return;	
			const tableRect = group.findOne('.main-table');

			// Re-select only if available
			if (tableRect.fill() === TABLE_COLOR) {
				selectedTableIds.push(id);
				tableRect.stroke(HIGHLIGHT_COLOR);
				tableRect.strokeWidth(3);
			}
		});

		const totalPence = calculateTotalPence();
		updatePayButton(totalPence);

		layer.draw();
	}

	// --- Konva Table Drawing ---
	
	async function loadTables() {
        if (!URL_PARAMS.tenant_id) {
             console.error("Critical Error: Missing tenant_id. Stopping map load.");
             return;
        }

		// --- DEFINITIVE LIST OF 21 TABLES WITH CORRECT SIZES (MUST MATCH ADMIN) ---
		const baseTables = [
			// Original Tables 1-17
			{ id: 1, x: 235, y: 110, w: 90, h: 30, rotation: 0 },
			{ id: 2, x: 100, y: 30, w: 90, h: 30, rotation: 0 },
			{ id: 3, x: 100, y: 150, w: 30, h: 30, rotation: 0 },
			{ id: 4, x: 140, y: 220, w: 30, h: 30, rotation: 0 },
			{ id: 5, x: 180, y: 300, w: 50, h: 30, rotation: 90 }, // 4-seater
			{ id: 6, x: 250, y: 330, w: 30, h: 30, rotation: 0 },
			{ id: 7, x: 30, y: 300, w: 50, h: 30, rotation: 90 }, // 4-seater
			{ id: 8, x: 400, y: 100, w: 30, h: 30, rotation: 0 },
			{ id: 9, x: 20, y: 180, w: 30, h: 50, rotation: 0 }, // 4-seater
			{ id: 10, x: 300, y: 240, w: 30, h: 30, rotation: 0 },
			{ id: 11, x: 40, y: 80, w: 30, h: 30, rotation: 0 },
			{ id: 12, x: 350, y: 350, w: 50, h: 30, rotation: 0 }, // 4-seater
			{ id: 13, x: 400, y: 280, w: 30, h: 30, rotation: 0 },
			{ id: 14, x: 250, y: 180, w: 30, h: 30, rotation: 0 },
			
			// --- NEW TABLES REQUESTED (IDs 18-21) ---
			{ id: 18, x: 140, y: 280, w: 30, h: 30, rotation: 0 }, // New 2-seater
			{ id: 19, x: 220, y: 280, w: 30, h: 30, rotation: 0 }, // New 2-seater
			{ id: 20, x: 300, y: 280, w: 30, h: 30, rotation: 0 }, // New 2-seater
			{ id: 21, x: 300, y: 180, w: 50, h: 30, rotation: 90 }, // New 4-seater (50x30, rotated)
		];
		
		// --- FETCH POSITIONS FROM DB ---
        // NOTE: No filter here. Fetches ALL layouts to respect RLS open policy.
		let { data: dbData, error } = await _supa.from('tables').select('id, x, y, rotation').order('id');

		if (error) {
			console.warn("Could not fetch table positions from Supabase. Using default initial positions.");
			tables = baseTables;
		} else {
			const positionMap = new Map(dbData.map(t => [t.id, t]));
			
			// Merge database positions with the full set of table definitions
			tables = baseTables.map(t => {
				const dbPos = positionMap.get(t.id);
				if (dbPos) {
					return {	
						id: t.id,	
						x: dbPos.x,	
						y: dbPos.y,	
						w: t.w,	
						h: t.h,	
						rotation: dbPos.rotation	
					};
				}
				return t;	
			});
			
			tables = tables.filter((t, index, self) =>	
				index === self.findIndex((tt) => (tt.id === t.id))
			).sort((a, b) => a.id - b.id);
		}
		
		layer.destroyChildren();	
		tableDataMap = new Map(); // Re-initialize map with full data
		
		tables.forEach(t => {
			const price = getTablePrice(t.w, t.h);
			tableDataMap.set(t.id, { id: t.id, price: price, w: t.w, h: t.h }); // Store full table data

			const group = drawTable(t);
			const tableRect = group.findOne('.main-table');
			
			group.offset({ x: tableRect.width()/2, y: tableRect.height()/2 });
			group.x(t.x + tableRect.width()/2);
			group.y(t.y + tableRect.height()/2);
			group.rotation(t.rotation || 0);	

			if (STAFF_USE_TABLE_IDS.includes(t.id)) {
				tableRect.fill(UNAVAILABLE_COLOR);
			}
		});
		
		layer.draw();	
		await loadBookings();
	}
	
	function drawTable(t) {
		const group = new Konva.Group({	
			x: t.x,	
			y: t.y,	
			id: 'g-' + t.id,
			name: 'selectable-table'	
		});
		layer.add(group);

		const tableRect = new Konva.Rect({	
			width: t.w,	
			height: t.h,	
			fill: TABLE_COLOR,	
			stroke: '#000',	
			strokeWidth: 1,
			name: 'main-table'	
		});
		group.add(tableRect);

		group.on('click tap', (e) => selectTable(t.id, e.evt));

		// Seat drawing logic (crucial for correct display)
		const baseSeatSize = 12;	
		const seatHalf = baseSeatSize / 2;	

		function makeSeat(x, y, w, h) {
			group.add(new Konva.Rect({ width:w, height:h, fill:SEAT_COLOR, x:x, y:y }));
		}
		
		if (t.w === 30 && t.h === 30) {
			const seatW = baseSeatSize;	
			const seatH = seatHalf;	 	
			makeSeat(t.w/2 - seatW/2, -seatH, seatW, seatH);	 	 	
			makeSeat(t.w/2 - seatW/2, t.h, seatW, seatH);	 	 	 	
		} else if (t.w === 30 && t.h === 50) {
			const seatW = seatHalf;	 	
			const seatH = baseSeatSize;	
			const v_spacing = (t.h - 2 * seatH) / 3;	
			makeSeat(-seatW, v_spacing, seatW, seatH);	 	       	
			makeSeat(-seatW, v_spacing * 2 + seatH, seatW, seatH);	 	
			makeSeat(t.w, v_spacing, seatW, seatH);	 	         	
			makeSeat(t.w, v_spacing * 2 + seatH, seatW, seatH);	 	 	
		} else if (t.w === 50 && t.h === 30) {	
			const seatW = baseSeatSize;	
			const seatH = seatHalf;	
			const h_spacing = (t.w - 2 * seatW) / 3;
			makeSeat(h_spacing, -seatH, seatW, seatH);
			makeSeat(h_spacing * 2 + seatW, -seatH, seatW, seatH);
			makeSeat(h_spacing, t.h, seatW, seatH);
			makeSeat(h_spacing * 2 + seatW, t.h, seatW, seatH);
		} else if (t.w === 90 && t.h === 30) {
			const seatW = baseSeatSize;	
			const seatH = seatHalf;	 	
			const h_spacing = t.w / 4;	
			for(let i=0; i<3; i++){
				const x_pos = h_spacing * (i+1) - seatW/2;
				makeSeat(x_pos, -seatH, seatW, seatH);	           	
				makeSeat(x_pos, t.h, seatW, seatH);	           	 	
			}
		}
		return group;
	}

	function selectTable(id, evt) {
		const group = layer.findOne('#g-' + id);
		const tableRect = group.findOne('.main-table');
		
		if (tableRect.fill() === UNAVAILABLE_COLOR || tableRect.fill() === BOOKED_COLOR) {
			alert('This table is not available for online booking.');
			return;
		}

		const idNumber = Number(id);
		const index = selectedTableIds.indexOf(idNumber);
		
		const isShiftPressed = evt && (evt.shiftKey || evt.ctrlKey || evt.metaKey);
		const isMulti = isShiftPressed || isMultiSelectMode;

		if (index === -1) {
			if (!isMulti) {
				stage.find('.main-table').forEach(rect => {
					if (rect.fill() === TABLE_COLOR) {
						rect.stroke('#000');
						rect.strokeWidth(1);
					}
				});
				selectedTableIds = [];
			}
			
			selectedTableIds.push(idNumber);
			tableRect.stroke(HIGHLIGHT_COLOR);
			tableRect.strokeWidth(3);

		} else {
			if (isMulti || selectedTableIds.length === 1) {
				selectedTableIds.splice(index, 1);
				tableRect.stroke('#000');
				tableRect.strokeWidth(1);
			}
		}
		
		const totalPence = calculateTotalPence();
		updatePayButton(totalPence);

		layer.draw();
	}

	// --- Event Listeners ---
	
	window.addEventListener('resize', resizeStage);

	document.getElementById('multi-select-toggle').onclick = () => {
		// --- CRITICAL FIX: The event handler must be attached to the button object itself ---
		const toggleButton = document.getElementById('multi-select-toggle');	
		
		isMultiSelectMode = !isMultiSelectMode;
		
		if (isMultiSelectMode) {
			toggleButton.dataset.active = 'true';
			toggleButton.classList.add('active');
			toggleButton.textContent = 'Exit Multi-Select Mode';
			
			if(selectedGroup) {
				selectedGroup.findOne('.main-table').stroke('#000');
				selectedGroup = null;
			}
			
			// NOTE: Admin tables remain draggable by default unless multi-select is active
			layer.find('Group').forEach(group => group.draggable(false));	
		} else {
			toggleButton.dataset.active = 'false';
			toggleButton.classList.remove('active');
			toggleButton.textContent = 'Start Multi-Select Mode';
			
			selectedMultiTables.clear();
			multiBookButton.style.display = 'none';

			layer.find('Group').forEach(group => group.draggable(true));
		}

		updateTableVisuals();
	};


	document.getElementById('check-availability').onclick = async () => {
		// Clear selection highlights on check
		stage.find('.main-table').forEach(rect => {
			rect.stroke('#000');
			rect.strokeWidth(1);
		});
		selectedTableIds = [];
		
		await loadBookings();
	};
	
	// --- Re-attach Check Availability logic to the specific button ---
	const checkAvailabilityButton = document.getElementById('check-availability');
	if (checkAvailabilityButton) {
		checkAvailabilityButton.onclick = async () => {
			// Re-run the load bookings logic
			await loadBookings();	
		};
	}
	// -----------------------------------------------------------------


	payBtn.onclick = async () => {
		if (selectedTableIds.length === 0) return;
		
		const selectedDate = document.getElementById('booking-date').value;
		const selectedTime = document.getElementById('booking-time').value;

		if (!selectedDate || !selectedTime) {
			alert('Please select a valid date and time before proceeding.');
			return;
		}

		await loadBookings();
		
		const isAnySelectedTableBooked = selectedTableIds.some(id => {
			const group = layer.findOne('#g-' + id);
			return group.findOne('.main-table').fill() === BOOKED_COLOR;
		});

		if (isAnySelectedTableBooked) {
			alert("Error: One or more selected tables were just booked. Please re-check availability and select again.");
			updateTableVisuals();
			return;
		}

		// NEW: Log 'checkout_start' when modal opens
		if (URL_PARAMS.booking_ref) {
			const trackingEvent = {
				tenant_id: URL_PARAMS.tenant_id,
				booking_ref: URL_PARAMS.booking_ref,
				checkout_started: true, // Use the new column
			};
            
            // Log the checkout start state by UPSERTING the flag
            const { error } = await _supa
                .from('engagement_tracking')
                .upsert([trackingEvent], { onConflict: 'booking_ref' });
                
			if (error) console.error('Tracking Error (Checkout Start):', error);
		}

		customerModal.style.display = 'flex';
	};
	
	// --- FINAL SUBMIT LOGIC FROM MODAL ---
    // Function to handle the Supabase insert for marketing data (Needs to be defined outside or above this)
    async function saveMarketingOptIn(email, selectedDate) {
        const optedIn = document.getElementById('opt-in-promos').checked;
        
        if (!optedIn) {
            return; // User did not opt in, do nothing
        }

        const tenantLocation = URL_PARAMS.tenant_id;
        
        const { error } = await _supa.from('marketing_optins').insert([{
            email: email,
            tenant_id: URL_PARAMS.tenant_id,
            booking_date: selectedDate,
            location: tenantLocation, 
            is_subscribed: true,
            source: 'table_booking',
            consent_text: 'Send me restaurant discounts and updates in my area'
        }]);

        if (error) {
            console.error("Marketing Opt-In Save Failed:", error);
        } else {
            console.log("Marketing opt-in successfully saved.");
        }
    }
    
	customerForm.addEventListener('submit', async function(e) {
		e.preventDefault();

        // CRITICAL FIX: Re-read URL parameters just before final submit
        getUrlParams(); 

		const customerName = document.getElementById('customer-name').value;
		const partySize = parseInt(document.getElementById('party-size').value);
		const email = document.getElementById('customer-email').value;

		if (!customerName || isNaN(partySize) || partySize <= 0 || !email) {
			alert('Please fill out all fields correctly.');
			return;
		}

		customerModal.style.display = 'none';	

		const selectedDate = document.getElementById('booking-date').value;
		const selectedTime = document.getElementById('booking-time').value;
		
		const totalPence = calculateTotalPence();	
		
		if (totalPence === 0) {
			alert("Error: Selected tables have no defined price (Total is 0).");
			return;
		}
		
		// Non-blocking: Save the marketing opt-in FIRST while Stripe processes
        saveMarketingOptIn(email, selectedDate);


		try {
			// ** NETLIFY FIX: Calling the Netlify function endpoint **
			const res = await fetch('https://dine-select-api.netlify.app/.netlify/functions/checkout-session', { 
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({	
					table_ids: selectedTableIds,	
					email: email,
					booking_date: selectedDate,
					booking_time: selectedTime,
					total_pence: totalPence,
					customer_name: customerName,
					party_size: partySize,
                    // CRITICAL FIX: Passing tracking data to Vercel API
					tenant_id: URL_PARAMS.tenant_id, 
					booking_ref: URL_PARAMS.booking_ref, 
				})
			});
			
			const data = await res.json();
			if (data.url) {
				window.location.href = data.url;	 	
			} else {
				console.error(data);
				alert('Checkout creation failed. See console for details.');
			}
		} catch (err) {
			console.error(err);
			alert('Checkout creation failed. See console for details.');
		}
	});
	// ------------------------------------

	// --- Initialization ---
    getUrlParams(); // NEW: Reads URL params first
	setDefaultDateTime();
	window.addEventListener('resize', resizeStage);
	loadFloorplan(loadTables);
</script>
</body>
</html>
