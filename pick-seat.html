<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pick a Seat</title>

<style>
  body { margin:0; font-family:sans-serif; background:#f9f9f9; }
  #container { width:100%; max-width:480px; height:480px; margin:20px auto; border:1px solid #ccc; background:#fff; }
  #multi-select-toggle, #payBtn { display:inline-block; margin:10px; padding:10px 20px; font-size:16px; border:none; border-radius:6px; cursor:pointer; }
  #multi-select-toggle { background:#eee; }
  #payBtn { background:#0070f3; color:#fff; }
  #payBtn:disabled { background:#ccc; cursor:not-allowed; }
  #customer-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  #customer-form { background:#fff; padding:20px; border-radius:8px; width:90%; max-width:320px; }
  #customer-form input { display:block; margin-bottom:10px; width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; }
  label { display:block; margin-bottom:5px; }
</style>
</head>
<body>

<div id="container"></div>
<button id="multi-select-toggle">Start Group Selection (Tap Mode)</button>
<button id="payBtn" disabled>Pay for 0 Tables – Stripe</button>

<div id="customer-modal">
  <form id="customer-form">
    <label>Name: <input id="customer-name" type="text" required></label>
    <label>Email: <input id="customer-email" type="email" required></label>
    <label>Party Size: <input id="party-size" type="number" min="1" required></label>
    <button type="submit">Proceed to Payment</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/konva@9/konva.min.js"></script>

<script>
window.addEventListener('load', async function() {

  /* ---------- CONFIG ---------- */
  const STAGE_WIDTH = 480;
  const STAGE_HEIGHT = 480;

  const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
  const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
  const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

  const PRICE_2 = 499, PRICE_4 = 999, PRICE_6 = 1499;
  const COLOR_TABLE = '#b7d7a8', COLOR_BOOKED = '#e0e0e0', COLOR_STAFF = '#ffffff', COLOR_HIGHLIGHT = '#ffeb3b';
  const COLOR_SEAT = '#555';
  const STAFF_IDS = [10,13,12,14,1];

  const STRIPE_CHECKOUT_API_URL = 'https://dine-checkout-live.vercel.app/api/create-checkout';

  let selectedIds = [];
  let tableMap = new Map();
  let isMulti = false;

  /* ---------- ELEMENTS ---------- */
  const container = document.getElementById('container');
  const payBtn = document.getElementById('payBtn');
  const multiSelectToggle = document.getElementById('multi-select-toggle');
  const customerModal = document.getElementById('customer-modal');
  const customerForm = document.getElementById('customer-form');

  const stage = new Konva.Stage({ container:'container', width:STAGE_WIDTH, height:STAGE_HEIGHT });
  const bgLayer = new Konva.Layer();
  const tblLayer = new Konva.Layer();
  stage.add(bgLayer);
  stage.add(tblLayer);

  /* ---------- UTILS ---------- */
  const getPrice = (w,h) => (w===30&&h===30)?PRICE_2:(w===30&&h===50||w===50&&h===30)?PRICE_4:(w===90&&h===30)?PRICE_6:0;
  const totalPence = () => selectedIds.reduce((t,id)=>t+(tableMap.get(id)?.price||0),0);
  const updateBtn = () => {
    const p = totalPence();
    payBtn.disabled = !p;
    payBtn.textContent = p ? `Pay £${(p/100).toFixed(2)} – Stripe` : 'Pay for 0 Tables – Stripe';
  };

  const resize = () => {
    const w = container.offsetWidth;
    const scale = w/STAGE_WIDTH;
    stage.width(w);
    stage.height(STAGE_HEIGHT*scale);
    stage.scale({x:scale, y:scale});
    container.style.height = STAGE_HEIGHT*scale+'px';
    stage.draw();
  };
  window.addEventListener('resize', resize);

  /* ---------- FLOORPLAN ---------- */
  const loadFloorplan = (cb) => {
    const img = new Image();
    img.onload = () => {
      bgLayer.add(new Konva.Image({x:0, y:0, image:img, width:STAGE_WIDTH, height:STAGE_HEIGHT}));
      bgLayer.draw();
      resize();
      if (cb) cb();
    };
    img.src = 'floorplan.png?v=' + Date.now();
  };

  /* ---------- DRAWING ---------- */
  const drawSeats = (group, t) => {
    const s = 12, sh = s/2;
    const makeSeat = (x,y,w,h)=>group.add(new Konva.Rect({x,y,width:w,height:h,fill:COLOR_SEAT}));
    if (t.w===30 && t.h===30) { makeSeat(t.w/2-sh,-sh,s,sh); makeSeat(t.w/2-sh,t.h,s,sh); }
    else if (t.w===30 && t.h===50) { const vs=(t.h-2*s)/3; makeSeat(-sh,vs,sh,s); makeSeat(-sh,vs*2+s,sh,s); makeSeat(t.w,vs,sh,s); makeSeat(t.w,vs*2+s,sh,s); }
    else if (t.w===50 && t.h===30) { const hs=(t.w-2*s)/3; makeSeat(hs,-sh,s,sh); makeSeat(hs*2+s,-sh,s,sh); makeSeat(hs,t.h,s,sh); makeSeat(hs*2+s,t.h,s,sh); }
    else if (t.w===90 && t.h===30) { const hs=t.w/4; for(let i=0;i<3;i++){ const x=hs*(i+1)-s/2; makeSeat(x,-sh,s,sh); makeSeat(x,t.h,s,sh); } }
  };

  const drawTable = (t) => {
    const g = new Konva.Group({ id:'g-'+t.id, table_id:t.id });
    tblLayer.add(g);

    const isStaff = STAFF_IDS.includes(t.id);
    const r = new Konva.Rect({ width:t.w, height:t.h, fill:isStaff?COLOR_STAFF:COLOR_TABLE, stroke:'#000', strokeWidth:1 });
    g.add(r);
    drawSeats(g,t);

    g.offset({x:r.width()/2, y:r.height()/2});
    g.x(t.x + r.width()/2);
    g.y(t.y + r.height()/2);
    g.rotation(t.rotation || 0);

    g.on('click tap', () => selectTable(t.id));

    tableMap.set(t.id, { id:t.id, price:getPrice(t.w,t.h), rect:r, group:g });
  };

  const baseTables = [
    { id:1, x:235, y:110, w:90, h:30 },
    { id:2, x:100, y:30, w:90, h:30 },
    { id:3, x:100, y:150, w:30, h:30 },
    { id:4, x:140, y:220, w:30, h:30 },
    { id:5, x:180, y:300, w:50, h:30, rotation:90 },
    { id:6, x:250, y:330, w:30, h:30 },
    { id:7, x:30, y:300, w:50, h:30, rotation:90 },
    { id:8, x:400, y:100, w:30, h:30 },
    { id:9, x:20, y:180, w:30, h:50 },
    { id:10, x:300, y:240, w:30, h:30 },
    { id:11, x:40, y:80, w:30, h:30 },
    { id:12, x:350, y:350, w:50, h:30 },
    { id:13, x:400, y:280, w:30, h:30 },
    { id:14, x:250, y:180, w:30, h:30 },
    { id:18, x:140, y:280, w:30, h:30 },
    { id:19, x:220, y:280, w:30, h:30 },
    { id:20, x:300, y:280, w:30, h:30 },
    { id:21, x:300, y:180, w:50, h:30, rotation:90 }
  ];

  async function loadTables() {
    tblLayer.destroyChildren();
    tableMap.clear();
    let tablesToDraw = baseTables;

    try {
      const { data } = await _supa.from('tables').select('id,x,y,rotation');
      if (data && data.length > 0) {
        const posMap = new Map(data.map(t => [t.id, t]));
        tablesToDraw = baseTables.map(t => {
          const pos = posMap.get(t.id);
          return pos ? { ...t, x:pos.x ?? t.x, y:pos.y ?? t.y, rotation:pos.rotation ?? t.rotation ?? 0 } : t;
        });
      }
    } catch (e) {
      console.warn("Failed to fetch table positions", e);
    }

    tablesToDraw.forEach(drawTable);
    tblLayer.draw();
  }

  /* ---------- SELECT / VISUAL ---------- */
  function selectTable(id) {
    const t = tableMap.get(id);
    if (!t || t.rect.fill() === COLOR_STAFF || t.rect.fill() === COLOR_BOOKED) {
      alert('This table is not available');
      return;
    }
    const idx = selectedIds.indexOf(id);
    if (idx === -1) {
      if (!isMulti) {
        selectedIds.forEach(i => {
          const tr = tableMap.get(i);
          tr.rect.stroke('#000'); tr.rect.strokeWidth(1);
        });
        selectedIds = [];
      }
      selectedIds.push(id);
      t.rect.stroke(COLOR_HIGHLIGHT); t.rect.strokeWidth(3);
    } else {
      selectedIds.splice(idx,1);
      t.rect.stroke('#000'); t.rect.strokeWidth(1);
    }
    updateBtn();
    tblLayer.draw();
  }

  multiSelectToggle.onclick = () => {
    isMulti = !isMulti;
    multiSelectToggle.textContent = isMulti ? 'Exit Group Selection (Tap Mode)' : 'Start Group Selection (Tap Mode)';
    selectedIds = [];
    updateBtn();
    tblLayer.draw();
  };

  payBtn.onclick = () => {
    if (!selectedIds.length) { alert("Select a table first."); return; }
    customerModal.style.display = 'flex';
  };

  customerForm.onsubmit = async e => {
    e.preventDefault();
    const name = document.getElementById('customer-name').value.trim();
    const email = document.getElementById('customer-email').value.trim();
    const party = parseInt(document.getElementById('party-size').value);
    if (!name || !email || !party) { alert("Fill all fields"); return; }
    customerModal.style.display = 'none';
    alert("Stripe checkout placeholder. Selected tables: " + selectedIds.join(', '));
  };

  window.onclick = e => { if (e.target === customerModal) customerModal.style.display = 'none'; };

  /* ---------- INIT ---------- */
  loadFloorplan(loadTables);
});
</script>

</body>
</html>
