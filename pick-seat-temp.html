// --- Konva Table Drawing ---
	
	function drawTable(t){
		const group = new Konva.Group({	
			x:t.x,	
			y:t.y,	
			id:'g-'+t.id,	
			table_id: Number(t.id),
			draggable:false // Customer page tables are not draggable
		});
		layer.add(group);

		const isStaffUseOnly = STAFF_USE_TABLE_IDS.includes(t.id);

		const tableRect = new Konva.Rect({	
			width:t.w,	
			height:t.h,	
			fill: isStaffUseOnly ? UNAVAILABLE_COLOR : TABLE_COLOR,
			stroke:'#000',	
			strokeWidth:1,
			name: 'main-table'	
		});
		group.add(tableRect);

		// Seat drawing logic (copied from admin.html)
		const baseSeatSize = 12;	
		const seatHalf = baseSeatSize / 2;	

		function makeSeat(x, y, w, h) {
			group.add(new Konva.Rect({ width:w, height:h, fill:SEAT_COLOR, x:x, y:y }));
		}

		if (t.w === 30 && t.h === 30) {
			makeSeat(t.w/2 - baseSeatSize/2, -seatHalf, baseSeatSize, seatHalf);
			makeSeat(t.w/2 - baseSeatSize/2, t.h, baseSeatSize, seatHalf);
		} else if (t.w === 30 && t.h === 50) {
			const v_spacing = (t.h - 2*baseSeatSize)/3;
			makeSeat(-seatHalf, v_spacing, seatHalf, baseSeatSize);
			makeSeat(-seatHalf, v_spacing*2 + baseSeatSize, seatHalf, baseSeatSize);
			makeSeat(t.w, v_spacing, seatHalf, baseSeatSize);
			makeSeat(t.w, v_spacing*2 + baseSeatSize, seatHalf, baseSeatSize);
		} else if (t.w === 50 && t.h === 30) {	
			const h_spacing = (t.w - 2 * baseSeatSize) / 3;
			makeSeat(h_spacing, -seatHalf, baseSeatSize, seatHalf);
			makeSeat(h_spacing * 2 + baseSeatSize, -seatHalf, baseSeatSize, seatHalf);
			makeSeat(h_spacing, t.h, baseSeatSize, seatHalf);
			makeSeat(h_spacing * 2 + baseSeatSize, t.h, baseSeatSize, seatHalf);
		} else if (t.w === 90 && t.h === 30) {
			const h_spacing = t.w / 4;
			for(let i=0; i<3; i++){
				const x_pos = h_spacing*(i+1) - baseSeatSize/2;
				makeSeat(x_pos, -seatHalf, baseSeatSize, seatHalf);
				makeSeat(x_pos, t.h, baseSeatSize, seatHalf);
			}
		}

		// Save price data to the map for total calculation
		tableDataMap.set(t.id, { 
			id: t.id, 
			price: getTablePrice(t.w, t.h),
			is_staff: isStaffUseOnly
		});

		// --- Customer Click Handler ---
		group.on('click', () => {
			const tableId = t.id;
			const tableRect = group.findOne('.main-table');
			const isCurrentlyBooked = tableRect.fill() === BOOKED_COLOR;
			const isStaff = STAFF_USE_TABLE_IDS.includes(tableId);

			if (isStaff || isCurrentlyBooked) {
				const status = isStaff ? 'Staff Use Only' : 'Already Booked';
				alert(`Table ${tableId} is ${status} and cannot be selected.`);
				return;
			}
			
			// Single-select mode (default)
			if (!isMultiSelectMode) {
				// If a table is already selected, deselect it
				if (selectedTableIds.length === 1 && selectedTableIds[0] === tableId) {
					selectedTableIds = [];
				} else {
					// Otherwise, clear previous selection and select this one
					selectedTableIds = [tableId];
				}
			} 
			// Multi-select mode (Tap Mode)
			else {
				const index = selectedTableIds.indexOf(tableId);
				if (index > -1) {
					selectedTableIds.splice(index, 1); // Deselect
				} else {
					selectedTableIds.push(tableId); // Select
				}
			}
			updateTableVisuals();
		});

		return group;
	}

	async function loadTables() {
		// --- DEFINITIVE LIST OF 21 TABLES WITH CORRECT SIZES (Copied from admin.html) ---
		const baseTables = [
			// Original Tables 1-17
			{ id: 1, x: 235, y: 110, w: 90, h: 30, rotation: 0 },
			{ id: 2, x: 100, y: 30, w: 90, h: 30, rotation: 0 },
			{ id: 3, x: 100, y: 150, w: 30, h: 30, rotation: 0 },
			{ id: 4, x: 140, y: 220, w: 30, h: 30, rotation: 0 },
			{ id: 5, x: 180, y: 300, w: 50, h: 30, rotation: 90 }, // 4-seater
			{ id: 6, x: 250, y: 330, w: 30, h: 30, rotation: 0 },
			{ id: 7, x: 30, y: 300, w: 50, h: 30, rotation: 90 }, // 4-seater
			{ id: 8, x: 400, y: 100, w: 30, h: 30, rotation: 0 },
			{ id: 9, x: 20, y: 180, w: 30, h: 50, rotation: 0 }, // 4-seater
			{ id: 10, x: 300, y: 240, w: 30, h: 30, rotation: 0 },
			{ id: 11, x: 40, y: 80, w: 30, h: 30, rotation: 0 },
			{ id: 12, x: 350, y: 350, w: 50, h: 30, rotation: 0 }, // 4-seater
			{ id: 13, x: 400, y: 280, w: 30, h: 30, rotation: 0 },
			{ id: 14, x: 250, y: 180, w: 30, h: 30, rotation: 0 },
			
			// --- NEW TABLES REQUESTED (IDs 18-21) ---
			{ id: 18, x: 140, y: 280, w: 30, h: 30, rotation: 0 }, // New 2-seater
			{ id: 19, x: 220, y: 280, w: 30, h: 30, rotation: 0 }, // New 2-seater
			{ id: 20, x: 300, y: 280, w: 30, h: 30, rotation: 0 }, // New 2-seater
			{ id: 21, x: 300, y: 180, w: 50, h: 30, rotation: 90 }, // New 4-seater (50x30, rotated)
		];
		
		let tablesToDraw = baseTables;
		
		// Attempt to load saved positions (Optional but recommended for stability)
		try {
			// This fetch must use the public table data which includes rotation
			const { data: dbData, error } = await _supa.from('tables').select('id, x, y, rotation').order('id'); 
			
			if (dbData && dbData.length > 0) {
				const positionMap = new Map(dbData.map(t => [t.id, t]));
				
				tablesToDraw = baseTables.map(t => {
					const dbPos = positionMap.get(t.id);
					if (dbPos) {
						return {	
							id: t.id,	
							x: dbPos.x,	
							y: dbPos.y,	
							w: t.w,	
							h: t.h,	
							rotation: dbPos.rotation	
						};
					}
					return t;	
				});
			} else if (error) {
				console.warn("Could not fetch table positions from Supabase. Using default hardcoded positions.");
			}
		} catch (e) {
			console.error("Error fetching table positions, using default.", e);
		}


		layer.destroyChildren();	
		tablesToDraw.forEach(t => {
			const group = drawTable(t);
			const tableRect = group.findOne('.main-table');

			// Apply offset and rotation (from admin.html logic)
			group.offset({ x: tableRect.width()/2, y: tableRect.height()/2 });
			group.x(t.x + tableRect.width()/2);
			group.y(t.y + tableRect.height()/2);
			group.rotation(t.rotation || 0);	
		});
		layer.draw();

		// Load bookings for the current date/time
		await loadBookings();	
	}

	// --- Stripe Checkout Function ---
	
	async function createStripeCheckout(customerData) {
		const totalPence = calculateTotalPence();
		
		if (totalPence === 0) {
			alert("Please select at least one table to proceed to payment.");
			return;
		}

		// 1. Prepare tracking data for UPSERT
		const { error: trackingError } = await _supa
			.from('engagement_tracking')
			.upsert({
				tenant_id: URL_PARAMS.tenant_id,
				booking_ref: URL_PARAMS.booking_ref,
				checkout_started: true, // Mark checkout started
			}, { onConflict: 'booking_ref' });

		if (trackingError) {
			console.error("Error logging checkout start:", trackingError);
		}


		// 2. Prepare the payload for your Vercel API
		const payload = {
			date: getSupabaseDate(),
			startTime: document.getElementById('booking-time').value,
			selectedTables: selectedTableIds,
			partySize: Number(customerData.partySize),
			customerName: customerData.customerName,
			customerEmail: customerData.customerEmail,
			tenantId: URL_PARAMS.tenant_id, // Pass tenant ID
			bookingRef: URL_PARAMS.booking_ref, // Pass booking reference
			source: URL_PARAMS.source,
			totalAmount: totalPence,
			// The success URL must be correct for GitHub Pages deployment
			successUrl: window.location.origin + window.location.pathname.replace('pick-seat.html', 'success.html') + window.location.search,
			cancelUrl: window.location.href,
		};
		
		// CRITICAL: The API URL must point to your stripe-serverless Vercel deployment
		const STRIPE_API_URL = 'https://stripe-serverless-phi.vercel.app/api/create-checkout';

		try {
			payBtn.textContent = "Processing...";
			payBtn.disabled = true;

			const response = await fetch(STRIPE_API_URL, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload),
			});

			const result = await response.json();

			if (response.ok && result.url) {
				// Redirect to Stripe Checkout page
				window.location.href = result.url;
			} else {
				console.error("Stripe Checkout failed:", result.error || 'Unknown error');
				alert('Booking failed: ' + (result.error || 'Check console for details.'));
			}
		} catch (error) {
			console.error("Network or Fetch Error:", error);
			alert('Could not connect to payment service.');
		} finally {
			// Reset button state
			updatePayButton(totalPence);
			payBtn.disabled = false;
		}
	}


	// --- Initialization ---

	// Event Listeners
	window.addEventListener('resize', resizeStage);
	
	document.getElementById('check-availability').onclick = loadBookings;

	multiSelectToggle.onclick = () => {
		isMultiSelectMode = !isMultiSelectMode;
		selectedTableIds = []; 
		
		if(isMultiSelectMode){
			multiSelectToggle.classList.add('active');
			multiSelectToggle.textContent = 'Exit Group Selection (Tap Mode)';
		} else {
			multiSelectToggle.classList.remove('active');
			multiSelectToggle.textContent = 'Start Group Selection (Tap Mode)';
		}
		updateTableVisuals();
	};


	payBtn.onclick = () => {
		if (selectedTableIds.length === 0) {
			alert("Please select at least one table.");
			return;
		}
		// Show the customer details modal
		customerModal.style.display = 'flex';
	};

	customerForm.onsubmit = (e) => {
		e.preventDefault();
		
		const customerData = {
			customerName: document.getElementById('customer-name').value,
			partySize: document.getElementById('party-size').value,
			customerEmail: document.getElementById('customer-email').value,
		};
		
		customerModal.style.display = 'none';
		createStripeCheckout(customerData);
	};

	window.onclick = (event) => {
		if (event.target === customerModal) {
			customerModal.style.display = 'none';
		}
	};
	
	// Run on page load
	getUrlParams(); // Get tenant_id and booking_ref
	logInitialClick(); // Log the link view
	setDefaultDateTime();
	loadFloorplan(loadTables); // Load background, then draw tables and load bookings
