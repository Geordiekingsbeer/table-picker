<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Admin – Drag Tables</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    body{
        font-family: Arial, Helvetica, sans-serif;
        background:#f7f7f7;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0; 
        padding: 20px 0;
    }
    h2 {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 700;
      color: #333;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 10px;
      width: 100%;
    }
    h2 .arrow { font-weight:700; font-size:24px; margin:0 10px; color:#1976d2; }
    h2 button { padding:10px 20px; font-size:15px; font-weight:600; border-radius:6px; border:none; cursor:pointer; color:#fff; transition:0.2s; box-shadow:0 4px 10px rgba(0,0,0,0.2); }
    h2 button#save{background-color:#388e3c;}
    h2 button#rotate{background-color:#1976d2;}
    h2 button:hover{box-shadow:0 6px 14px rgba(0,0,0,0.3); opacity:0.95;}

    #schedule-controls { margin-bottom:15px; padding:10px 20px; background:#fff; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05); display:flex; align-items:center; gap:15px;}
    #schedule-controls label{ font-weight:600; margin-right:5px; font-size:14px; color:#555;}
    #schedule-controls input,#schedule-controls select{ padding:8px; border:1px solid #ccc; border-radius:4px;}
    #schedule-controls button{ background:#1976d2; color:#fff; padding:8px 15px; font-weight:600; box-shadow:0 2px 5px rgba(0,0,0,0.2); }

    #block-input-area {
      margin-top:10px; margin-bottom:20px; padding:15px; border:1px solid #ddd; border-radius:6px;
      background:#fff8e1; display:none; flex-direction:column; align-items:flex-start; width:450px; box-sizing:border-box;
    }
    #block-input-area input { margin-bottom:10px; width:100%; padding:8px; box-sizing:border-box; }
    #block-input-area button { margin-top:10px; align-self:flex-end; }

    #container-wrapper { display:flex; justify-content:center; width:100%; }
    #container{ width:480px; height:480px; border:1px solid #ccc; box-shadow:0 4px 12px rgba(0,0,0,0.15); background:#fff; }

    @media (max-width:500px){ h2{font-size:18px;} h2 button{padding:8px 14px; font-size:14px;} }
  </style>
</head>
<body>
  <h2>
    Drag tables <span class="arrow">→</span>
    <button id="save">Save layout</button>
    <button id="rotate">Rotate Table 90°</button>
  </h2>

  <div id="schedule-controls">
    <label for="booking-date">Date:</label>
    <input type="date" id="booking-date">
    <label for="booking-time">View Time:</label>
    <select id="booking-time"></select>
    <button id="view-schedule">Refresh Map</button>
  </div>

  <div id="block-input-area">
    <p style="margin-top:0;">**Manually Block Table <span id="block-table-id" style="font-weight:700; color:#d32f2f;"></span>**</p>
    <label for="block-start-time">Start Time:</label>
    <input type="time" id="block-start-time" required>
    <label for="block-end-time">End Time:</label>
    <input type="time" id="block-end-time" required>
    <label for="host-notes">Host Notes:</label>
    <input type="text" id="host-notes" required>
    <button id="block-slot-button" style="background:#d32f2f;">Block Slot</button>
  </div>

  <div id="container-wrapper">
    <div id="container"></div>
  </div>

<script>
  const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
  const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
  const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

  const STAGE_WIDTH=480, STAGE_HEIGHT=480;
  const stage = new Konva.Stage({ container:'container', width:STAGE_WIDTH, height:STAGE_HEIGHT });
  const backgroundLayer = new Konva.Layer(); stage.add(backgroundLayer);
  const layer = new Konva.Layer(); stage.add(layer);

  let tables=[], selectedGroup=null;
  const TABLE_COLOR='#b7d7a8', SEAT_COLOR='#555', TAKEN_COLOR='#9e9e9e';
  const TURN_DURATION_MINUTES = 90;
  let selectedTableId=null;

  const timeToMinutes = (time) => { const [h,m] = time.split(':').map(Number); return h*60 + m; };

  // Populate date/time selectors
  function populateTimeDropdown() {
    const select=document.getElementById('booking-time');
    const slots=["17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:30","22:00"];
    slots.forEach(time=>{ const option=document.createElement('option'); option.value=time; option.textContent=time; select.appendChild(option); });
    const today=(new Date()).toISOString().split('T')[0];
    document.getElementById('booking-date').value=today;
    select.value=slots[2];
  }

  // Fetch blocked tables for selected date/time
  async function loadBookings(date, time) {
    const selectedMinutes = timeToMinutes(time);
    const { data, error } = await _supa.from('premium_slots').select('table_id,start_time,end_time').eq('date', date);
    if(error){ console.error('Error fetching bookings:', error); return []; }

    return data.filter(slot=>{
      const slotStart = timeToMinutes(slot.start_time);
      const slotEnd = slot.end_time ? timeToMinutes(slot.end_time) : slotStart + TURN_DURATION_MINUTES;
      return slotEnd > selectedMinutes && slotStart < selectedMinutes + TURN_DURATION_MINUTES;
    }).map(s=>s.table_id);
  }

  // Manual blocking
  document.getElementById('block-slot-button').onclick = async () => {
    const date = document.getElementById('booking-date').value;
    const startTime = document.getElementById('block-start-time').value;
    const endTime = document.getElementById('block-end-time').value;
    const notes = document.getElementById('host-notes').value;

    if(!selectedGroup || !startTime || !endTime || !notes){ alert('Please select a table and fill all fields.'); return; }

    const tableIdNum = parseInt(selectedGroup.id().replace('g-', ''), 10);

    const { error } = await _supa.from('premium_slots').insert([{ table_id: tableIdNum, date, start_time:startTime, end_time:endTime, host_notes:notes }]);
    if(error){ alert('Error blocking slot: '+error.message); return; }

    alert(`Slot blocked for Table ${tableIdNum}!`);
    document.getElementById('block-input-area').style.display='none';
    selectedGroup=null;
    await loadTables();
  };

  function loadBackground(callback){
    const img=new Image();
    img.onload=function(){ 
      backgroundLayer.add(new Konva.Image({ x:0, y:0, image:img, width:STAGE_WIDTH, height:STAGE_HEIGHT }));
      backgroundLayer.draw();
      if(callback) callback();
    };
    img.src='floorplan.png';
  }

  async function loadTables(){
    layer.destroyChildren();
    const date=document.getElementById('booking-date').value;
    const time=document.getElementById('booking-time').value;
    const blockedTableIds = await loadBookings(date,time);

    const { data, error } = await _supa.from('tables').select('*, rotation').order('id');
    if(error){ console.error(error); alert('Error loading tables'); return; }
    tables=data;

    tables.forEach(t=>{
      const isBlocked = blockedTableIds.includes(t.id);
      const group = drawTable(t,isBlocked);

      const tableRect=group.findOne('.main-table');
      group.offset({x:tableRect.width()/2, y:tableRect.height()/2});
      group.x(t.x + tableRect.width()/2);
      group.y(t.y + tableRect.height()/2);
      group.rotation(t.rotation || 0);

      if(selectedGroup && selectedGroup.id()==='g-'+t.id){ tableRect.stroke('#ffeb3b'); }
    });
    layer.draw();
  }

  function drawTable(t, isBlocked){
    const group = new Konva.Group({ x:t.x, y:t.y, id:'g-'+t.id, draggable:true });
    layer.add(group);

    const tableRect = new Konva.Rect({ width:t.w, height:t.h, fill:isBlocked?TAKEN_COLOR:TABLE_COLOR, stroke:'#000', strokeWidth:1, name:'main-table' });
    group.add(tableRect);

    // Seats
    const baseSeatSize=12, seatHalf=baseSeatSize/2;
    function makeSeat(x,y,w,h){ group.add(new Konva.Rect({ width:w, height:h, fill:SEAT_COLOR, x, y })); }
    if(t.w===30 && t.h===30){ const seatW=baseSeatSize, seatH=seatHalf; makeSeat(t.w/2-seatW/2,-seatH,seatW,seatH); makeSeat(t.w/2-seatW/2,t.h,seatW,seatH); }
    else if(t.w===30 && t.h===50){ const seatW=seatHalf, seatH=baseSeatSize, v_spacing=(t.h-2*seatH)/3; makeSeat(-seatW,v_spacing,seatW,seatH); makeSeat(-seatW,v_spacing*2+seatH,seatW,seatH); makeSeat(t.w,v_spacing,seatW,seatH); makeSeat(t.w,v_spacing*2+seatH,seatW,seatH); }
    else if(t.w===90 && t.h===30){ const seatW=baseSeatSize, seatH=seatHalf, h_spacing=t.w/4; for(let i=0;i<3;i++){ const x_pos=h_spacing*(i+1)-seatW/2; makeSeat(x_pos,-seatH,seatW,seatH); makeSeat(x_pos,t.h,seatW,seatH); } }

    group.on('mousedown touchstart',()=>{
      if(selectedGroup) selectedGroup.findOne('.main-table').stroke('#000');
      selectedGroup=group; tableRect.stroke('#ffeb3b'); layer.draw();
      document.getElementById('block-table-id').textContent=group.id().replace('g-','');
      document.getElementById('block-input-area').style.display='flex';
    });

    return group;
  }

  document.getElementById('view-schedule').onclick=()=>{ loadTables(); };
  document.getElementById('rotate').onclick=()=>{ if(selectedGroup){ selectedGroup.rotation(selectedGroup.rotation()+90); layer.draw(); } };

  document.getElementById('save').onclick=async()=>{
    const updates=tables.map(t=>{
      const g = layer.findOne('#g-'+t.id);
      const tableRect=g.findOne('.main-table');
      const finalX=g.x()-tableRect.width()/2;
      const finalY=g.y()-tableRect.height()/2;
      const finalRotation=g.rotation();
      return { id:t.id, x:finalX, y:finalY, rotation:finalRotation };
    });
    const { data, error } = await _supa.from('tables').upsert(updates).select('*, rotation');
    if(error){ alert('Save failed: '+error.message); } else { tables=data; alert('Layout saved!'); }
  };

  populateTimeDropdown();
  loadBackground(loadTables);
</script>
</body>
</html>
