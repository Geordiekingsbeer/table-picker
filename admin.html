<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8"/>

  <title>Admin – Drag Tables</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script src="https://unpkg.com/konva@9/konva.min.js"></script>

  <style>

    body{

        font-family: Arial, Helvetica, sans-serif;

        background:#f7f7f7;

        display: flex;

        flex-direction: column;

        align-items: center;

        justify-content: center;

        min-height: 100vh;

        margin: 0; 

        padding: 20px 0;

    }



    /* Header container */

    h2 {

      display: flex;

      align-items: center;

      justify-content: center;

      font-size: 22px;

      font-weight: 700;

      color: #333;

      margin-bottom: 25px;

      flex-wrap: wrap;

      gap: 10px;

    }



    h2 .arrow {

      font-weight: 700;

      font-size: 24px;

      margin: 0 10px;

      color: #1976d2;

    }



    /* Buttons in header */

    h2 button {

      padding: 10px 20px;

      font-size: 15px;

      font-weight: 600;

      border-radius: 6px;

      border: none;

      cursor: pointer;

      color: #fff;

      transition: all 0.2s ease;

      box-shadow: 0 4px 10px rgba(0,0,0,0.2);

    }



    h2 button#save {

      background-color: #388e3c;

    }

    h2 button#rotate {

      background-color: #1976d2;

    }



    h2 button:hover {

      box-shadow: 0 6px 14px rgba(0,0,0,0.3);

      opacity: 0.95;

    }



    /* Floorplan container */

    #container-wrapper {

      display: flex;

      justify-content: center;

      width: 100%;

    }



    #container{

      width:480px;

      height:480px;

      border:1px solid #ccc;

      box-shadow: 0 4px 12px rgba(0,0,0,0.15);

      background:#fff;

    }



    /* Responsive for small screens */

    @media (max-width: 500px) {

      h2 { font-size: 18px; }

      h2 button { padding: 8px 14px; font-size: 14px; }

    }

  </style>

</head>

<body>

  <h2>

    Drag tables <span class="arrow">→</span>

    <button id="save">Save layout</button>

    <button id="rotate">Rotate Table 90°</button>

  </h2>



  <div id="container-wrapper">

      <div id="container"></div>

  </div>



  <script>

    // --- Supabase setup ---

    const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co';

    const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';

    const _supa = supabase.createClient(supabaseUrl, supabaseAnon);



    const STAGE_WIDTH = 480;

    const STAGE_HEIGHT = 480;



    const stage = new Konva.Stage({ container:'container', width:STAGE_WIDTH, height:STAGE_HEIGHT });

    const backgroundLayer = new Konva.Layer();

    stage.add(backgroundLayer);

    const layer = new Konva.Layer(); 

    stage.add(layer);



    let tables = [];

    let selectedGroup = null;

    const TABLE_COLOR = '#b7d7a8';

    const SEAT_COLOR = '#555';



    function loadBackground(callback) {

      const imageObj = new Image();

      imageObj.onload = function() {

        const floorplan = new Konva.Image({

          x: 0,

          y: 0,

          image: imageObj,

          width: STAGE_WIDTH,

          height: STAGE_HEIGHT,

        });

        backgroundLayer.add(floorplan);

        backgroundLayer.draw();

        if (callback) callback();

      };

      imageObj.src = 'floorplan.png';

    }



    async function loadTables() {

      const { data, error } = await _supa.from('tables').select('*, rotation').order('id');

      if(error){ console.error(error); alert('Error loading tables'); return; }

      tables = data;

      tables.forEach(t => {

        const group = drawTable(t);

        const tableRect = group.findOne('.main-table');



        group.offset({ x: tableRect.width()/2, y: tableRect.height()/2 });

        group.x(t.x + tableRect.width()/2);

        group.y(t.y + tableRect.height()/2);

        group.rotation(t.rotation || 0); 

      });

      layer.draw();

    }



    function drawTable(t){

      const group = new Konva.Group({ x:t.x, y:t.y, id:'g-'+t.id, draggable:true });

      layer.add(group);



      const tableRect = new Konva.Rect({ 

        width:t.w, 

        height:t.h, 

        fill:TABLE_COLOR, 

        stroke:'#000', 

        strokeWidth:1,

        name: 'main-table' 

      });

      group.add(tableRect);



      const baseSeatSize = 12; 

      const seatHalf = baseSeatSize / 2; 



      function makeSeat(x, y, w, h) {

        group.add(new Konva.Rect({ width:w, height:h, fill:SEAT_COLOR, x:x, y:y }));

      }



      // Seat positions

      if (t.w === 30 && t.h === 30) { // 2-seater

        makeSeat(t.w/2 - baseSeatSize/2, -seatHalf, baseSeatSize, seatHalf);

        makeSeat(t.w/2 - baseSeatSize/2, t.h, baseSeatSize, seatHalf);

      } else if (t.w === 30 && t.h === 50) { // 4-seater

        const v_spacing = (t.h - 2*baseSeatSize)/3;

        makeSeat(-seatHalf, v_spacing, seatHalf, baseSeatSize);

        makeSeat(-seatHalf, v_spacing*2 + baseSeatSize, seatHalf, baseSeatSize);

        makeSeat(t.w, v_spacing, seatHalf, baseSeatSize);

        makeSeat(t.w, v_spacing*2 + baseSeatSize, seatHalf, baseSeatSize);

      } else if (t.w === 90 && t.h === 30) { // 6-seater

        const h_spacing = t.w / 4;

        for(let i=0; i<3; i++){

          const x_pos = h_spacing*(i+1) - baseSeatSize/2;

          makeSeat(x_pos, -seatHalf, baseSeatSize, seatHalf);

          makeSeat(x_pos, t.h, baseSeatSize, seatHalf);

        }

      }



      group.on('click', () => {

        if(selectedGroup) selectedGroup.findOne('.main-table').stroke('#000');

        selectedGroup = group;

        tableRect.stroke('#ffeb3b');

        layer.draw();

      });

      return group;

    }



    document.getElementById('rotate').onclick = () => {

      if(selectedGroup){

        selectedGroup.rotation(selectedGroup.rotation()+90);

        layer.draw();

      }

    };



    document.getElementById('save').onclick = async () => {

      const updates = tables.map(t=>{

        const g = layer.findOne('#g-'+t.id);

        const tableRect = g.findOne('.main-table');

        const finalX = g.x() - tableRect.width()/2;

        const finalY = g.y() - tableRect.height()/2;

        const finalRotation = g.rotation();

        return { id:t.id, x:finalX, y:finalY, rotation: finalRotation };

      });

      const { data, error } = await _supa.from('tables').upsert(updates).select('*, rotation');

      if(error){ alert('Save failed: '+error.message); } else { tables = data; alert('Layout saved!'); }

    };



    loadBackground(loadTables);

  </script>

</body>

</html>

