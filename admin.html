<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>Admin – Drag Tables</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="https://unpkg.com/konva@9/konva.min.js"></script>
	<style>
		body{
			font-family: Arial, Helvetica, sans-serif;
			background:#e3e3e3;	
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: flex-start;
			min-height: 100vh;
			margin: 0;	
			padding: 20px 10px;
		}

		/* Admin Management Buttons (Drag, Save, Rotate) */
		.admin-controls-top {
			display: flex;
			align-items: center;
			justify-content: center;
			margin-bottom: 20px;
			flex-wrap: wrap;
			gap: 10px;
		}
		
		.admin-controls-top button {
			padding: 8px 15px;
			font-size: 14px;
			font-weight: 600;
			border-radius: 4px;
			border: none;
			cursor: pointer;
			color: #fff;
			transition: all 0.2s ease;
			/* UPDATED: Added subtle box shadow for depth */
			box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
		}

		/* UPDATED: Save button matches table color */
		.admin-controls-top button#save {
			background-color: #b7d7a8; /* Table Color */
			color: #333; /* Darker text for visibility */
		}
		
		/* UPDATED: Rotate button to light baby blue */
		.admin-controls-top button#rotate {
			background-color: #add8e6; /* Light Blue */
			color: #333; /* Darker text for visibility */
		}
		
		.admin-controls-top button:hover {
			/* Increased shadow on hover for better effect */
			box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
			opacity: 0.95;
		}

		/* Date/Time Selector - MATCHES CUSTOMER FILE */
		#datetime-controls {
			display: flex;
			gap: 10px;
			margin-bottom: 15px;
			align-items: center;
			padding: 0;
			background: none;
			box-shadow: none;
			flex-wrap: nowrap;
			max-width: 480px;
			width: 100%;
		}

		#datetime-controls label {
			font-weight: 600;
			color: #555;
			white-space: nowrap;
		}

		/* Input Styling - MATCHES CUSTOMER FILE */
		#datetime-controls input {
			flex-grow: 1;
			padding: 12px 10px;
			border: 1px solid #ccc;
			border-radius: 4px;
			background: white;
			font-size: 16px;
			color: #333;
			max-width: none;
			font-weight: 500;
			text-align: center;
			/* NEW: Force font without slashed zero */
			font-family: Arial, sans-serif; 
		}
		
		/* UPDATED: Load Bookings button matches table color & has bold text */
		#load-bookings {
			padding: 12px 10px;
			background-color: #b7d7a8; /* Table Color */
			color: #333; /* Darker text for visibility */
			border: none;
			border-radius: 4px;
			cursor: pointer;
			/* UPDATED: Make text bold */
			font-weight: 600; 
			flex-grow: 1;
			box-shadow: 0 1px 3px rgba(0,0,0,0.2); /* Added subtle box shadow */
			white-space: nowrap;
		}
		
		#load-bookings:hover {
			background-color: #a7c598; /* Slightly darker hover for table color */
			box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* Increased shadow on hover */
		}
		
		.admin-controls-top button#save:hover {
			background-color: #a7c598; /* Slightly darker hover for save button */
		}
		
		.admin-controls-top button#rotate:hover {
			background-color: #99c2d1; /* Slightly darker hover for rotate button */
		}


		/* Multi-Select Toggle Button - MATCHES CUSTOMER FILE */
		#multi-select-toggle, #multi-book-button {
			padding: 10px 15px;
			font-size: 16px;
			font-weight: 500;
			margin-bottom: 20px;
			border-radius: 4px;
			cursor: pointer;
			border: 1px solid #666;
			background-color: #f7f7f7; /* Light Gray Background */
			color: #333;
			transition: all 0.2s ease;
			white-space: nowrap;
			width: 90vw;
			max-width: 480px;
			text-align: center;
			/* Added subtle shadow to this button too */
			box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
		}
		
		#multi-select-toggle:hover, #multi-book-button:hover {
			box-shadow: 0 2px 5px rgba(0,0,0,0.3);
		}

		#multi-select-toggle.active {
			background-color: #1976d2;
			color: white;
			border: 1px solid #1976d2;
		}
		#multi-book-button {
			background-color: #388e3c;
			color: white;
			border: none;
		}

		/* Floorplan container */
		#container-wrapper {
			display: flex;
			justify-content: center;
			width: 100%;
			max-width: 480px;	
		}

		#container{
			width: 100%;
			height: auto;
			border: none;	
			box-shadow: none;
			background-color: transparent;
		}

		/* Status Legend */
		#status-legend {
			display: flex;
			gap: 15px;
			margin-top: 15px;
			font-size: 14px;
			color: #555;
			flex-wrap: wrap;
			justify-content: center;
			max-width: 480px;
			width: 100%;
		}
		.legend-item {
			display: flex;
			align-items: center;
		}
		.legend-color {
			width: 15px;
			height: 15px;
			border-radius: 3px;
			margin-right: 5px;
			border: 1px solid #000; 
		}
		
		/* Modal styles */
		.modal {
			display: none;	
			position: fixed;	
			z-index: 1000;	
			left: 0;
			top: 0;
			width: 100%;	
			height: 100%;	
			overflow: auto;	
			background-color: rgba(0,0,0,0.4);	
		}

		.modal-content {
			margin: 10vh auto;
			padding: 20px;
			border: 1px solid #888;
			width: 90%;
			max-width: 400px;
			border-radius: 10px;
			box-shadow: 0 5px 15px rgba(0,0,0,0.3);
			position: relative;
			background-color: #fefefe;
		}
		
		.close-button {
			color: #aaa;
			float: right;
			font-size: 28px;
			font-weight: bold;
		}

		.close-button:hover,
		.close-button:focus {
			color: #000;
			text-decoration: none;
			cursor: pointer;
		}
		
		.modal-content label { display: block; margin-top: 10px; font-weight: 600; }
		.modal-content input, .modal-content textarea, .modal-content button {	
			width: 100%;	
			padding: 8px;	
			margin-top: 5px;	
			box-sizing: border-box;	
			border: 1px solid #ccc;
			border-radius: 4px;
		}
		
		.modal-content button {
			background-color: #388e3c;
			color: white;
			cursor: pointer;
			margin-top: 20px;
		}
		
		.modal-content button:hover {
			background-color: #2e7d32;
		}
		
		#current-booking-info {
			padding: 10px;
			margin-top: 15px;
			border: 1px solid #ffcc80;
			background-color: #fff3e0;
			border-radius: 5px;
		}

		/* Ensures long text strings (like order IDs) wrap correctly */
		#current-booking-info p span {
			word-break: break-all;
		}
		
		#remove-booking {
			background-color: #d32f2f;
		}
		
		/* Responsive for small screens */
		@media (max-width: 500px) {
			.admin-controls-top button { padding: 8px 10px; font-size: 12px; }
		}
	</style>
</head>
<body>
    <h3 id="restaurant-display-name" style="margin-bottom: 20px;">Admin Panel</h3>

	<div class="admin-controls-top">
		<button id="save">Save layout</button>
		<button id="rotate">Rotate Table 90°</button>
	</div>

	<button id="multi-select-toggle" data-active="false">Start Multi-Select Mode</button>
	<button id="multi-book-button" style="display:none;">Book Selected Tables</button>


	<div id="datetime-controls">
		<label for="booking-date">Date:</label>
		<input type="date" id="booking-date" value="">
		<label for="booking-time">Time:</label>
		<input type="time" id="booking-time" value="">
		<button id="load-bookings">Load Bookings</button>
	</div>

	<div id="container-wrapper">
		<div id="container"></div>
	</div>
	
	<div id="status-legend">
		<div class="legend-item"><span class="legend-color" style="background-color: #b7d7a8;"></span>Premium Available</div>
		<div class="legend-item"><span class="legend-color" style="background-color: #e0e0e0;"></span>Booked (Premium)</div>
		<div class="legend-item"><span class="legend-color" style="background-color: #ffffff;"></span>Staff Use Only (N/A)</div>	
	</div>

	<div id="multi-booking-modal" class="modal">
		<div class="modal-content">
			<span class="close-button" id="multi-close-button-span">&times;</span>
			<h3 id="multi-modal-title">Bulk Booking</h3>
			<p>Selected Tables: <span id="selected-table-list"></span></p>
			<form id="multi-booking-form">
				<label for="multi-start-time">Start Time (HH:MM):</label>
				<input type="time" id="multi-start-time" required>
				
				<label for="multi-end-time">End Time (HH:MM):</label>
				<input type="time" id="multi-end-time" required>
				
				<label for="multi-notes">Notes:</label>
				<textarea id="multi-notes" rows="3"></textarea>
				
				<button type="submit" id="multi-book-slot">Confirm Bulk Booking</button>
			</form>
		</div>
	</div>

	<div id="booking-modal" class="modal">
		<div class="modal-content">
			<span class="close-button" id="single-close-button-span">&times;</span>
			<h3 id="modal-title">Table Booking</h3>
			<form id="booking-form">
				<input type="hidden" id="modal-table-id">
				
				<div id="current-booking-info" style="display:none;">
					<p><strong>Status:</strong> Booked</p>
					<p><strong>Start:</strong> <span id="booked-start"></span></p>
					<p><strong>End:</strong> <span id="booked-end"></span></p>
					<p><strong>Notes:</strong> <span id="booked-notes"></span></p>
					<button type="button" id="remove-booking">Remove Booking</button>
				</div>

				<div id="new-booking-form">
					<label for="start-time">Start Time (HH:MM):</label>
					<input type="time" id="start-time" required>
					
					<label for="end-time">End Time (HH:MM):</label>
					<input type="time" id="end-time" required>
					
					<label for="notes">Notes:</label>
					<textarea id="notes" rows="3"></textarea>
					
					<button type="submit" id="book-slot">Book Slot</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		// --- Konva Stage Dimensions (The fixed, internal dimensions of your floorplan) ---
		const STAGE_WIDTH = 480;	
		const STAGE_HEIGHT = 480;	
		// ---------------------------------------------------------------------------------
		
		// --- Supabase setup (CRITICAL FIX APPLIED HERE) ---
		const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co ';
		
		// REMOVED: Deleted the exposed supabaseServiceRoleKey variable for security.
		
		// FIX: Use the safe, read-only ANONYMOUS KEY for browser ops to avoid 401 (Unauthorized) errors.
		const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
		const _supa = supabase.createClient(supabaseUrl, supabaseAnonKey); // Used for all READ operations

		const container = document.getElementById('container');
		
		const stage = new Konva.Stage({ container:'container', width:STAGE_WIDTH, height:STAGE_HEIGHT });
		const backgroundLayer = new Konva.Layer();
		stage.add(backgroundLayer);
		const layer = new Konva.Layer();
		stage.add(layer);

		let tables = [];
		let selectedGroup = null;
		let isMultiSelectMode = false;
		let selectedMultiTables = new Set();
		
		// CRITICAL: Dummy tenant ID for Admin Panel - UPDATED TO MATCH SUCCESSFUL TEST ID
		const CURRENT_TENANT_ID = 'R-VERIFIED-Z99'; 
        // CRITICAL: Vercel Function URL for SECURE Admin booking
        const ADMIN_BOOKING_API_URL = 'https://table-api-final-jsi4kv08v-geordies-projects-8a74623d.vercel.app/api/admin-create-booking';
        // NEW: Vercel Function URL for SECURE Admin Layout Save
        const ADMIN_SAVE_LAYOUT_API_URL = 'https://table-api-final-jsi4kv08v-geordies-projects-8a74623d.vercel.app/api/admin-save-layout';


		// --- UNIFIED COLOR CONSTANTS ---
		const TABLE_COLOR = '#b7d7a8';
		const BOOKED_COLOR = '#e0e0e0';
		const UNAVAILABLE_COLOR = '#ffffff';
		const SEAT_COLOR = '#555';
		const MULTI_SELECT_STROKE = '#ff6347';
		const SINGLE_SELECT_STROKE = '#ffeb3b';

		const STAFF_USE_TABLE_IDS = [10, 13, 12, 14, 1];
		
		let currentBookings = [];
		let currentSelectedDate = '';
		let currentSelectedTime = '';
		let currentSelectedTableId = null;
		const multiBookButton = document.getElementById('multi-book-button');

		function timeToMinutes(timeStr) {
			const parts = timeStr.split(':').map(Number);
			const hours = parts[0] || 0;
			const minutes = parts[1] || 0;
			return (hours * 60) + minutes;
		}

		function getSupabaseDate() {
			const dateInput = document.getElementById('booking-date').value;
			if (!dateInput) return '';
			
			if (dateInput.match(/^\d{4}-\d{2}-\d{2}$/)) {
				return dateInput;
			}
			if (dateInput.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
				const [day, month, year] = dateInput.split('/');
				return `${year}-${month}-${day}`;
			}
			
			const dateObj = new Date(dateInput);
			if (!isNaN(dateObj)) {
				const year = dateObj.getFullYear();
				const month = String(dateObj.getMonth() + 1).padStart(2, '0');
				const day = String(dateObj.getDate()).padStart(2, '0');
				return `${year}-${month}-${day}`;
			}
			
			return dateInput;
		}

		function setDefaultDateTime() {
			const today = new Date();
			const year = today.getFullYear();
			const month = String(today.getMonth() + 1).padStart(2, '0');
			const day = String(today.getDate()).padStart(2, '0');
			
			currentSelectedDate = `${year}-${month}-${day}`;
			currentSelectedTime = '19:00';

			document.getElementById('booking-date').value = currentSelectedDate;
			document.getElementById('booking-time').value = currentSelectedTime;
		}

		function resizeStage() {
			const containerWidth = container.offsetWidth;
			const scale = containerWidth / STAGE_WIDTH;

			stage.width(containerWidth);
			stage.height(STAGE_HEIGHT * scale);
			stage.scale({ x: scale, y: scale });

			container.style.height = `${STAGE_HEIGHT * scale}px`;

			stage.draw();
		}
		
		function loadBackground(callback) {
			const imageObj = new Image();
			imageObj.onload = function() {
				const floorplan = new Konva.Image({
					x: 0, y: 0, image: imageObj, width: STAGE_WIDTH, height: STAGE_HEIGHT,
				});
				backgroundLayer.add(floorplan);
				backgroundLayer.draw();
				
				resizeStage();	
				
				if (callback) callback();
			};
			imageObj.src = 'floorplan.png?v=' + new Date().getTime(); // CACHE BUSTER
		}

		// NEW: Function to fetch the restaurant display name
		async function loadDisplayName() {
			// This is a safe READ operation using the anonymous key
			const { data, error } = await _supa
				.from('tenants')
				.select('display_name')
				.eq('tenant_id', CURRENT_TENANT_ID)
				.single();

			if (data) {
				document.getElementById('restaurant-display-name').textContent = `${data.display_name} Admin Panel`;
			} else {
				document.getElementById('restaurant-display-name').textContent = `Admin Panel (${CURRENT_TENANT_ID})`;
				console.error("Could not fetch display name for current tenant.");
			}
		}

		async function loadTables() {
			// --- DEFINITIVE LIST OF 21 TABLES WITH CORRECT SIZES ---
			const baseTables = [
				// Original Tables 1-17
				{ id: 1, x: 235, y: 110, w: 90, h: 30, rotation: 0 },
				{ id: 2, x: 100, y: 30, w: 90, h: 30, rotation: 0 },
				{ id: 3, x: 100, y: 150, w: 30, h: 30, rotation: 0 },
				{ id: 4, x: 140, y: 220, w: 30, h: 30, rotation: 0 },
				{ id: 5, x: 180, y: 300, w: 50, h: 30, rotation: 90 }, // 4-seater
				{ id: 6, x: 250, y: 330, w: 30, h: 30, rotation: 0 },
				{ id: 7, x: 30, y: 300, w: 50, h: 30, rotation: 90 }, // 4-seater
				{ id: 8, x: 400, y: 100, w: 30, h: 30, rotation: 0 },
				{ id: 9, x: 20, y: 180, w: 30, h: 50, rotation: 0 }, // 4-seater
				{ id: 10, x: 300, y: 240, w: 30, h: 30, rotation: 0 },
				{ id: 11, x: 40, y: 80, w: 30, h: 30, rotation: 0 },
				{ id: 12, x: 350, y: 350, w: 50, h: 30, rotation: 0 }, // 4-seater
				{ id: 13, x: 400, y: 280, w: 30, h: 30, rotation: 0 },
				{ id: 14, x: 250, y: 180, w: 30, h: 30, rotation: 0 },
				
				// --- NEW TABLES REQUESTED (IDs 18-21) ---
				{ id: 18, x: 140, y: 280, w: 30, h: 30, rotation: 0 }, // New 2-seater
				{ id: 19, x: 220, y: 280, w: 30, h: 30, rotation: 0 }, // New 2-seater
				{ id: 20, x: 300, y: 280, w: 30, h: 30, rotation: 0 }, // New 2-seater
				{ id: 21, x: 300, y: 180, w: 50, h: 30, rotation: 90 }, // New 4-seater (50x30, rotated)
			];
			
			// FIX: Use the anonymous key for fetching tables (READ operation)
			let { data: dbData, error } = await _supa
			    .from('tables')
			    .select('id, x, y, rotation')
			    .eq('tenant_id', CURRENT_TENANT_ID) 
			    .order('id');

			if (error) {
				// Log the RLS/Key issue but allow the app to load default positions
				console.warn("Could not fetch table positions from Supabase. Using default initial positions. Error:", error.message);
				tables = baseTables;
			} else {
				const positionMap = new Map(dbData.map(t => [t.id, t]));
				
				tables = baseTables.map(t => {
					const dbPos = positionMap.get(t.id);
					if (dbPos) {
						return {	
							id: t.id,	
							x: dbPos.x,	
							y: dbPos.y,	
							w: t.w,	
							h: t.h,	
							rotation: dbPos.rotation	
						};
					}
					return t;	
				});
				
				tables = tables.filter((t, index, self) =>	
					index === self.findIndex((tt) => (tt.id === t.id))
				).sort((a, b) => a.id - b.id);
			}
			
			layer.destroyChildren();	
			tables.forEach(t => {
				const group = drawTable(t);
				const tableRect = group.findOne('.main-table');

				group.offset({ x: tableRect.width()/2, y: tableRect.height()/2 });
				group.x(t.x + tableRect.width()/2);
				group.y(t.y + tableRect.height()/2);
				group.rotation(t.rotation || 0);	
			});
			layer.draw();
			
			selectedMultiTables.clear();
			isMultiSelectMode = false;
			document.getElementById('multi-select-toggle').dataset.active = 'false';
			document.getElementById('multi-select-toggle').classList.remove('active');
			document.getElementById('multi-select-toggle').textContent = 'Start Multi-Select Mode';
			multiBookButton.style.display = 'none';

			await loadBookings();	
		}
		
		function updateTableVisuals() {
			tables.forEach(t => {
				const group = layer.findOne('#g-'+t.id);
				if (!group) return;
				const tableRect = group.findOne('.main-table');
				const tableIdNumber = Number(t.id);
				const isSelected = selectedMultiTables.has(tableIdNumber);
				
				if (STAFF_USE_TABLE_IDS.includes(tableIdNumber)) {
					tableRect.fill(UNAVAILABLE_COLOR);
				} else {
					const activeBooking = currentBookings.find(b =>	
						Number(b.table_id) === tableIdNumber	
					);
					tableRect.fill(activeBooking ? BOOKED_COLOR : TABLE_COLOR);
				}
				
				if (isSelected) {
					 tableRect.stroke(MULTI_SELECT_STROKE);	
					 tableRect.strokeWidth(2);
				} else if (selectedGroup && selectedGroup.id() === group.id()) {
					 tableRect.stroke(SINGLE_SELECT_STROKE);	
					 tableRect.strokeWidth(1);
				} else {
					 tableRect.stroke('#000');	
					 tableRect.strokeWidth(1);
				}
				
				group.setAttr('booking_data', currentBookings.find(b => Number(b.table_id) === tableIdNumber) || null);
			});
			layer.draw();
			
			if (isMultiSelectMode && selectedMultiTables.size > 0) {
				multiBookButton.style.display = 'block';
			} else {
				multiBookButton.style.display = 'none';
			}
		}

		function drawTable(t){
			const group = new Konva.Group({	
				x:t.x,	
				y:t.y,	
				id:'g-'+t.id,	
				table_id: Number(t.id),
				draggable:true	
			});
			layer.add(group);

			const isStaffUseOnly = STAFF_USE_TABLE_IDS.includes(t.id);

			const tableRect = new Konva.Rect({	
				width:t.w,	
				height:t.h,	
				fill: isStaffUseOnly ? UNAVAILABLE_COLOR : TABLE_COLOR,
				stroke:'#000',	
				strokeWidth:1,
				name: 'main-table'	
			});
			group.add(tableRect);

			// Seat drawing logic (crucial for correct display)
			const baseSeatSize = 12;	
			const seatHalf = baseSeatSize / 2;	

			function makeSeat(x, y, w, h) {
				group.add(new Konva.Rect({ width:w, height:h, fill:SEAT_COLOR, x:x, y:y }));
			}

			if (t.w === 30 && t.h === 30) {
				makeSeat(t.w/2 - baseSeatSize/2, -seatHalf, baseSeatSize, seatHalf);
				makeSeat(t.w/2 - baseSeatSize/2, t.h, baseSeatSize, seatHalf);
			} else if (t.w === 30 && t.h === 50) {
				const v_spacing = (t.h - 2*baseSeatSize)/3;
				makeSeat(-seatHalf, v_spacing, seatHalf, baseSeatSize);
				makeSeat(-seatHalf, v_spacing*2 + baseSeatSize, seatHalf, baseSeatSize);
				makeSeat(t.w, v_spacing, seatHalf, baseSeatSize);
				makeSeat(t.w, v_spacing*2 + baseSeatSize, seatHalf, baseSeatSize);
			} else if (t.w === 50 && t.h === 30) {	
				const h_spacing = (t.w - 2 * baseSeatSize) / 3;
				makeSeat(h_spacing, -seatHalf, baseSeatSize, seatHalf);
				makeSeat(h_spacing * 2 + baseSeatSize, -seatHalf, baseSeatSize, seatHalf);
				makeSeat(h_spacing, t.h, baseSeatSize, seatHalf);
				makeSeat(h_spacing * 2 + baseSeatSize, t.h, baseSeatSize, seatHalf);
			} else if (t.w === 90 && t.h === 30) {
				const h_spacing = t.w / 4;
				for(let i=0; i<3; i++){
					const x_pos = h_spacing*(i+1) - baseSeatSize/2;
					makeSeat(x_pos, -seatHalf, baseSeatSize, seatHalf);
					makeSeat(x_pos, t.h, baseSeatSize, seatHalf);
				}
			}
			
			// --- UPDATED CLICK HANDLER ---
			group.on('click', () => {
				const tableIdNumber = Number(t.id);
				
				if (isStaffUseOnly) {
					alert('This table is reserved for staff walk-ins and is not an online premium booking.');
					return;
				}
				
				if (isMultiSelectMode) {
					const isBooked = group.getAttr('booking_data');

					if (selectedMultiTables.has(tableIdNumber)) {
						selectedMultiTables.delete(tableIdNumber);
					} else {
						if(isBooked) {
							alert(`Table ${tableIdNumber} is already booked at this time. Please select an available table.`);
							return;
						}
						selectedMultiTables.add(tableIdNumber);
					}
					updateTableVisuals();
					selectedGroup = null;	
				} else {
					if(selectedGroup) selectedGroup.findOne('.main-table').stroke('#000');
					
					selectedGroup = group;
					group.findOne('.main-table').stroke(SINGLE_SELECT_STROKE);
					layer.draw();
					
					currentSelectedTableId = t.id;
					showBookingModal(t.id, group.getAttr('booking_data'));
				}
			});

			group.on('dblclick', (e) => {
				e.evt.preventDefault();
				const booking = group.getAttr('booking_data');
				
				if (booking) {
					if (confirm(`Table ${t.id} is booked. Do you want to cancel the booking (ID: ${booking.id})?`)) {
						deleteBooking(booking.id);
					}
				}
			});

			return group;
		}
		
		// --- Supabase Booking Functions ---
		
		async function loadBookings() {
			currentSelectedDate = document.getElementById('booking-date').value;
			currentSelectedTime = document.getElementById('booking-time').value;

			if (!currentSelectedDate || !currentSelectedTime) {
				currentBookings = [];
				updateTableVisuals();
				return;
			}
			
			// Uses the safe anonymous key for reading bookings
			const { data, error } = await _supa
				.from('premium_slots')	
				.select('*')
				.eq('date', currentSelectedDate)
				.eq('tenant_id', CURRENT_TENANT_ID); 
				
			if(error){ console.error(error); currentBookings = []; }	
			else {	
				const selectedTimeMinutes = timeToMinutes(currentSelectedTime);	
				currentBookings = data.filter(b => {
					const bookingStartMinutes = timeToMinutes(b.start_time);
					const bookingEndMinutes = timeToMinutes(b.end_time);
					return selectedTimeMinutes >= bookingStartMinutes && selectedTimeMinutes < bookingEndMinutes;
				});
			}
			updateTableVisuals();
		}
		
		// NEW: FUNCTION TO SECURELY CREATE BOOKING VIA VERCEL API
		async function createBooking(tableId, startTime, endTime, notes) {
			const date = document.getElementById('booking-date').value;
			const tenantId = CURRENT_TENANT_ID;
			
			const endTimeMinutes = timeToMinutes(endTime);
			const startTimeMinutes = timeToMinutes(startTime);

			if (STAFF_USE_TABLE_IDS.includes(Number(tableId))) {
				console.error('System Warning: Cannot create a premium slot booking on a Staff Use Only table.');
				return false;
			}

			if (endTimeMinutes <= startTimeMinutes) {
				alert('End time must be after start time.');
				return false;
			}
			
			// 1. Build the data payload
			const bookingPayload = {
				tableId: Number(tableId),
				date: date,
				startTime: startTime,
				endTime: endTime,
				notes: notes,
				tenantId: tenantId,
			};

			// 2. Call your secure Vercel function (Part 1 of the fix)
			try {
				// FIX: Updated URL to call standard API path
				const response = await fetch(ADMIN_BOOKING_API_URL, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(bookingPayload),
				});

				const result = await response.json();

				if (!response.ok) {
					alert('Admin booking failed: ' + (result.error || 'Check console for Vercel logs.'));
					console.error('Admin Booking API Error:', result.error || 'Unknown Vercel error.');
					return false;
				}

				// 3. Success handling (Reloading the bookings)
				console.log('Admin Booking Successful:', result.message);
				await loadBookings();
				return true; 
				
			} catch (error) {
				alert('Network Error: Could not reach the booking service. Check console.');
				console.error('Fetch Error:', error);
				return false;
			}
		}


		async function createBulkBooking(tableIds, startTime, endTime, notes) {
			let successfulBookings = 0;
			let failedTables = [];

			for (const tableId of tableIds) {
				// Use the new secure single booking function
				const success = await createBooking(tableId, startTime, endTime, notes); 
				if (success) {
					successfulBookings++;
				} else {
					failedTables.push(tableId);
				}
			}

			if (successfulBookings > 0) {
				let message = `Successfully booked ${successfulBookings} table(s).`;
				if (failedTables.length > 0) {
					message += ` Tables ${failedTables.join(', ')} failed due to overlaps or errors.`;
				}
				alert(message);
				// We don't need to await loadBookings here since createBooking does it for single inserts.
				// However, since we loop, let's refresh once at the end.
				await loadBookings(); 
			} else {
				alert('Bulk booking failed. Check console for details.');
			}
		}
		
		async function deleteBooking(bookingId) {
			// NOTE: This deletion uses the anonymous key. For production, it should also use a secure server endpoint.
			const { error } = await _supa.from('premium_slots').delete().eq('id', bookingId).eq('tenant_id', CURRENT_TENANT_ID);
			
			if (error) { alert('Deletion failed: '+error.message); return false; }	
			else { alert('Booking removed!'); await loadBookings(); return true; }
		}

		// --- Modal/UI Functions ---
		
		function cleanNotes(notes) {
			if (!notes) return 'None';
			
			const stripeIdRegex = /(Order|Transaction)?\s*:\s*(cs_live_|cs_test_)[a-zA-Z0-9]{24,}/g;
			
			let cleanedNotes = notes.replace(stripeIdRegex, '').trim();

			cleanedNotes = cleanedNotes.replace(/,\s*$/, '').trim();

			return cleanedNotes || 'None';
		}
		
		const singleModal = document.getElementById('booking-modal');
		const multiModal = document.getElementById('multi-booking-modal');
		const removeBookingButton = document.getElementById('remove-booking');
		
		const closeButtons = document.querySelectorAll('.close-button');	

		closeButtons.forEach(button => {
			if (button.closest('#booking-modal')) {
				button.onclick = () => { singleModal.style.display = 'none'; };
			} else if (button.closest('#multi-booking-modal')) {
				button.onclick = () => { multiModal.style.display = 'none'; };
			}
		});
		
		window.onclick = (event) => {	
			if (event.target == singleModal) { singleModal.style.display = 'none'; }	
			if (event.target == multiModal) { multiModal.style.display = 'none'; }	
		};
		
		function showBookingModal(tableId, booking) {
			if (isMultiSelectMode) {
					alert('Exit Multi-Select Mode to view/create single bookings.');
					return;
			}
			
			document.getElementById('modal-table-id').value = tableId;
			document.getElementById('modal-title').textContent = 'Table ' + tableId + ' Booking';
			
			if (STAFF_USE_TABLE_IDS.includes(Number(tableId))) {
					alert('This table is reserved for staff use and cannot be manually assigned a premium slot.');
					return;
			}

			if (booking) {
				document.getElementById('current-booking-info').style.display = 'block';
				document.getElementById('new-booking-form').style.display = 'none';
				
				document.getElementById('booked-start').textContent = booking.start_time.substring(0, 5);
				document.getElementById('booked-end').textContent = booking.end_time.substring(0, 5);
				
				document.getElementById('booked-notes').textContent = cleanNotes(booking.host_notes);	
				
				removeBookingButton.onclick = async () => {
					if (confirm('Are sure you want to remove this booking?')) {
						const success = await deleteBooking(booking.id);
						if (success) singleModal.style.display = 'none';
					}
				};
			} else {
				document.getElementById('current-booking-info').style.display = 'none';
				document.getElementById('new-booking-form').style.display = 'block';
				
				document.getElementById('start-time').value = currentSelectedTime;
				
				const [h, m] = currentSelectedTime.split(':').map(Number);
				const endDate = new Date();
				endDate.setHours(h);
				endDate.setMinutes(m);
				endDate.setHours(endDate.getHours() + 1);
				
				const endH = String(endDate.getHours()).padStart(2, '0');
				const endM = String(endDate.getMinutes()).padStart(2, '0');

				document.getElementById('end-time').value = `${endH}:${endM}`;
				document.getElementById('notes').value = '';
			}
			
			singleModal.style.display = 'block';
		}

		function showMultiBookingModal() {
			if (selectedMultiTables.size === 0) return;

			const tableIds = Array.from(selectedMultiTables).sort((a, b) => a - b).join(', ');
			document.getElementById('selected-table-list').textContent = tableIds;
			
			document.getElementById('multi-start-time').value = currentSelectedTime;
			
			const [h, m] = currentSelectedTime.split(':').map(Number);
			const endDate = new Date();
			endDate.setHours(h);
			endDate.setMinutes(m);
			endDate.setHours(endDate.getHours() + 1);
			
			const endH = String(endDate.getHours()).padStart(2, '0');
			const endM = String(endDate.getMinutes()).padStart(2, '0');

			document.getElementById('multi-end-time').value = `${endH}:${endM}`;
			document.getElementById('multi-notes').value = '';

			multiModal.style.display = 'block';
		}

		// --- Event Listeners ---
		
		window.addEventListener('resize', resizeStage);

		document.getElementById('multi-select-toggle').onclick = () => {
			const toggleButton = document.getElementById('multi-select-toggle');

			isMultiSelectMode = !isMultiSelectMode;
			
			if (isMultiSelectMode) {
				toggleButton.dataset.active = 'true';
				toggleButton.classList.add('active');
				toggleButton.textContent = 'Exit Multi-Select Mode';
				
				if(selectedGroup) {
					selectedGroup.findOne('.main-table').stroke('#000');
					selectedGroup = null;
				}
				
				layer.find('Group').forEach(group => group.draggable(false));

			} else {
				toggleButton.dataset.active = 'false';
				toggleButton.classList.remove('active');
				toggleButton.textContent = 'Start Multi-Select Mode';
				
				selectedMultiTables.clear();
				multiBookButton.style.display = 'none';

				layer.find('Group').forEach(group => group.draggable(true));
			}

			updateTableVisuals();
		};

		document.getElementById('multi-book-button').onclick = () => {
			showMultiBookingModal();
		};

		document.getElementById('multi-booking-form').onsubmit = async (e) => {
			e.preventDefault();
			
			const startTime = document.getElementById('multi-start-time').value;
			const endTime = document.getElementById('multi-end-time').value;
			const notes = document.getElementById('multi-notes').value;
			const tableIds = Array.from(selectedMultiTables);

			if (tableIds.length === 0) {
				alert("No tables selected for booking.");
				return;
			}

			await createBulkBooking(tableIds, startTime, endTime, notes);
			multiModal.style.display = 'none';
			
			selectedMultiTables.clear();
			document.getElementById('multi-select-toggle').click();	
		};

		document.getElementById('load-bookings').onclick = async () => {
			currentSelectedDate = document.getElementById('booking-date').value;
			currentSelectedTime = document.getElementById('booking-time').value;
			await loadBookings();
		};

		document.getElementById('booking-form').onsubmit = async (e) => {
			e.preventDefault();
			
			const tableId = document.getElementById('modal-table-id').value;	
			const startTime = document.getElementById('start-time').value;
			const endTime = document.getElementById('end-time').value;
			const notes = document.getElementById('notes').value;

			const success = await createBooking(tableId, startTime, endTime, notes);
			if (success) {	
				singleModal.style.display = 'none';
				await loadBookings();	
			} else {
				alert("Failed to create single booking. Check inputs/console.");
			}
		};


		document.getElementById('rotate').onclick = () => {
			if (isMultiSelectMode) {
				selectedMultiTables.forEach(tableId => {
					const group = layer.findOne('#g-' + tableId);
					if (group) {
						group.rotation(group.rotation() + 90);
					}
				});
				layer.draw();
			} else if(selectedGroup){
				selectedGroup.rotation(selectedGroup.rotation()+90);
				layer.draw();
			}
		};

		document.getElementById('save').onclick = async () => {
			const updates = tables.map(t=>{
				const g = layer.findOne('#g-'+t.id);
				if (!g) return null;	
				
				const tableRect = g.findOne('.main-table');
				const finalX = g.x() - tableRect.width()/2;
				const finalY = g.y() - tableRect.height()/2;
				const finalRotation = g.rotation();
				// CRITICAL: Ensure the tenant_id is included in the payload
				return { id:t.id, x:finalX, y:finalY, rotation: finalRotation, tenant_id: CURRENT_TENANT_ID };
			}).filter(t => t !== null);
			
			// FIX: Call the secure Vercel endpoint for RLS bypass (using standard /api/ path)
            try {
                const response = await fetch(ADMIN_SAVE_LAYOUT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ updates: updates }),
                });

                const result = await response.json();

                if (!response.ok) {
                    alert('Save failed: ' + (result.error || 'Server error. Check Vercel logs.'));
                } else {
                    // Update the local data with the confirmed data from the server
                    tables = result.data || tables;
                    alert('Layout saved!');
                }
            } catch (error) {
                // Now that the routing is fixed, this should only catch network drops.
                alert('Network Error: Could not connect to save service.');
            }
		};

		// --- Initialization ---
		setDefaultDateTime();
		window.addEventListener('resize', resizeStage);
		loadBackground(loadTables);
	</script>
</body>
</html>
