<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Admin – Drag Tables</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <style>
        body{
            font-family: Arial, Helvetica, sans-serif;
            background:#f7f7f7;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0; 
            padding: 20px 0;
        }

        /* Header container */
        h2 {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px; /* Reduced margin to fit toggle */
            flex-wrap: wrap;
            gap: 10px;
        }

        h2 .arrow {
            font-weight: 700;
            font-size: 24px;
            margin: 0 10px;
            color: #1976d2;
        }

        /* Buttons in header */
        h2 button {
            padding: 10px 20px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            color: #fff;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        h2 button#save {
            background-color: #388e3c;
        }
        h2 button#rotate {
            background-color: #1976d2;
        }

        h2 button:hover {
            box-shadow: 0 6px 14px rgba(0,0,0,0.3);
            opacity: 0.95;
        }

        /* Date/Time Selector */
        #datetime-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #datetime-controls label {
            font-weight: 600;
            color: #555;
        }

        #datetime-controls input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        
        #load-bookings {
            padding: 8px 15px;
            background-color: #f57c00;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        
        #load-bookings:hover {
            background-color: #e65100;
        }

        /* NEW: Multi-Select Toggle Button */
        #multi-select-toggle {
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #999;
            background-color: #f0f7ff;
            color: #444;
            transition: all 0.2s ease;
        }
        
        #multi-select-toggle.active {
            background-color: #1976d2;
            color: white;
            border: 1px solid #1976d2;
        }

        /* Floorplan container */
        #container-wrapper {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        #container{
            width:480px;
            height:480px;
            border:1px solid #ccc;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            background:#fff;
        }

        /* Status Legend */
        #status-legend {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            font-size: 14px;
            color: #555;
            flex-wrap: wrap;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 5px;
            border: 1px solid #ccc;
        }
        
        /* Modal styles (shared for both modals) */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        .modal-content label { display: block; margin-top: 10px; font-weight: 600; }
        .modal-content input, .modal-content textarea, .modal-content button { 
            width: 100%; 
            padding: 8px; 
            margin-top: 5px; 
            box-sizing: border-box; 
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .modal-content button {
            background-color: #388e3c;
            color: white;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .modal-content button:hover {
            background-color: #2e7d32;
        }
        
        #current-booking-info {
            padding: 10px;
            margin-top: 15px;
            border: 1px solid #ffcc80;
            background-color: #fff3e0;
            border-radius: 5px;
        }
        
        #remove-booking {
            background-color: #d32f2f;
        }
        
        /* Responsive for small screens */
        @media (max-width: 500px) {
            h2 { font-size: 18px; }
            h2 button { padding: 8px 14px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <h2>
        Drag tables <span class="arrow">→</span>
        <button id="save">Save layout</button>
        <button id="rotate">Rotate Table 90°</button>
    </h2>

    <button id="multi-select-toggle" data-active="false">Start Multi-Select Mode</button>
    <button id="multi-book-button" style="display:none; padding: 8px 15px; font-size: 14px; font-weight: 600; margin-bottom: 15px; border-radius: 5px; cursor: pointer; border: none; background-color: #388e3c; color: white;">Book Selected Tables</button>


    <div id="datetime-controls">
        <label for="booking-date">Date:</label>
        <input type="date" id="booking-date" value="">
        <label for="booking-time">Time:</label>
        <input type="time" id="booking-time" value="">
        <button id="load-bookings">Load Bookings</button>
    </div>

    <div id="container-wrapper">
        <div id="container"></div>
    </div>
    
    <div id="status-legend">
        <div class="legend-item"><span class="legend-color" style="background-color: #b7d7a8;"></span>Premium Available</div>
        <div class="legend-item"><span class="legend-color" style="background-color: #e0e0e0;"></span>Booked (Premium)</div>
        <div class="legend-item"><span class="legend-color" style="background-color: #ffffff;"></span>Staff Use Only (N/A)</div> 
    </div>

    <div id="multi-booking-modal" class="modal">
        <div class="modal-content">
            <span class="close-button multi-close-button">&times;</span>
            <h3 id="multi-modal-title">Bulk Booking</h3>
            <p>Selected Tables: <span id="selected-table-list"></span></p>
            <form id="multi-booking-form">
                <label for="multi-start-time">Start Time (HH:MM):</label>
                <input type="time" id="multi-start-time" required>
                
                <label for="multi-end-time">End Time (HH:MM):</label>
                <input type="time" id="multi-end-time" required>
                
                <label for="multi-notes">Notes:</label>
                <textarea id="multi-notes" rows="3"></textarea>
                
                <button type="submit" id="multi-book-slot">Confirm Bulk Booking</button>
            </form>
        </div>
    </div>

    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-title">Table Booking</h3>
            <form id="booking-form">
                <input type="hidden" id="modal-table-id">
                
                <div id="current-booking-info" style="display:none;">
                    <p><strong>Status:</strong> Booked</p>
                    <p><strong>Start:</strong> <span id="booked-start"></span></p>
                    <p><strong>End:</strong> <span id="booked-end"></span></p>
                    <p><strong>Notes:</strong> <span id="booked-notes"></span></p>
                    <button type="button" id="remove-booking">Remove Booking</button>
                </div>

                <div id="new-booking-form">
                    <label for="start-time">Start Time (HH:MM):</label>
                    <input type="time" id="start-time" required>
                    
                    <label for="end-time">End Time (HH:MM):</label>
                    <input type="time" id="end-time" required>
                    
                    <label for="notes">Notes:</label>
                    <textarea id="notes" rows="3"></textarea>
                    
                    <button type="submit" id="book-slot">Book Slot</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Supabase setup ---
        const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co ';
        const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
        const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

        const STAGE_WIDTH = 480;
        const STAGE_HEIGHT = 480;

        const stage = new Konva.Stage({ container:'container', width:STAGE_WIDTH, height:STAGE_HEIGHT });
        const backgroundLayer = new Konva.Layer();
        stage.add(backgroundLayer);
        const layer = new Konva.Layer(); 
        stage.add(layer);

        let tables = [];
        let selectedGroup = null;
        let isMultiSelectMode = false; 
        let selectedMultiTables = new Set(); // Stores table IDs for multi-select
        
        // --- UNIFIED COLOR CONSTANTS ---
        const TABLE_COLOR = '#b7d7a8';       
        const BOOKED_COLOR = '#e0e0e0';      
        const UNAVAILABLE_COLOR = '#ffffff'; 
        const SEAT_COLOR = '#555';           
        const MULTI_SELECT_STROKE = '#ff6347'; 
        const SINGLE_SELECT_STROKE = '#ffeb3b'; 

        const STAFF_USE_TABLE_IDS = [10, 13, 12, 14, 17, 1];
        
        let currentBookings = []; 
        let currentSelectedDate = ''; 
        let currentSelectedTime = ''; 
        let currentSelectedTableId = null; 
        const multiBookButton = document.getElementById('multi-book-button');

        function timeToMinutes(timeStr) {
            const parts = timeStr.split(':').map(Number);
            const hours = parts[0] || 0;
            const minutes = parts[1] || 0;
            return (hours * 60) + minutes;
        }

        function getSupabaseDate() {
            const dateInput = document.getElementById('booking-date').value;
            if (!dateInput) return '';
            
            if (dateInput.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return dateInput;
            }
            if (dateInput.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                const [day, month, year] = dateInput.split('/');
                return `${year}-${month}-${day}`;
            }
            
            const dateObj = new Date(dateInput);
            if (!isNaN(dateObj)) {
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return dateInput;
        }


        function setDefaultDateTime() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            
            currentSelectedDate = `${year}-${month}-${day}`;
            currentSelectedTime = '19:00'; 

            document.getElementById('booking-date').value = currentSelectedDate;
            document.getElementById('booking-time').value = currentSelectedTime;
        }

        // --- Konva Functions ---

        function loadBackground(callback) {
            const imageObj = new Image();
            imageObj.onload = function() {
                const floorplan = new Konva.Image({
                    x: 0, y: 0, image: imageObj, width: STAGE_WIDTH, height: STAGE_HEIGHT,
                });
                backgroundLayer.add(floorplan);
                backgroundLayer.draw();
                if (callback) callback();
            };
            imageObj.src = 'floorplan.png';
        }

        async function loadTables() {
            const { data, error } = await _supa.from('tables').select('*, rotation').order('id');
            if(error){ console.error(error); alert('Error loading tables'); return; }
            tables = data;
            
            layer.destroyChildren(); 
            tables.forEach(t => {
                const group = drawTable(t);
                const tableRect = group.findOne('.main-table');

                group.offset({ x: tableRect.width()/2, y: tableRect.height()/2 });
                group.x(t.x + tableRect.width()/2);
                group.y(t.y + tableRect.height()/2);
                group.rotation(t.rotation || 0); 
            });
            layer.draw();
            
            selectedMultiTables.clear();
            isMultiSelectMode = false;
            document.getElementById('multi-select-toggle').dataset.active = 'false';
            document.getElementById('multi-select-toggle').classList.remove('active');
            document.getElementById('multi-select-toggle').textContent = 'Start Multi-Select Mode';
            multiBookButton.style.display = 'none'; // Hide multi-book button on load

            await loadBookings(); 
        }
        
        function updateTableVisuals() {
            tables.forEach(t => {
                const group = layer.findOne('#g-'+t.id);
                if (!group) return;
                const tableRect = group.findOne('.main-table');
                const tableIdNumber = Number(t.id);
                const isSelected = selectedMultiTables.has(tableIdNumber);
                
                // 1. Check if table is permanently unavailable
                if (STAFF_USE_TABLE_IDS.includes(tableIdNumber)) {
                    tableRect.fill(UNAVAILABLE_COLOR);
                } else {
                    // 2. Check current bookings
                    const activeBooking = currentBookings.find(b => 
                        Number(b.table_id) === tableIdNumber 
                    );
                    tableRect.fill(activeBooking ? BOOKED_COLOR : TABLE_COLOR);
                }
                
                // 3. Set stroke based on selection state
                if (isSelected) {
                     tableRect.stroke(MULTI_SELECT_STROKE); 
                     tableRect.strokeWidth(2);
                } else if (selectedGroup && selectedGroup.id() === group.id()) {
                    tableRect.stroke(SINGLE_SELECT_STROKE); 
                    tableRect.strokeWidth(1);
                } else {
                    tableRect.stroke('#000'); 
                    tableRect.strokeWidth(1);
                }
                
                group.setAttr('booking_data', currentBookings.find(b => Number(b.table_id) === tableIdNumber) || null);
            });
            layer.draw();
            
            // Update multi-book button visibility
            if (isMultiSelectMode && selectedMultiTables.size > 0) {
                multiBookButton.style.display = 'block';
            } else {
                multiBookButton.style.display = 'none';
            }
        }

        function drawTable(t){
            const group = new Konva.Group({ 
                x:t.x, 
                y:t.y, 
                id:'g-'+t.id, 
                table_id: Number(t.id),
                draggable:true 
            });
            layer.add(group);

            const isStaffUseOnly = STAFF_USE_TABLE_IDS.includes(t.id);

            const tableRect = new Konva.Rect({ 
                width:t.w, 
                height:t.h, 
                fill: isStaffUseOnly ? UNAVAILABLE_COLOR : TABLE_COLOR,
                stroke:'#000', 
                strokeWidth:1,
                name: 'main-table' 
            });
            group.add(tableRect);

            // ... (Seat drawing logic) ...
            const baseSeatSize = 12; 
            const seatHalf = baseSeatSize / 2; 

            function makeSeat(x, y, w, h) {
                group.add(new Konva.Rect({ width:w, height:h, fill:SEAT_COLOR, x:x, y:y }));
            }

            // Seat positions
            if (t.w === 30 && t.h === 30) {
                makeSeat(t.w/2 - baseSeatSize/2, -seatHalf, baseSeatSize, seatHalf);
                makeSeat(t.w/2 - baseSeatSize/2, t.h, baseSeatSize, seatHalf);
            } else if (t.w === 30 && t.h === 50) {
                const v_spacing = (t.h - 2*baseSeatSize)/3;
                makeSeat(-seatHalf, v_spacing, seatHalf, baseSeatSize);
                makeSeat(-seatHalf, v_spacing*2 + baseSeatSize, seatHalf, baseSeatSize);
                makeSeat(t.w, v_spacing, seatHalf, baseSeatSize);
                makeSeat(t.w, v_spacing*2 + baseSeatSize, seatHalf, baseSeatSize);
            } else if (t.w === 90 && t.h === 30) {
                const h_spacing = t.w / 4;
                for(let i=0; i<3; i++){
                    const x_pos = h_spacing*(i+1) - baseSeatSize/2;
                    makeSeat(x_pos, -seatHalf, baseSeatSize, seatHalf);
                    makeSeat(x_pos, t.h, baseSeatSize, seatHalf);
                }
            }
            
            // --- UPDATED CLICK HANDLER ---
            group.on('click', () => {
                const tableIdNumber = Number(t.id);
                
                if (isStaffUseOnly) {
                    alert('This table is reserved for staff walk-ins and is not an online premium booking.');
                    return;
                }
                
                if (isMultiSelectMode) {
                    // Multi-select logic
                    const isBooked = group.getAttr('booking_data');

                    if (selectedMultiTables.has(tableIdNumber)) {
                        selectedMultiTables.delete(tableIdNumber);
                    } else {
                        // Prevent selecting a table that is already booked in the current time slot
                        if(isBooked) {
                            alert(`Table ${tableIdNumber} is already booked at this time. Please select an available table.`);
                            return;
                        }
                        selectedMultiTables.add(tableIdNumber);
                    }
                    updateTableVisuals();
                    selectedGroup = null; 
                } else {
                    // Single-select (original) logic
                    
                    if(selectedGroup) selectedGroup.findOne('.main-table').stroke('#000');
                    
                    selectedGroup = group;
                    group.findOne('.main-table').stroke(SINGLE_SELECT_STROKE);
                    layer.draw();
                    
                    currentSelectedTableId = t.id;
                    showBookingModal(t.id, group.getAttr('booking_data'));
                }
            });

            group.on('dblclick', (e) => {
                e.evt.preventDefault();
                const booking = group.getAttr('booking_data');
                
                if (booking) {
                    if (confirm(`Table ${t.id} is booked. Do you want to cancel the booking (ID: ${booking.id})?`)) {
                        deleteBooking(booking.id);
                    }
                }
            });

            return group;
        }
        
        // --- Supabase Booking Functions ---
        
        async function loadBookings() {
            currentSelectedDate = document.getElementById('booking-date').value;
            currentSelectedTime = document.getElementById('booking-time').value;

            if (!currentSelectedDate || !currentSelectedTime) {
                currentBookings = [];
                updateTableVisuals();
                return;
            }
            
            const { data, error } = await _supa
                .from('premium_slots') 
                .select('*')
                .eq('date', currentSelectedDate);
                
            if(error){ console.error(error); currentBookings = []; } 
            else { 
                const selectedTimeMinutes = timeToMinutes(currentSelectedTime); 
                currentBookings = data.filter(b => {
                    const bookingStartMinutes = timeToMinutes(b.start_time);
                    const bookingEndMinutes = timeToMinutes(b.end_time);
                    return selectedTimeMinutes >= bookingStartMinutes && selectedTimeMinutes < bookingEndMinutes;
                });
            }
            updateTableVisuals();
        }
        
        // Universal function for single booking creation
        async function createBooking(tableId, startTime, endTime, notes) {
            const date = document.getElementById('booking-date').value;
            
            const tableIdNumber = Number(tableId);
            const startTimeMinutes = timeToMinutes(startTime);
            const endTimeMinutes = timeToMinutes(endTime);
            
            if (STAFF_USE_TABLE_IDS.includes(tableIdNumber)) {
                console.error('System Warning: Cannot create a premium slot booking on a Staff Use Only table.');
                return false;
            }
            
            if (endTimeMinutes <= startTimeMinutes) {
                alert('End time must be after start time.');
                return false;
            }

            // Check for overlap against current loaded bookings
            const overlap = currentBookings.some(b => 
                Number(b.table_id) === tableIdNumber && ( 
                    startTimeMinutes < timeToMinutes(b.end_time) && endTimeMinutes > timeToMinutes(b.start_time)
                )
            );
            
            if (overlap) {
                 console.warn(`Table ${tableId} overlaps with an existing booking. Skipped.`);
                 return false;
            }
            
            const newBooking = {
                table_id: tableIdNumber,
                date: date, 
                start_time: startTime, 
                end_time: endTime, 
                host_notes: notes, 
            };

            const { error } = await _supa.from('premium_slots').insert([newBooking]); 
            
            if (error) {
                console.error(`Error creating booking for Table ${tableId}:`, error);
                return false;
            } else {
                return true;
            }
        }

        async function createBulkBooking(tableIds, startTime, endTime, notes) {
            let successfulBookings = 0;
            let failedTables = [];

            for (const tableId of tableIds) {
                const success = await createBooking(tableId, startTime, endTime, notes);
                if (success) {
                    successfulBookings++;
                } else {
                    failedTables.push(tableId);
                }
            }

            if (successfulBookings > 0) {
                let message = `Successfully booked ${successfulBookings} table(s).`;
                if (failedTables.length > 0) {
                    message += ` Tables ${failedTables.join(', ')} failed due to overlaps or errors.`;
                }
                alert(message);
                await loadBookings();
            } else {
                alert('Bulk booking failed. Check console for details.');
            }
        }
        
        async function deleteBooking(bookingId) {
            const { error } = await _supa.from('premium_slots').delete().eq('id', bookingId);
            
            if (error) { alert('Deletion failed: '+error.message); return false; } 
            else { alert('Booking removed!'); await loadBookings(); return true; }
        }

        // --- Modal/UI Functions ---
        
        const singleModal = document.getElementById('booking-modal');
        const multiModal = document.getElementById('multi-booking-modal');
        const singleCloseButton = document.querySelector('.close-button');
        const multiCloseButton = document.querySelector('.multi-close-button');
        const removeBookingButton = document.getElementById('remove-booking');
        
        singleCloseButton.onclick = () => { singleModal.style.display = 'none'; };
        multiCloseButton.onclick = () => { multiModal.style.display = 'none'; };
        window.onclick = (event) => { 
            if (event.target == singleModal) { singleModal.style.display = 'none'; } 
            if (event.target == multiModal) { multiModal.style.display = 'none'; } 
        };
        
        function showBookingModal(tableId, booking) {
            if (isMultiSelectMode) {
                 alert('Exit Multi-Select Mode to view/create single bookings.');
                 return;
            }
            
            document.getElementById('modal-table-id').value = tableId;
            document.getElementById('modal-title').textContent = 'Table ' + tableId + ' Booking';
            
            if (STAFF_USE_TABLE_IDS.includes(Number(tableId))) {
                 alert('This table is reserved for staff use and cannot be manually assigned a premium slot.');
                 return;
            }

            if (booking) {
                document.getElementById('current-booking-info').style.display = 'block';
                document.getElementById('new-booking-form').style.display = 'none';
                
                document.getElementById('booked-start').textContent = booking.start_time.substring(0, 5);
                document.getElementById('booked-end').textContent = booking.end_time.substring(0, 5);
                document.getElementById('booked-notes').textContent = booking.host_notes || 'None'; 
                
                removeBookingButton.onclick = async () => {
                    if (confirm('Are you sure you want to remove this booking?')) {
                        const success = await deleteBooking(booking.id);
                        if (success) singleModal.style.display = 'none';
                    }
                };
            } else {
                document.getElementById('current-booking-info').style.display = 'none';
                document.getElementById('new-booking-form').style.display = 'block';
                
                document.getElementById('start-time').value = currentSelectedTime;
                
                const [h, m] = currentSelectedTime.split(':').map(Number);
                const endDate = new Date();
                endDate.setHours(h);
                endDate.setMinutes(m);
                endDate.setHours(endDate.getHours() + 1);
                
                const endH = String(endDate.getHours()).padStart(2, '0');
                const endM = String(endDate.getMinutes()).padStart(2, '0');

                document.getElementById('end-time').value = `${endH}:${endM}`;
                document.getElementById('notes').value = '';
            }
            
            singleModal.style.display = 'block';
        }

        function showMultiBookingModal() {
            if (selectedMultiTables.size === 0) return;

            const tableIds = Array.from(selectedMultiTables).sort((a, b) => a - b).join(', ');
            document.getElementById('selected-table-list').textContent = tableIds;
            
            // Populate default times
            document.getElementById('multi-start-time').value = currentSelectedTime;
            
            const [h, m] = currentSelectedTime.split(':').map(Number);
            const endDate = new Date();
            endDate.setHours(h);
            endDate.setMinutes(m);
            endDate.setHours(endDate.getHours() + 1);
            
            const endH = String(endDate.getHours()).padStart(2, '0');
            const endM = String(endDate.getMinutes()).padStart(2, '0');

            document.getElementById('multi-end-time').value = `${endH}:${endM}`;
            document.getElementById('multi-notes').value = '';

            multiModal.style.display = 'block';
        }

        // --- Event Listeners ---

        document.getElementById('multi-select-toggle').onclick = () => {
            const toggleButton = document.getElementById('multi-select-toggle');

            isMultiSelectMode = !isMultiSelectMode;
            
            if (isMultiSelectMode) {
                toggleButton.dataset.active = 'true';
                toggleButton.classList.add('active');
                toggleButton.textContent = 'Exit Multi-Select Mode';
                
                if(selectedGroup) {
                    selectedGroup.findOne('.main-table').stroke('#000');
                    selectedGroup = null;
                }
                
                layer.find('Group').forEach(group => group.draggable(false));

            } else {
                toggleButton.dataset.active = 'false';
                toggleButton.classList.remove('active');
                toggleButton.textContent = 'Start Multi-Select Mode';
                
                selectedMultiTables.clear();
                multiBookButton.style.display = 'none';

                layer.find('Group').forEach(group => group.draggable(true));
            }

            updateTableVisuals();
        };

        // NEW: Multi-Book Button Event Listener
        document.getElementById('multi-book-button').onclick = () => {
            showMultiBookingModal();
        };

        // NEW: Multi-Booking Form Submission
        document.getElementById('multi-booking-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const startTime = document.getElementById('multi-start-time').value;
            const endTime = document.getElementById('multi-end-time').value;
            const notes = document.getElementById('multi-notes').value;
            const tableIds = Array.from(selectedMultiTables);

            if (tableIds.length === 0) {
                alert("No tables selected for booking.");
                return;
            }

            await createBulkBooking(tableIds, startTime, endTime, notes);
            multiModal.style.display = 'none';
            
            // Clear multi-select after bulk booking (either successful or failed)
            selectedMultiTables.clear();
            // Exit multi-select mode automatically
            document.getElementById('multi-select-toggle').click(); 
        };

        document.getElementById('load-bookings').onclick = async () => {
            currentSelectedDate = document.getElementById('booking-date').value;
            currentSelectedTime = document.getElementById('booking-time').value;
            await loadBookings();
        };

        document.getElementById('booking-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const tableId = document.getElementById('modal-table-id').value; 
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const notes = document.getElementById('notes').value;

            const success = await createBooking(tableId, startTime, endTime, notes);
            if (success) { 
                singleModal.style.display = 'none';
                await loadBookings(); 
            } else {
                alert("Failed to create single booking. Check inputs/console.");
            }
        };


        document.getElementById('rotate').onclick = () => {
            if (isMultiSelectMode) {
                selectedMultiTables.forEach(tableId => {
                    const group = layer.findOne('#g-' + tableId);
                    if (group) {
                        group.rotation(group.rotation() + 90);
                    }
                });
                layer.draw();
            } else if(selectedGroup){
                selectedGroup.rotation(selectedGroup.rotation()+90);
                layer.draw();
            }
        };

        document.getElementById('save').onclick = async () => {
            const updates = tables.map(t=>{
                const g = layer.findOne('#g-'+t.id);
                if (!g) return null; 
                
                const tableRect = g.findOne('.main-table');
                const finalX = g.x() - tableRect.width()/2;
                const finalY = g.y() - tableRect.height()/2;
                const finalRotation = g.rotation();
                return { id:t.id, x:finalX, y:finalY, rotation: finalRotation };
            }).filter(t => t !== null);
            
            const { data, error } = await _supa.from('tables').upsert(updates).select('*, rotation');
            if(error){ alert('Save failed: '+error.message); } else { tables = data; alert('Layout saved!'); }
        };

        // --- Initialization ---
        setDefaultDateTime();
        loadBackground(loadTables);
    </script>
</body>
</html>
