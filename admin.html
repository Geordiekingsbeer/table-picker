<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Admin – Drag Tables & Multi-Book</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body{
            font-family: Arial, Helvetica, sans-serif;
            background:#f7f7f7;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0; 
            padding: 20px 0;
        }
        h2{
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px; 
            flex-wrap: wrap;
            gap: 10px;
        }
        h2 .arrow{
            font-weight: 700;
            font-size: 24px;
            margin: 0 10px;
            color: #1976d2;
        }
        h2 button{
            padding: 10px 20px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            color: #fff;
            transition: all .2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,.2);
        }
        h2 button#save{background:#388e3c}
        h2 button#rotate{background:#1976d2}
        h2 button:hover{box-shadow:0 6px 14px rgba(0,0,0,.3);opacity:.95}

        #multi-select-toggle{
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #999;
            background:#f0f7ff;
            color:#444;
            transition:all .2s ease;
        }
        #multi-select-toggle.active{background:#1976d2;color:#fff;border-color:#1976d2}

        #book-selected-btn{
            background:#f57c00;
            color:#fff;
            padding:8px 15px;
            margin-left:10px;
            border:none;
            border-radius:4px;
            cursor:pointer;
            font-weight:600;
            display:none;
        }

        #datetime-controls{
            display:flex;gap:20px;margin-bottom:20px;align-items:center;
            padding:10px;background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);
        }
        #datetime-controls label{font-weight:600;color:#555}
        #datetime-controls input{padding:8px;border:1px solid #ccc;border-radius:4px;font-size:16px}
        #load-bookings{padding:8px 15px;background:#f57c00;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:600}
        #load-bookings:hover{background:#e65100}

        #container-wrapper{display:flex;justify-content:center;width:100%}
        #container{
            width:480px;height:480px;border:1px solid #ccc;
            box-shadow:0 4px 12px rgba(0,0,0,.15);background:#fff;
        }

        #status-legend{
            display:flex;gap:15px;margin-top:15px;font-size:14px;color:#555;
            flex-wrap:wrap;justify-content:center;
        }
        .legend-item{display:flex;align-items:center}
        .legend-color{width:15px;height:15px;border-radius:3px;margin-right:5px;border:1px solid #ccc}

        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;
               overflow:auto;background:rgba(0,0,0,.4)}
        .modal-content{background:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;
                       width:80%;max-width:400px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.3);position:relative}
        .close-button{color:#aaa;float:right;font-size:28px;font-weight:bold}
        .close-button:hover,.close-button:focus{color:#000;text-decoration:none;cursor:pointer}
        .modal-content label{display:block;margin-top:10px;font-weight:600}
        .modal-content input,.modal-content textarea,.modal-content button{
            width:100%;padding:8px;margin-top:5px;box-sizing:border-box;border:1px solid #ccc;border-radius:4px}
        .modal-content button{background:#388e3c;color:#fff;cursor:pointer;margin-top:20px}
        .modal-content button:hover{background:#2e7d32}
        #current-booking-info{padding:10px;margin-top:15px;border:1px solid #ffcc80;background:#fff3e0;border-radius:5px}
        #remove-booking{background:#d32f2f}

        @media(max-width:500px){
            h2{font-size:18px}
            h2 button{padding:8px 14px;font-size:14px}
            #datetime-controls{flex-direction:column}
        }
    </style>
</head>
<body>
    <h2>
        Drag tables <span class="arrow">→</span>
        <button id="save">Save layout</button>
        <button id="rotate">Rotate Table 90°</button>
    </h2>

    <button id="multi-select-toggle" data-active="false">Start Multi-Select Mode</button>
    <button id="book-selected-btn" style="display:none;">Book Selected Table</button>

    <div id="datetime-controls">
        <label for="booking-date">Date:</label>
        <input type="date" id="booking-date" value="">
        <label for="booking-time">Time:</label>
        <input type="time" id="booking-time" value="">
        <button id="load-bookings">Load Bookings</button>
    </div>

    <div id="container-wrapper"><div id="container"></div></div>

    <div id="status-legend">
        <div class="legend-item"><span class="legend-color" style="background:#b7d7a8"></span>Premium Available</div>
        <div class="legend-item"><span class="legend-color" style="background:#e0e0e0"></span>Booked (Premium)</div>
        <div class="legend-item"><span class="legend-color" style="background:#ffffff"></span>Staff Use Only (N/A)</div>
    </div>

    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-title">Table Booking</h3>
            <form id="booking-form">
                <input type="hidden" id="modal-table-id">
                <div id="current-booking-info" style="display:none">
                    <p><strong>Status:</strong> Booked</p>
                    <p><strong>Start:</strong> <span id="booked-start"></span></p>
                    <p><strong>End:</strong> <span id="booked-end"></span></p>
                    <p><strong>Notes:</strong> <span id="booked-notes"></span></p>
                    <button type="button" id="remove-booking">Remove Booking</button>
                </div>
                <div id="new-booking-form">
                    <label for="start-time">Start Time (HH:MM):</label>
                    <input type="time" id="start-time" required>
                    <label for="end-time">End Time (HH:MM):</label>
                    <input type="time" id="end-time" required>
                    <label for="notes">Notes:</label>
                    <textarea id="notes" rows="3"></textarea>
                    <button type="submit" id="book-slot">Book Slot</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2 "></script>
    <script src="https://unpkg.com/konva@9/konva.min.js "></script>
    <script>
        /* ----------  CONFIG  ---------- */
        const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co ';
        const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
        const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

        const STAGE_W = 480, STAGE_H = 480;
        const stage = new Konva.Stage({container:'container',width:STAGE_W,height:STAGE_H});
        const bgLayer  = new Konva.Layer(); stage.add(bgLayer);
        const tblLayer = new Konva.Layer(); stage.add(tblLayer);

        /* ----------  STATE  ---------- */
        let tables = [], selectedGroup = null, currentBookings = [];
        let adminSelectedIds = [], isMultiSelectMode = false;
        let currentDate = '', currentTime = '';

        /* ----------  CONSTANTS  ---------- */
        const TABLE_COLOR   = '#b7d7a8';
        const BOOKED_COLOR  = '#e0e0e0';
        const UNAVAIL_COLOR = '#ffffff';
        const SEAT_COLOR    = '#555';
        const HIGHLIGHT     = '#ffeb3b';
        const STAFF_IDS     = [10,13,12,14,17,1];

        /* ----------  DOM  ---------- */
        const multiBtn   = document.getElementById('multi-select-toggle');
        const bookBtn    = document.getElementById('book-selected-btn');
        const modal      = document.getElementById('booking-modal');
        const closeModal = document.querySelector('.close-button');

        /* ----------  UTILS  ---------- */
        const min = t=>{const[p=0,q=1]=t.split(':').map(Number);return p*60+q};
        const fmtDate = d=>d.match(/^\d{4}-\d{2}-\d{2}$)?d:(d.match(/^\d{2}\/\d{2}\/\d{4}$)?(()=>{const[x,y,z]=d.split('/');return`${z}-${y}-${x}`})():new Date(d).toISOString().slice(0,10));
        const defDateTime = ()=>{
            const t=new Date(),y=t.getFullYear(),m=String(t.getMonth()+1).padStart(2,0),d=String(t.getDate()).padStart(2,0);
            currentDate=`${y}-${m}-${d}`; currentTime='19:00';
            document.getElementById('booking-date').value=currentDate;
            document.getElementById('booking-time').value=currentTime;
        };

        /* ----------  BACKGROUND  ---------- */
        function loadBackground(cb){
            const img=new Image(); img.onload=()=>{
                bgLayer.add(new Konva.Image({x:0,y:0,image:img,width:STAGE_W,height:STAGE_H}));
                bgLayer.draw(); if(cb)cb();
            }; img.src='floorplan.png';
        }

        /* ----------  TABLE DRAW  ---------- */
        function drawTable(t){
            const g=new Konva.Group({x:t.x,y:t.y,id:`g-${t.id}`,table_id:Number(t.id),draggable:true});
            tblLayer.add(g);

            const isStaff=STAFF_IDS.includes(t.id);
            const r=new Konva.Rect({width:t.w,height:t.h,fill:isStaff?UNAVAIL_COLOR:TABLE_COLOR,stroke:'#000',strokeWidth:1,name:'main-table'});
            g.add(r);

            /* seats */
            const sz=12, hsz=sz/2;
            const seat=(x,y,w,h)=>g.add(new Konva.Rect({x,y,w,h,fill:SEAT_COLOR}));
            if(t.w===30&&t.h===30){ seat(t.w/2-hsz,-hsz,sz,hsz); seat(t.w/2-hsz,t.h,sz,hsz); }
            else if(t.w===30&&t.h===50){ const sp=(t.h-sz*2)/3; seat(-hsz,sp,hsz,sz); seat(-hsz,sp*2+sz,hsz,sz); seat(t.w,sp,hsz,sz); seat(t.w,sp*2+sz,hsz,sz); }
            else if(t.w===90&&t.h===30){ const sp=t.w/4; for(let i=0;i<3;i++){ const x=sp*(i+1)-hsz; seat(x,-hsz,sz,hsz); seat(x,t.h,sz,hsz); } }

            /* events */
            g.on('click',()=>{
                if(selectedGroup&&!isMultiSelectMode) selectedGroup.findOne('.main-table').stroke('#000');
                const tid=Number(t.id);
                if(isMultiSelectMode){
                    const idx=adminSelectedIds.indexOf(tid);
                    if(idx===-1){adminSelectedIds.push(tid); r.stroke(HIGHLIGHT);}
                    else{adminSelectedIds.splice(idx,1); r.stroke('#000');}
                    selectedGroup=adminSelectedIds.length===1?g:null;
                    bookBtn.style.display=adminSelectedIds.length===1?'inline-block':'none';
                    tblLayer.draw(); return;
                }
                selectedGroup=g; r.stroke(HIGHLIGHT); showBookingModal(t.id,g.getAttr('booking_data'));
                tblLayer.draw();
            });
            g.on('dblclick',e=>{
                e.evt.preventDefault(); const b=g.getAttr('booking_data');
                if(b&&confirm(`Cancel booking ${b.id}?`)) deleteBooking(b.id);
            });
            return g;
        }

        /* ----------  LOAD TABLES  ---------- */
        async function loadTables(){
            const {data,err}=await _supa.from('tables').select('*,rotation').order('id');
            if(err){console.error(err); alert('Error loading tables'); return;}
            tables=data; tblLayer.destroyChildren();
            tables.forEach(t=>{
                const g=drawTable(t), r=g.findOne('.main-table');
                g.offset({x:r.width()/2,y:r.height()/2});
                g.x(t.x+r.width()/2); g.y(t.y+r.height()/2);
                g.rotation(t.rotation||0);
            });
            tblLayer.draw(); await loadBookings();
        }

        /* ----------  BOOKINGS  ---------- */
        async function loadBookings(){
            currentDate=document.getElementById('booking-date').value;
            currentTime=document.getElementById('booking-time').value;
            if(!currentDate||!currentTime){currentBookings=[]; updateVisuals(); return;}
            const {data,err}=await _supa.from('premium_slots').select('*').eq('date',currentDate);
            if(err){console.error(err); currentBookings=[];}else{
                const sel=min(currentTime);
                currentBookings=data.filter(b=>sel>=min(b.start_time)&&sel<min(b.end_time));
            }
            updateVisuals();
        }
        async function createBooking(id,st,et,notes){
            if(STAFF_IDS.includes(Number(id))){alert('Staff-use table – cannot book'); return false;}
            if(min(et)<=min(st)){alert('End after start'); return false;}
            const overlap=currentBookings.some(b=>Number(b.table_id)===Number(id)&&min(st)<min(b.end_time)&&min(et)>min(b.start_time));
            if(overlap){alert('Slot overlap'); return false;}
            const {err}=await _supa.from('premium_slots').insert([{table_id:Number(id),date:currentDate,start_time:st,end_time:et,host_notes:notes}]);
            if(err){alert('Booking failed: '+err.message); return false;}
            alert('Booking saved'); return true;
        }
        async function deleteBooking(id){
            const {err}=await _supa.from('premium_slots').delete().eq('id',id);
            if(err){alert('Delete failed: '+err.message); return false;}
            alert('Booking removed'); await loadBookings(); return true;
        }

        /* ----------  VISUAL UPDATE  ---------- */
        function updateVisuals(){
            tables.forEach(t=>{
                const g=tblLayer.findOne(`#g-${t.id}`); if(!g) return;
                const r=g.findOne('.main-table');
                const booked=currentBookings.some(b=>Number(b.table_id)===Number(t.id));
                r.fill(STAFF_IDS.includes(t.id)?UNAVAIL_COLOR:(booked?BOOKED_COLOR:TABLE_COLOR));
                r.stroke(adminSelectedIds.includes(Number(t.id))||g===selectedGroup?HIGHLIGHT:'#000');
                g.setAttr('booking_data',currentBookings.find(b=>Number(b.table_id)===Number(t.id))||null);
            });
            tblLayer.draw();
            bookBtn.style.display=adminSelectedIds.length===1?'inline-block':'none';
        }

        /* ----------  MODAL  ---------- */
        function showBookingModal(id,booking){
            if(STAFF_IDS.includes(Number(id))){alert('Staff-use table – no manual slot'); return;}
            document.getElementById('modal-table-id').value=id;
            document.getElementById('modal-title').textContent='Table '+id+' Booking';
            const bookedDiv=document.getElementById('current-booking-info');
            const newDiv=document.getElementById('new-booking-form');
            if(booking){
                bookedDiv.style.display='block'; newDiv.style.display='none';
                document.getElementById('booked-start').textContent=booking.start_time.substring(0,5);
                document.getElementById('booked-end').textContent=booking.end_time.substring(0,5);
                document.getElementById('booked-notes').textContent=booking.host_notes||'None';
                document.getElementById('remove-booking').onclick=async()=>{
                    if(confirm('Remove this booking?')){await deleteBooking(booking.id); modal.style.display='none';}
                };
            }else{
                bookedDiv.style.display='none'; newDiv.style.display='block';
                document.getElementById('start-time').value=currentTime;
                const [h,m]=currentTime.split(':').map(Number);
                const end=new Date(); end.setHours(h); end.setMinutes(m+60);
                document.getElementById('end-time').value=`${String(end.getHours()).padStart(2,0)}:${String(end.getMinutes()).padStart(2,0)}`;
                document.getElementById('notes').value='';
            }
            modal.style.display='block';
        }
        closeModal.onclick=()=>modal.style.display='none';
        window.onclick=e=>{if(e.target===modal)modal.style.display='none';};

        /* ----------  BUTTON LISTENERS  ---------- */
        document.getElementById('load-bookings').onclick=loadBookings;
        bookBtn.onclick=()=>{
            if(adminSelectedIds.length===1){
                const id=adminSelectedIds[0];
                showBookingModal(id,tblLayer.findOne(`#g-${id}`).getAttr('booking_data'));
            }
        };
        document.getElementById('booking-form').onsubmit=async(e)=>{
            e.preventDefault();
            const id=document.getElementById('modal-table-id').value;
            const st=document.getElementById('start-time').value;
            const et=document.getElementById('end-time').value;
            const notes=document.getElementById('notes').value;
            if(await createBooking(id,st,et,notes)){modal.style.display='none'; await loadBookings();}
        };
        document.getElementById('rotate').onclick=()=>{
            if(selectedGroup){selectedGroup.rotation(selectedGroup.rotation()+90); tblLayer.draw();}
        };
        document.getElementById('save').onclick=async()=>{
            const ups=tables.map(t=>{
                const g=tblLayer.findOne(`#g-${t.id}`); const r=g.findOne('.main-table');
                return{id:t.id,x:g.x()-r.width()/2,y:g.y()-r.height()/2,rotation:g.rotation()};
            });
            const {data,err}=await _supa.from('tables').upsert(ups).select('*,rotation');
            if(err){alert('Save failed: '+err.message)}else{tables=data; alert('Layout saved');}
        };
        multiBtn.onclick=()=>{
            isMultiSelectMode=!isMultiSelectMode;
            multiBtn.classList.toggle('active',isMultiSelectMode);
            multiBtn.textContent=isMultiSelectMode?'Stop Multi-Select Mode':'Start Multi-Select Mode';
            adminSelectedIds=[]; if(selectedGroup) selectedGroup.findOne('.main-table').stroke('#000');
            selectedGroup=null; bookBtn.style.display='none'; updateVisuals();
        };

        /* ----------  INIT  ---------- */
        defDateTime();
        loadBackground(loadTables);
    </script>
</body>
</html>
