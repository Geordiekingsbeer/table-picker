<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Admin – Table Layout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; text-align: center; }
    h2 { margin-top: 10px; }
    #room {
      background: url('floorplan.png') no-repeat center center;
      background-size: contain;
      border: 1px solid #ccc;
      margin: 20px auto;
      position: relative;
      width: 480px;
      height: 480px;
    }
    .table {
      position: absolute;
      background: #A8E6CF;
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      border: 1px solid #000;
      cursor: move;
      user-select: none;
      transform-origin: center center;
    }
    .rotateBtn {
      position: absolute;
      bottom: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      padding: 2px 5px;
      cursor: pointer;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 3px;
    }
    #saveBtn {
      margin-top: 15px;
      padding: 12px 24px;
      font-size: 16px;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Drag tables where you want → Rotate → Save layout</h2>
  <div id="room"></div>
  <button id="saveBtn">Save Layout</button>

  <script>
    // ✅ Supabase setup
    const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
    const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';  // <-- replace with your real anon key
    const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

    const room = document.getElementById('room');
    const saveBtn = document.getElementById('saveBtn');

    async function loadTables() {
      const { data, error } = await _supa.from('tables').select('*').order('id');
      if (error) { console.error(error); return; }
      data.forEach(drawTable);
    }

    function drawTable(t) {
      const d = document.createElement('div');
      d.className = 'table';
      d.id = 't-' + t.id;
      d.style.left = t.x + 'px';
      d.style.top = t.y + 'px';
      d.style.width = t.w + 'px';
      d.style.height = t.h + 'px';
      d.style.transform = `rotate(${t.rotation || 0}deg)`;

      // rotate button
      const rotateBtn = document.createElement('button');
      rotateBtn.textContent = '⟳';
      rotateBtn.className = 'rotateBtn';
      rotateBtn.onclick = (e) => {
        e.stopPropagation();
        let current = parseInt(d.dataset.rotation || t.rotation || 0);
        current = (current + 90) % 360;
        d.dataset.rotation = current;
        d.style.transform = `rotate(${current}deg)`;
      };

      d.appendChild(rotateBtn);

      // drag behaviour
      let offsetX, offsetY;
      d.onmousedown = (e) => {
        if (e.target.tagName === 'BUTTON') return; // ignore clicks on rotate button
        offsetX = e.offsetX;
        offsetY = e.offsetY;
        function move(ev) {
          d.style.left = (ev.pageX - room.offsetLeft - offsetX) + 'px';
          d.style.top = (ev.pageY - room.offsetTop - offsetY) + 'px';
        }
        document.addEventListener('mousemove', move);
        document.onmouseup = () => {
          document.removeEventListener('mousemove', move);
          document.onmouseup = null;
        };
      };

      room.appendChild(d);
    }

    saveBtn.onclick = async () => {
      const updates = [];
      document.querySelectorAll('.table').forEach(el => {
        const id = el.id.replace('t-', '');
        updates.push({
          id: parseInt(id),
          x: parseInt(el.style.left),
          y: parseInt(el.style.top),
          w: parseInt(el.style.width),
          h: parseInt(el.style.height),
          rotation: parseInt(el.dataset.rotation || 0)
        });
      });
      for (let row of updates) {
        const { error } = await _supa.from('tables').update(row).eq('id', row.id);
        if (error) console.error(error);
      }
      alert('Layout saved!');
    };

    loadTables();
  </script>
</body>
</html>
