<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Admin – Drag Tables</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f7f7f7;text-align:center}
    h2{margin:10px}
    button{padding:8px 16px;font-size:14px;margin:0 5px}
    #save{background:#388e3c;color:#fff;border:none;border-radius:4px;cursor:pointer}
    #container{display:flex;justify-content:center;margin-top:10px}
  </style>
</head>
<body>
  <h2>
    Drag tables where you want → 
    <button id="save">Save layout</button>
    <button id="rotate">Rotate Selected</button>
  </h2>
  <div id="container"></div>

  <script>
    /* CONFIG – Supabase setup */
    const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
    const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // your anon key
    const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

    const stage = new Konva.Stage({ container: 'container', width: 480, height: 480 });
    const layer = new Konva.Layer();
    stage.add(layer);

    let tables = [];
    let selectedGroup = null;

    async function loadTables() {
      const { data, error } = await _supa.from('tables').select('*').order('id');
      if (error) { alert('Load error: ' + error.message); return; }
      tables = data;
      data.forEach(drawTable);
    }

    function drawTable(t) {
      const group = new Konva.Group({
        x: t.x,
        y: t.y,
        draggable: true,
        id: 'g-' + t.id,
        rotation: t.rotation || 0
      });

      const rect = new Konva.Rect({
        width: t.w,
        height: t.h,
        fill: '#A8E6CF',
        stroke: '#000',
        cornerRadius: 4,
        offsetX: t.w / 2,
        offsetY: t.h / 2
      });

      group.add(rect);

      // Click to select table
      group.on('click', () => {
        selectedGroup = group;
        layer.draw();
      });

      group.on('dragend', () => {
        const idx = tables.findIndex(tt => tt.id === t.id);
        tables[idx].x = Math.round(group.x());
        tables[idx].y = Math.round(group.y());
      });

      layer.add(group);
    }

    // Rotate button
    rotate.onclick = () => {
      if (!selectedGroup) {
        alert('Click on a table first!');
        return;
      }
      const currentRotation = selectedGroup.rotation();
      selectedGroup.rotation(currentRotation + 90);
      layer.draw();

      // Save new rotation in our local array
      const id = parseInt(selectedGroup.id().split('-')[1]);
      const idx = tables.findIndex(tt => tt.id === id);
      tables[idx].rotation = selectedGroup.rotation();
    };

    save.onclick = async () => {
      const updates = tables.map(t => ({
        id: t.id,
        x: t.x,
        y: t.y,
        rotation: t.rotation || 0
      }));
      const { error } = await _supa.from('tables').upsert(updates);
      if (error) alert('Save failed');
      else alert('Layout saved – customers see it instantly');
    };

    loadTables();
  </script>
</body>
</html>
