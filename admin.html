<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Admin – Drag Tables</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f7f7f7}
    h2{margin:10px}
    button{padding:8px 16px;font-size:14px;margin:0 5px}
    #save{background:#388e3c;color:#fff;border:none;border-radius:4px;cursor:pointer}
    #container{display:flex;justify-content:center;margin-top:10px}
    .seat {width: 12px; height:12px; background:#444; border:1px solid #000;}
  </style>
</head>
<body>
  <h2>Drag tables where you want → <button id="save">Save layout</button></h2>
  <div id="container"></div>

  <script>
    const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
    const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
    const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

    const stage = new Konva.Stage({ container: 'container', width: 480, height: 480 });
    const layer = new Konva.Layer();
    stage.add(layer);

    let tables = [];

    async function loadTables() {
      const { data, error } = await _supa.from('tables').select('*').order('id');
      if (error) { alert('Load error: ' + error.message); console.error(error); return; }
      tables = data;
      data.forEach(drawTable);
    }

    function drawTable(t) {
      const group = new Konva.Group({
        x: t.x,
        y: t.y,
        draggable: true,
        id: 'g-' + t.id
      });

      // Table rectangle
      const table = new Konva.Rect({
        width: t.w,
        height: t.h,
        fill: '#b7d7a8',
        stroke: '#000',
        strokeWidth: 1,
        cornerRadius: 4
      });

      group.add(table);

      // Add seats
      addSeats(group, t.w, t.h);

      layer.add(group);

      group.on('dragend', () => {
        const idx = tables.findIndex(tt => tt.id === t.id);
        tables[idx].x = Math.round(group.x());
        tables[idx].y = Math.round(group.y());
      });
    }

    function addSeats(group, w, h) {
      const seatSize = 12;
      function makeSeat(x, y) {
        const seat = new Konva.Rect({
          x, y, width: seatSize, height: seatSize, fill: '#444', stroke: '#000', strokeWidth: 1
        });
        group.add(seat);
      }

      if (w === 30 && h === 30) {
        // 2-seater square table: one on each opposite side
        makeSeat(w/2 - seatSize/2, -seatSize/2); // top
        makeSeat(w/2 - seatSize/2, h);           // bottom
      } else if ((w === 30 && h === 60) || (w === 60 && h === 30)) {
        // 4-seater rectangle table: 2 per long side
        if (w > h) { // horizontal table
          makeSeat(w/4 - seatSize/2, -seatSize/2); // top-left
          makeSeat(3*w/4 - seatSize/2, -seatSize/2); // top-right
          makeSeat(w/4 - seatSize/2, h);           // bottom-left
          makeSeat(3*w/4 - seatSize/2, h);         // bottom-right
        } else { // vertical table
          makeSeat(-seatSize/2, h/4 - seatSize/2); // left-top
          makeSeat(-seatSize/2, 3*h/4 - seatSize/2); // left-bottom
          makeSeat(w, h/4 - seatSize/2); // right-top
          makeSeat(w, 3*h/4 - seatSize/2); // right-bottom
        }
      }
      else if (w === 90 && h === 30) {
        // Larger table example: 4 per long side
        for (let i = 1; i <= 4; i++) {
          makeSeat(i*(w/5) - seatSize/2, -seatSize/2); // top
          makeSeat(i*(w/5) - seatSize/2, h); // bottom
        }
      }
    }

    save.onclick = async () => {
      const updates = tables.map(t => ({ id: t.id, x: t.x, y: t.y }));
      const { error } = await _supa.from('tables').upsert(updates);
      if (error) alert('Save failed');
      else alert('Layout saved – customers see it instantly');
    };

    loadTables();
  </script>
</body>
</html>
