<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Admin – Drag Tables</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/konva@9/konva.min.js"></script>
<style>
body{
    font-family: Arial, Helvetica, sans-serif;
    background:#f7f7f7;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    margin: 0; 
    padding: 20px 0;
}
h2 {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  font-weight: 700;
  color: #333;
  margin-bottom: 25px;
  flex-wrap: wrap;
  gap: 10px;
  width: 100%;
}
h2 .arrow { font-weight:700; font-size:24px; margin:0 10px; color:#1976d2; }
h2 button {
  padding: 10px 20px;
  font-size: 15px;
  font-weight: 600;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  color: #fff;
  transition: all 0.2s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
h2 button#save { background-color: #388e3c; }
h2 button#rotate { background-color: #1976d2; }
h2 button:hover { box-shadow: 0 6px 14px rgba(0,0,0,0.3); opacity:0.95; }

#schedule-controls {
  margin-bottom: 15px;
  padding: 10px 20px; 
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  display: flex;
  align-items: center;
  gap: 15px;
}
#schedule-controls label {
  font-weight: 600;
  margin-right: 5px;
  font-size: 14px;
  color: #555;
}
#schedule-controls input, #schedule-controls select {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
#schedule-controls button {
  background: #1976d2; 
  color: #fff;
  padding: 8px 15px;
  font-weight: 600;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

#block-input-area {
  margin-top: 10px;
  margin-bottom: 20px;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #fff8e1;
  display: none;
  flex-direction: column;
  align-items: flex-start;
  width: 450px;
  box-sizing: border-box;
}
#block-input-area input {
  margin-bottom: 10px;
  width: 100%;
  padding: 8px;
  box-sizing: border-box;
}
#block-input-area button { margin-top: 10px; align-self:flex-end; }

#container-wrapper { display:flex; justify-content:center; width:100%; }
#container {
  width:480px;
  height:480px;
  border:1px solid #ccc;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  background:#fff;
}

@media (max-width: 500px) {
  h2 { font-size:18px; }
  h2 button { padding: 8px 14px; font-size:14px; }
}
</style>
</head>
<body>

<h2>
Drag tables <span class="arrow">→</span>
<button id="save">Save layout</button>
<button id="rotate">Rotate Table 90°</button>
</h2>

<div id="schedule-controls">
  <label for="booking-date">Date:</label>
  <input type="date" id="booking-date">
  
  <label for="booking-time">View Time:</label>
  <select id="booking-time"></select>
  
  <button id="view-schedule">Refresh Map</button>
</div>

<div id="block-input-area">
  <p style="margin-top:0;">**Manually Block Table <span id="block-table-id" style="font-weight:700; color: #d32f2f;"></span>**</p>
  <label for="block-start-time">Start Time:</label>
  <input type="time" id="block-start-time" required>
  <label for="block-end-time">End Time:</label>
  <input type="time" id="block-end-time" required>
  <label for="host-notes">Host Notes:</label>
  <input type="text" id="host-notes" required>
  <button id="block-slot-button" style="background:#d32f2f;">Block Slot</button>
</div>

<div id="container-wrapper">
  <div id="container"></div>
</div>

<script>
const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

const STAGE_WIDTH = 480, STAGE_HEIGHT = 480;
const stage = new Konva.Stage({ container:'container', width:STAGE_WIDTH, height:STAGE_HEIGHT });
const backgroundLayer = new Konva.Layer(); stage.add(backgroundLayer);
const layer = new Konva.Layer(); stage.add(layer);

let tables = [], selectedGroup = null;
const TABLE_COLOR = '#b7d7a8', SEAT_COLOR = '#555', TAKEN_COLOR = '#9e9e9e';
const TURN_DURATION_MINUTES = 90;
let selectedTableId = null;

const timeToMinutes = time => { const [h,m]=time.split(':').map(Number); return h*60+m; };

// Populate time dropdown
function populateTimeDropdown() {
  const select = document.getElementById('booking-time');
  const slots = ["17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:30","22:00"];
  slots.forEach(t => { const o=document.createElement('option'); o.value=t; o.textContent=t; select.appendChild(o); });
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('booking-date').value = today;
  select.value = slots[2];
}

// Load bookings for selected date/time
async function loadBookings(date, time) {
  const selectedMinutes = timeToMinutes(time);
  const { data, error } = await _supa.from('premium_slots')
    .select('table_id,start_time,end_time')
    .eq('date', date);
  if(error){ console.error(error); return []; }
  return data.filter(slot => {
    const start = timeToMinutes(slot.start_time);
    const end = slot.end_time ? timeToMinutes(slot.end_time) : start + TURN_DURATION_MINUTES;
    return end > selectedMinutes && start < selectedMinutes + TURN_DURATION_MINUTES;
  }).map(b=>b.table_id);
}

// Draw floorplan
function loadBackground(callback){
  const img = new Image();
  img.onload = function(){
    const floor = new Konva.Image({ x:0, y:0, image:img, width:STAGE_WIDTH, height:STAGE_HEIGHT });
    backgroundLayer.add(floor);
    backgroundLayer.draw();
    if(callback) callback();
  };
  img.src='floorplan.png';
}

// Draw tables
async function loadTables(){
  layer.destroyChildren();
  selectedGroup = null;

  const date = document.getElementById('booking-date').value;
  const time = document.getElementById('booking-time').value;

  const blockedTableIds = await loadBookings(date, time);

  const { data, error } = await _supa.from('tables').select('*, rotation').order('id');
  if(error){ console.error(error); alert('Error loading tables'); return; }
  tables = data;

  tables.forEach(t=>{
    const blocked = blockedTableIds.includes(t.id);
    const group = new Konva.Group({ x:t.x, y:t.y, id:'g-'+t.id, draggable:true });
    layer.add(group);

    const tableRect = new Konva.Rect({ width:t.w, height:t.h, fill: blocked ? TAKEN_COLOR : TABLE_COLOR, stroke:'#000', strokeWidth:1, name:'main-table' });
    group.add(tableRect);

    // Simple seat drawing
    group.add(new Konva.Rect({ x: t.w/2 - 6, y: -6, width:12, height:6, fill:SEAT_COLOR })); // top seat
    group.add(new Konva.Rect({ x: t.w/2 - 6, y: t.h, width:12, height:6, fill:SEAT_COLOR })); // bottom seat

    group.offset({ x:tableRect.width()/2, y:tableRect.height()/2 });
    group.x(t.x + tableRect.width()/2);
    group.y(t.y + tableRect.height()/2);
    group.rotation(t.rotation || 0);

    group.on('mousedown touchstart', ()=>{
      if(selectedGroup) { const prev = selectedGroup.findOne('.main-table'); if(prev) prev.stroke('#000'); }
      selectedGroup = group;
      tableRect.stroke('#ffeb3b');
      layer.draw();

      selectedTableId = group.id();
      document.getElementById('block-table-id').textContent = selectedTableId.replace('g-','');
      document.getElementById('block-input-area').style.display='flex';
    });
  });
  layer.draw();
}

// Manual block
document.getElementById('block-slot-button').onclick=async()=>{
  const date=document.getElementById('booking-date').value;
  const start=document.getElementById('block-start-time').value;
  const end=document.getElementById('block-end-time').value;
  const notes=document.getElementById('host-notes').value;
  if(!selectedGroup || !start || !end || !notes){ alert('Fill all fields & select table'); return; }

  const tableId=parseInt(selectedGroup.id().replace('g-',''),10);
  const { error } = await _supa.from('premium_slots').insert([{ table_id:tableId, date, start_time:start, end_time:end, host_notes:notes }]);
  if(error){ alert('Error: '+error.message); return; }
  alert('Slot blocked!');

  // Hide input and refresh
  document.getElementById('block-input-area').style.display='none';
  selectedGroup=null;
  await loadTables();
};

// Admin buttons
document.getElementById('view-schedule').onclick=()=>loadTables();
document.getElementById('rotate').onclick=()=>{
  if(selectedGroup){ selectedGroup.rotation(selectedGroup.rotation()+90); layer.draw(); }
};
document.getElementById('save').onclick=async()=>{
  const updates=tables.map(t=>{
    const g=layer.findOne('#g-'+t.id);
    if(!g) return t;
    const rect=g.findOne('.main-table');
    const x=g.x()-rect.width()/2, y=g.y()-rect.height()/2, rotation=g.rotation();
    return { id:t.id, x, y, rotation };
  });
  const { data, error }=await _supa.from('tables').upsert(updates).select('*, rotation');
  if(error){ alert('Save failed: '+error.message); } else { tables=data; alert('Layout saved!'); }
};

// Initial load
populateTimeDropdown();
loadBackground(loadTables);

</script>
</body>
</html>
