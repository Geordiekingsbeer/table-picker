<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Admin – Drag Tables</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f7f7f7;text-align:center}
    h2{margin:10px}
    button{padding:8px 16px;font-size:14px;margin:0 5px}
    #save{background:#388e3c;color:#fff;border:none;border-radius:4px;cursor:pointer}
    #rotate{background:#1976d2;color:#fff;border:none;border-radius:4px;cursor:pointer}
    #container{display:flex;justify-content:center;margin-top:10px}
  </style>
</head>
<body>
  <h2>Drag tables where you want → 
    <button id="save">Save layout</button> 
    <button id="rotate">Rotate 90°</button>
  </h2>
  <div id="container"></div>

  <script>
    const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
    const supabaseAnon = 'YOUR_SUPABASE_ANON_KEY';
    const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

    const stage = new Konva.Stage({ container: 'container', width: 480, height: 480 });
    const layer = new Konva.Layer();
    stage.add(layer);

    // Background floorplan
    const bgImage = new Image();
    bgImage.src = 'floorplan.png';
    bgImage.onload = () => {
      const bg = new Konva.Image({ x:0, y:0, width:480, height:480, image:bgImage });
      layer.add(bg);
      layer.draw();
    }

    let tables = [];
    let selectedGroup = null;

    async function loadTables() {
      const { data, error } = await _supa.from('tables').select('*').order('id');
      if (error) { alert('Load error: ' + error.message); console.error(error); return; }
      tables = data;
      data.forEach(drawTable);
    }

    function drawTable(t) {
      const group = new Konva.Group({ x:t.x, y:t.y, draggable:true, id:'g-'+t.id });
      const table = new Konva.Rect({ width:t.w, height:t.h, fill:'#A8E6CF', stroke:'#000', strokeWidth:1, cornerRadius:4 });
      group.add(table);

      addSeats(group, t); // rectangle seats behind table

      layer.add(group);
      layer.draw();

      group.on('dragend', () => {
        const idx = tables.findIndex(tt=>tt.id===t.id);
        tables[idx].x = Math.round(group.x());
        tables[idx].y = Math.round(group.y());
      });

      group.on('click', () => { selectedGroup = group; });
    }

    function addSeats(group, table){
      const seatW = 6, seatH = 12; // rectangle seat
      const w = table.w, h = table.h;
      const cap = table.capacity || 4;

      function makeSeat(x,y){
        const seat = new Konva.Rect({ x:x, y:y, width:seatW, height:seatH, fill:'#444', stroke:'#000', strokeWidth:1 });
        group.add(seat);
        seat.moveToBottom(); // behind table
      }

      if(cap===2){
        makeSeat(w/2 - seatW/2, -seatH/2); // top
        makeSeat(w/2 - seatW/2, h - seatH/2); // bottom
      }
      else if(cap===4){
        makeSeat(w/4 - seatW/2, -seatH/2);
        makeSeat(3*w/4 - seatW/2, -seatH/2);
        makeSeat(w/4 - seatW/2, h - seatH/2);
        makeSeat(3*w/4 - seatW/2, h - seatH/2);
      }
      else if(cap===6){
        for(let i=1;i<=3;i++){
          makeSeat(i*(w/4) - seatW/2, -seatH/2); // top
          makeSeat(i*(w/4) - seatW/2, h - seatH/2); // bottom
        }
      }
    }

    document.getElementById('rotate').onclick = () => {
      if(selectedGroup){
        selectedGroup.rotate(90);
        layer.draw();
      }
    }

    document.getElementById('save').onclick = async () => {
      const updates = tables.map(t => ({ id:t.id, x:t.x, y:t.y, w:t.w, h:t.h, capacity:t.capacity }));
      const { error } = await _supa.from('tables').upsert(updates);
      if(error) alert('Save failed: '+error.message);
      else alert('Layout saved – customers see it instantly');
    }

    loadTables();
  </script>
</body>
</html>
