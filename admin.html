<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Admin Table Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Load Supabase + Konva first -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/konva@9/konva.min.js"></script>

<style>
	body {
		font-family: Arial, sans-serif;
		display: flex;
		flex-direction: column;
		align-items: center;
		background: #e3e3e3;
		padding: 20px;
		min-height: 100vh;
	}
	h1 { font-size: 28px; margin-bottom: 10px; }
	#multi-select-toggle {
		padding: 10px 15px;
		font-size: 16px;
		font-weight: 500;
		margin-bottom: 20px;
		border-radius: 4px;
		cursor: pointer;
		border: 1px solid #ccc;
		background-color: #f7f7f7;
		color: #333;
		width: 90vw;
		max-width: 480px;
	}
	#multi-select-toggle.active {
		background-color: #1976d2;
		color: white;
		border-color: #1976d2;
	}
	#container-wrapper {
		display: flex;
		justify-content: center;
		width: 100%;
		max-width: 480px;
	}
	#container { width: 100%; height: auto; background-color: transparent; }
	.status-legend {
		margin-top: 10px;
		font-size: 14px;
		color: #555;
		display: flex;
		gap: 15px;
		justify-content: center;
		flex-wrap: wrap;
		max-width: 480px;
		width: 100%;
	}
	.legend-item { display: flex; align-items: center; }
	.legend-color {
		width: 15px; height: 15px;
		border-radius: 3px;
		margin-right: 5px;
		border: 1px solid #000;
	}
</style>
</head>
<body>

<h1>Admin Table Manager</h1>
<button id="multi-select-toggle" data-active="false">Start Group Selection (Tap Mode)</button>

<div id="container-wrapper">
	<div id="container"></div>
</div>

<div class="status-legend">
	<div class="legend-item"><span class="legend-color" style="background:#b7d7a8"></span>Available</div>
	<div class="legend-item"><span class="legend-color" style="background:#e0e0e0"></span>Booked</div>
	<div class="legend-item"><span class="legend-color" style="background:#fff"></span>Staff Use</div>
	<div class="legend-item"><span class="legend-color" style="background:#E5FF80"></span>Selected</div>
</div>

<script>
// --- CONFIG ---
const STAGE_WIDTH = 480, STAGE_HEIGHT = 480;
const TABLE_COLOR = '#b7d7a8';
const BOOKED_COLOR = '#e0e0e0';
const UNAVAILABLE_COLOR = '#ffffff';
const HIGHLIGHT_COLOR = '#E5FF80';
const STAFF_USE_TABLE_IDS = [10, 13, 12, 14, 1];

// âœ… Initialize Supabase
const _supa = supabase.createClient(
  'https://Rrjvdabtqzkaomjuiref.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg'
);

// --- KONVA SETUP ---
const stage = new Konva.Stage({
	container: 'container',
	width: STAGE_WIDTH,
	height: STAGE_HEIGHT
});
const bgLayer = new Konva.Layer();
const layer = new Konva.Layer();
stage.add(bgLayer);
stage.add(layer);

let selectedTableIds = [];
let currentBookings = [];
let tableDataMap = new Map();
let isMultiSelectMode = false;

// --- UTILITIES ---
function calculateTotal() {
	return selectedTableIds.reduce((sum, id) => sum + (tableDataMap.get(id)?.price || 0), 0);
}

function resizeStage() {
	const w = container.offsetWidth;
	const scale = w / STAGE_WIDTH;
	stage.width(w);
	stage.height(STAGE_HEIGHT * scale);
	stage.scale({ x: scale, y: scale });
	container.style.height = `${STAGE_HEIGHT * scale}px`;
	stage.draw();
}

// --- DRAWING ---
function drawTable(t) {
	const g = new Konva.Group({ x: t.x, y: t.y, id: 'g-' + t.id, name: 'selectable-table' });
	layer.add(g);
	const rect = new Konva.Rect({
		width: t.w, height: t.h,
		fill: TABLE_COLOR,
		stroke: '#000',
		strokeWidth: 1,
		name: 'main-table'
	});
	g.add(rect);
	g.on('click tap', e => selectTable(t.id, e.evt));
	return g;
}

function updateVisuals() {
	stage.find('.main-table').forEach(r => {
		const id = Number(r.getParent().id().split('-')[1]);
		if (STAFF_USE_TABLE_IDS.includes(id)) r.fill(UNAVAILABLE_COLOR);
		else if (currentBookings.some(b => Number(b.table_id) === id)) r.fill(BOOKED_COLOR);
		else r.fill(TABLE_COLOR);
		r.stroke('#000');
		r.strokeWidth(1);
	});
	selectedTableIds.forEach(id => {
		const g = layer.findOne('#g-' + id);
		if (g) {
			const r = g.findOne('.main-table');
			if (r.fill() === TABLE_COLOR) r.fill(HIGHLIGHT_COLOR);
		}
	});
	layer.draw();
}

// --- SELECT LOGIC ---
function selectTable(id, evt) {
	const g = layer.findOne('#g-' + id);
	const r = g.findOne('.main-table');
	if ([BOOKED_COLOR, UNAVAILABLE_COLOR].includes(r.fill())) {
		alert('This table is not available.');
		return;
	}

	const multi = evt && (evt.shiftKey || evt.ctrlKey || evt.metaKey) || isMultiSelectMode;
	const idx = selectedTableIds.indexOf(id);

	if (idx === -1) {
		if (!multi) {
			selectedTableIds = [];
			stage.find('.main-table').forEach(rr => {
				if (rr.fill() === HIGHLIGHT_COLOR) rr.fill(TABLE_COLOR);
			});
		}
		selectedTableIds.push(id);
		r.fill(HIGHLIGHT_COLOR);
	} else {
		if (multi || selectedTableIds.length === 1) {
			selectedTableIds.splice(idx, 1);
			r.fill(TABLE_COLOR);
		}
	}
	layer.draw();
}

// --- BUTTON HANDLERS ---
document.getElementById('multi-select-toggle').onclick = () => {
	isMultiSelectMode = !isMultiSelectMode;
	const btn = document.getElementById('multi-select-toggle');
	btn.classList.toggle('active', isMultiSelectMode);
	btn.textContent = isMultiSelectMode ? 'Exit Multi-Select Mode' : 'Start Group Selection (Tap Mode)';
};

// --- FLOORPLAN LOADER ---
function loadFloorplan(cb) {
	const img = new Image();
	img.onload = () => {
		bgLayer.add(new Konva.Image({ x: 0, y: 0, image: img, width: STAGE_WIDTH, height: STAGE_HEIGHT }));
		bgLayer.draw();
		resizeStage();
		if (cb) cb();
	};
	img.src = 'floorplan.png?v=' + Date.now();
}

async function loadTables() {
	const base = [
		{ id: 1, x: 235, y: 110, w: 90, h: 30 },
		{ id: 2, x: 100, y: 30, w: 90, h: 30 },
		{ id: 3, x: 100, y: 150, w: 30, h: 30 }
	];
	layer.destroyChildren();
	tableDataMap.clear();
	base.forEach(t => {
		tableDataMap.set(t.id, { id: t.id, price: 999 });
		drawTable(t);
	});
	layer.draw();
	updateVisuals();
}

// --- INIT ---
window.addEventListener('resize', resizeStage);
loadFloorplan(loadTables);
</script>
</body>
</html>
