<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Admin – Drag Tables</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f7f7f7;text-align:center}
    h2{margin:10px}
    button{padding:8px 16px;font-size:14px;margin:0 5px}
    #save{background:#388e3c;color:#fff;border:none;border-radius:4px;cursor:pointer}
    #rotate{background:#1976d2;color:#fff;border:none;border-radius:4px;cursor:pointer}
    #container{display:flex;justify-content:center;margin-top:10px;border:1px solid #ccc;background:#fff;position:relative;width:480px;height:480px;
      background: url('floorplan.png') no-repeat center center;
      background-size: contain;
    }
  </style>
</head>
<body>
  <h2>Drag tables where you want → <button id="save">Save layout</button> <button id="rotate">Rotate Selected Table 90°</button></h2>
  <div id="container"></div>

  <script>
    // Supabase setup
    const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
    const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
    const supabase = supabase.createClient(supabaseUrl, supabaseAnon);

    const stage = new Konva.Stage({ container: 'container', width: 480, height: 480 });
    const layer = new Konva.Layer();
    stage.add(layer);

    let tables = [];
    let selectedGroup = null;

    async function loadTables() {
      const { data, error } = await supabase.from('tables').select('*').order('id');
      if (error) { console.error(error); alert('Error loading tables'); return; }
      tables = data;
      data.forEach(drawTable);
    }

    function drawTable(t) {
      const group = new Konva.Group({
        x: t.x,
        y: t.y,
        id: 'g-' + t.id,
        draggable: true,
        rotation: t.rotation || 0
      });

      // Table rectangle
      const table = new Konva.Rect({
        width: t.w,
        height: t.h,
        fill: '#b7d7a8',
        stroke: '#000',
        strokeWidth: 1,
        cornerRadius: 4
      });

      // Add table to group
      group.add(table);

      // Add seats under table
      const seats = createSeats(t.w, t.h, t.seats); // returns array of Konva.Rects
      seats.forEach(s => group.add(s));

      layer.add(group);

      // Table click selects
      group.on('click', () => {
        selectedGroup = group;
        layer.children.forEach(g => g.findOne('Rect').stroke('#000')); // reset all borders
        table.stroke('#ffeb3b'); // highlight selected table
        layer.draw();
      });
    }

    function createSeats(tableWidth, tableHeight, seatCount) {
      const seatSize = { w: 20, h: 10 }; // 2x1 proportion in px
      const seats = [];
      if (seatCount === 2) {
        // two seater (30x30)
        seats.push(new Konva.Rect({ x:0, y: (tableHeight - seatSize.h)/2, width: seatSize.w, height: seatSize.h, fill:'#555', listening:false }));
        seats.push(new Konva.Rect({ x: tableWidth - seatSize.w, y: (tableHeight - seatSize.h)/2, width: seatSize.w, height: seatSize.h, fill:'#555', listening:false }));
      } else if (seatCount === 4) {
        // four seater (30x50)
        seats.push(new Konva.Rect({ x:0, y: (tableHeight - seatSize.h)/2, width: seatSize.w, height: seatSize.h, fill:'#555', listening:false }));
        seats.push(new Konva.Rect({ x:tableWidth - seatSize.w, y: (tableHeight - seatSize.h)/2, width: seatSize.w, height: seatSize.h, fill:'#555', listening:false }));
        seats.push(new Konva.Rect({ x: (tableWidth - seatSize.w)/2, y:0, width: seatSize.w, height: seatSize.h, fill:'#555', listening:false }));
        seats.push(new Konva.Rect({ x: (tableWidth - seatSize.w)/2, y:tableHeight - seatSize.h, width: seatSize.w, height: seatSize.h, fill:'#555', listening:false }));
      } else if (seatCount === 6) {
        // six seater (90x30)
        for (let i=0;i<3;i++){
          seats.push(new Konva.Rect({ x: i*25+5, y:-seatSize.h/2, width: seatSize.w, height: seatSize.h, fill:'#555', listening:false }));
          seats.push(new Konva.Rect({ x: i*25+5, y:tableHeight - seatSize.h/2, width: seatSize.w, height: seatSize.h, fill:'#555', listening:false }));
        }
      }
      return seats;
    }

    save.onclick = async () => {
      if (!tables.length) return;
      const updates = stage.children.map(g => {
        return { id: parseInt(g.id().replace('g-','')), x: Math.round(g.x()), y: Math.round(g.y()), rotation: g.rotation() };
      });
      const { error } = await supabase.from('tables').upsert(updates);
      if (error) alert('Save failed: '+error.message);
      else alert('Layout saved');
    };

    rotate.onclick = () => {
      if (!selectedGroup) return;
      selectedGroup.rotate(90);
      selectedGroup.draw();
    };

    loadTables();
  </script>
</body>
</html>
