<script>
    // --- Supabase setup ---
    const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co ';
    const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
    const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

    const STAGE_WIDTH = 480;
    const STAGE_HEIGHT = 480;

    const stage = new Konva.Stage({ container:'container', width:STAGE_WIDTH, height:STAGE_HEIGHT });
    const backgroundLayer = new Konva.Layer();
    stage.add(backgroundLayer);
    const layer = new Konva.Layer(); 
    stage.add(layer);

    let tables = [];
    let selectedGroup = null;
    let isMultiSelectMode = false; 
    let selectedMultiTables = new Set(); // Stores table IDs for multi-select
    
    // --- UNIFIED COLOR CONSTANTS ---
    const TABLE_COLOR = '#b7d7a8';       
    const BOOKED_COLOR = '#e0e0e0';      
    const UNAVAILABLE_COLOR = '#ffffff'; 
    const SEAT_COLOR = '#555';           
    const MULTI_SELECT_STROKE = '#ff6347'; 
    const SINGLE_SELECT_STROKE = '#ffeb3b'; 

    const STAFF_USE_TABLE_IDS = [10, 13, 12, 14, 17, 1];
    
    let currentBookings = []; 
    let currentSelectedDate = ''; 
    let currentSelectedTime = ''; 
    let currentSelectedTableId = null; 
    const multiBookButton = document.getElementById('multi-book-button');

    function timeToMinutes(timeStr) {
        const parts = timeStr.split(':').map(Number);
        const hours = parts[0] || 0;
        const minutes = parts[1] || 0;
        return (hours * 60) + minutes;
    }

    function getSupabaseDate() {
        const dateInput = document.getElementById('booking-date').value;
        if (!dateInput) return '';
        // ... (date conversion logic is unchanged) ...
        if (dateInput.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return dateInput;
        }
        if (dateInput.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            const [day, month, year] = dateInput.split('/');
            return `${year}-${month}-${day}`;
        }
        
        const dateObj = new Date(dateInput);
        if (!isNaN(dateObj)) {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        return dateInput;
    }


    function setDefaultDateTime() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        
        currentSelectedDate = `${year}-${month}-${day}`;
        currentSelectedTime = '19:00'; 

        document.getElementById('booking-date').value = currentSelectedDate;
        document.getElementById('booking-time').value = currentSelectedTime;
    }

    // --- Konva Functions ---

    function loadBackground(callback) {
        const imageObj = new Image();
        imageObj.onload = function() {
            const floorplan = new Konva.Image({
                x: 0, y: 0, image: imageObj, width: STAGE_WIDTH, height: STAGE_HEIGHT,
            });
            backgroundLayer.add(floorplan);
            backgroundLayer.draw();
            if (callback) callback();
        };
        imageObj.src = 'floorplan.png';
    }

    async function loadTables() {
        const { data, error } = await _supa.from('tables').select('*, rotation').order('id');
        if(error){ console.error(error); alert('Error loading tables'); return; }
        tables = data;
        
        layer.destroyChildren(); 
        tables.forEach(t => {
            const group = drawTable(t);
            const tableRect = group.findOne('.main-table');

            group.offset({ x: tableRect.width()/2, y: tableRect.height()/2 });
            group.x(t.x + tableRect.width()/2);
            group.y(t.y + tableRect.height()/2);
            group.rotation(t.rotation || 0); 
        });
        layer.draw();
        
        selectedMultiTables.clear();
        isMultiSelectMode = false;
        document.getElementById('multi-select-toggle').dataset.active = 'false';
        document.getElementById('multi-select-toggle').classList.remove('active');
        document.getElementById('multi-select-toggle').textContent = 'Start Multi-Select Mode';
        multiBookButton.style.display = 'none'; // Hide multi-book button on load

        await loadBookings(); 
    }
    
    function updateTableVisuals() {
        tables.forEach(t => {
            const group = layer.findOne('#g-'+t.id);
            if (!group) return;
            const tableRect = group.findOne('.main-table');
            const tableIdNumber = Number(t.id);
            const isSelected = selectedMultiTables.has(tableIdNumber);
            
            // 1. Check if table is permanently unavailable
            if (STAFF_USE_TABLE_IDS.includes(tableIdNumber)) {
                tableRect.fill(UNAVAILABLE_COLOR);
            } else {
                // 2. Check current bookings
                const activeBooking = currentBookings.find(b => 
                    Number(b.table_id) === tableIdNumber 
                );
                tableRect.fill(activeBooking ? BOOKED_COLOR : TABLE_COLOR);
            }
            
            // 3. Set stroke based on selection state
            if (isSelected) {
                 tableRect.stroke(MULTI_SELECT_STROKE); 
                 tableRect.strokeWidth(2);
            } else if (selectedGroup && selectedGroup.id() === group.id()) {
                tableRect.stroke(SINGLE_SELECT_STROKE); 
                tableRect.strokeWidth(1);
            } else {
                tableRect.stroke('#000'); 
                tableRect.strokeWidth(1);
            }
            
            group.setAttr('booking_data', currentBookings.find(b => Number(b.table_id) === tableIdNumber) || null);
        });
        layer.draw();
        
        // Update multi-book button visibility
        if (isMultiSelectMode && selectedMultiTables.size > 0) {
            multiBookButton.style.display = 'block';
        } else {
            multiBookButton.style.display = 'none';
        }
    }

    function drawTable(t){
        const group = new Konva.Group({ 
            x:t.x, 
            y:t.y, 
            id:'g-'+t.id, 
            table_id: Number(t.id),
            draggable:true 
        });
        layer.add(group);

        const isStaffUseOnly = STAFF_USE_TABLE_IDS.includes(t.id);

        const tableRect = new Konva.Rect({ 
            width:t.w, 
            height:t.h, 
            fill: isStaffUseOnly ? UNAVAILABLE_COLOR : TABLE_COLOR,
            stroke:'#000', 
            strokeWidth:1,
            name: 'main-table' 
        });
        group.add(tableRect);

        // ... (Seat drawing logic is omitted for brevity) ...
        const baseSeatSize = 12; 
        const seatHalf = baseSeatSize / 2; 

        function makeSeat(x, y, w, h) {
            group.add(new Konva.Rect({ width:w, height:h, fill:SEAT_COLOR, x:x, y:y }));
        }

        // Seat positions
        if (t.w === 30 && t.h === 30) {
            makeSeat(t.w/2 - baseSeatSize/2, -seatHalf, baseSeatSize, seatHalf);
            makeSeat(t.w/2 - baseSeatSize/2, t.h, baseSeatSize, seatHalf);
        } else if (t.w === 30 && t.h === 50) {
            const v_spacing = (t.h - 2*baseSeatSize)/3;
            makeSeat(-seatHalf, v_spacing, seatHalf, baseSeatSize);
            makeSeat(-seatHalf, v_spacing*2 + baseSeatSize, seatHalf, baseSeatSize);
            makeSeat(t.w, v_spacing, seatHalf, baseSeatSize);
            makeSeat(t.w, v_spacing*2 + baseSeatSize, seatHalf, baseSeatSize);
        } else if (t.w === 90 && t.h === 30) {
            const h_spacing = t.w / 4;
            for(let i=0; i<3; i++){
                const x_pos = h_spacing*(i+1) - baseSeatSize/2;
                makeSeat(x_pos, -seatHalf, baseSeatSize, seatHalf);
                makeSeat(x_pos, t.h, baseSeatSize, seatHalf);
            }
        }
        
        // --- UPDATED CLICK HANDLER ---
        group.on('click', () => {
            const tableIdNumber = Number(t.id);
            
            if (isStaffUseOnly) {
                alert('This table is reserved for staff walk-ins and is not an online premium booking.');
                return;
            }
            
            if (isMultiSelectMode) {
                // Multi-select logic
                if (selectedMultiTables.has(tableIdNumber)) {
                    selectedMultiTables.delete(tableIdNumber);
                } else {
                    // Prevent selecting a table that is already booked in the current time slot
                    const isBooked = group.getAttr('booking_data');
                    if(isBooked) {
                        alert(`Table ${tableIdNumber} is already booked at this time.`);
                        return;
                    }
                    selectedMultiTables.add(tableIdNumber);
                }
                updateTableVisuals();
                selectedGroup = null; 
            } else {
                // Single-select (original) logic
                
                if(selectedGroup) selectedGroup.findOne('.main-table').stroke('#000');
                
                selectedGroup = group;
                group.findOne('.main-table').stroke(SINGLE_SELECT_STROKE);
                layer.draw();
                
                currentSelectedTableId = t.id;
                showBookingModal(t.id, group.getAttr('booking_data'));
            }
        });

        group.on('dblclick', (e) => {
            e.evt.preventDefault();
            const booking = group.getAttr('booking_data');
            
            if (booking) {
                if (confirm(`Table ${t.id} is booked. Do you want to cancel the booking (ID: ${booking.id})?`)) {
                    deleteBooking(booking.id);
                }
            }
        });

        return group;
    }
    
    // --- Supabase Booking Functions ---
    
    async function loadBookings() {
        currentSelectedDate = document.getElementById('booking-date').value;
        currentSelectedTime = document.getElementById('booking-time').value;

        if (!currentSelectedDate || !currentSelectedTime) {
            currentBookings = [];
            updateTableVisuals();
            return;
        }
        
        const { data, error } = await _supa
            .from('premium_slots') 
            .select('*')
            .eq('date', currentSelectedDate);
            
        if(error){ console.error(error); currentBookings = []; } 
        else { 
            const selectedTimeMinutes = timeToMinutes(currentSelectedTime); 
            currentBookings = data.filter(b => {
                const bookingStartMinutes = timeToMinutes(b.start_time);
                const bookingEndMinutes = timeToMinutes(b.end_time);
                return selectedTimeMinutes >= bookingStartMinutes && selectedTimeMinutes < bookingEndMinutes;
            });
        }
        updateTableVisuals();
    }
    
    async function createBooking(tableId, startTime, endTime, notes) {
        const date = document.getElementById('booking-date').value;
        
        const tableIdNumber = Number(tableId);
        const startTimeMinutes = timeToMinutes(startTime);
        const endTimeMinutes = timeToMinutes(endTime);
        
        if (STAFF_USE_TABLE_IDS.includes(tableIdNumber)) {
            alert('System Warning: Cannot create a premium slot booking on a Staff Use Only table.');
            return false;
        }
        
        if (endTimeMinutes <= startTimeMinutes) {
            alert('End time must be after start time.');
            return false;
        }

        const overlap = currentBookings.some(b => 
            Number(b.table_id) === tableIdNumber && ( 
                startTimeMinutes < timeToMinutes(b.end_time) && endTimeMinutes > timeToMinutes(b.start_time)
            )
        );
        
        if (overlap) {
             alert(`Table ${tableId} overlaps with an existing booking. Skipped.`);
             return false;
        }
        
        const newBooking = {
            table_id: tableIdNumber,
            date: date, 
            start_time: startTime, 
            end_time: endTime, 
            host_notes: notes, 
        };

        const { error } = await _supa.from('premium_slots').insert([newBooking]); 
        
        if (error) {
            console.error(`Error creating booking for Table ${tableId}:`, error);
            return false;
        } else {
            return true;
        }
    }

    async function createBulkBooking(tableIds, startTime, endTime, notes) {
        let successfulBookings = 0;
        let failedTables = [];

        for (const tableId of tableIds) {
            const success = await createBooking(tableId, startTime, endTime, notes);
            if (success) {
                successfulBookings++;
            } else {
                failedTables.push(tableId);
            }
        }

        if (successfulBookings > 0) {
            let message = `Successfully booked ${successfulBookings} table(s).`;
            if (failedTables.length > 0) {
                message += ` Tables ${failedTables.join(', ')} failed due to overlaps or errors.`;
            }
            alert(message);
            await loadBookings();
        } else {
            alert('Bulk booking failed. Check console for details.');
        }
    }
    
    async function deleteBooking(bookingId) {
        const { error } = await _supa.from('premium_slots').delete().eq('id', bookingId);
        
        if (error) { alert('Deletion failed: '+error.message); return false; } 
        else { alert('Booking removed!'); await loadBookings(); return true; }
    }

    // --- Modal/UI Functions ---
    
    const singleModal = document.getElementById('booking-modal');
    const multiModal = document.getElementById('multi-booking-modal');
    const singleCloseButton = document.querySelector('.close-button');
    const multiCloseButton = document.querySelector('.multi-close-button');
    const removeBookingButton = document.getElementById('remove-booking');
    
    singleCloseButton.onclick = () => { singleModal.style.display = 'none'; };
    multiCloseButton.onclick = () => { multiModal.style.display = 'none'; };
    window.onclick = (event) => { 
        if (event.target == singleModal) { singleModal.style.display = 'none'; } 
        if (event.target == multiModal) { multiModal.style.display = 'none'; } 
    };
    
    function showBookingModal(tableId, booking) {
        if (isMultiSelectMode) {
             alert('Exit Multi-Select Mode to view/create single bookings.');
             return;
        }
        
        document.getElementById('modal-table-id').value = tableId;
        document.getElementById('modal-title').textContent = 'Table ' + tableId + ' Booking';
        
        if (STAFF_USE_TABLE_IDS.includes(Number(tableId))) {
             alert('This table is reserved for staff use and cannot be manually assigned a premium slot.');
             return;
        }

        if (booking) {
            document.getElementById('current-booking-info').style.display = 'block';
            document.getElementById('new-booking-form').style.display = 'none';
            
            document.getElementById('booked-start').textContent = booking.start_time.substring(0, 5);
            document.getElementById('booked-end').textContent = booking.end_time.substring(0, 5);
            document.getElementById('booked-notes').textContent = booking.host_notes || 'None'; 
            
            removeBookingButton.onclick = async () => {
                if (confirm('Are you sure you want to remove this booking?')) {
                    const success = await deleteBooking(booking.id);
                    if (success) singleModal.style.display = 'none';
                }
            };
        } else {
            document.getElementById('current-booking-info').style.display = 'none';
            document.getElementById('new-booking-form').style.display = 'block';
            
            document.getElementById('start-time').value = currentSelectedTime;
            
            const [h, m] = currentSelectedTime.split(':').map(Number);
            const endDate = new Date();
            endDate.setHours(h);
            endDate.setMinutes(m);
            endDate.setHours(endDate.getHours() + 1);
            
            const endH = String(endDate.getHours()).padStart(2, '0');
            const endM = String(endDate.getMinutes()).padStart(2, '0');

            document.getElementById('end-time').value = `${endH}:${endM}`;
            document.getElementById('notes').value = '';
        }
        
        singleModal.style.display = 'block';
    }

    function showMultiBookingModal() {
        if (selectedMultiTables.size === 0) return;

        const tableIds = Array.from(selectedMultiTables).sort((a, b) => a - b).join(', ');
        document.getElementById('selected-table-list').textContent = tableIds;
        
        // Populate default times
        document.getElementById('multi-start-time').value = currentSelectedTime;
        
        const [h, m] = currentSelectedTime.split(':').map(Number);
        const endDate = new Date();
        endDate.setHours(h);
        endDate.setMinutes(m);
        endDate.setHours(endDate.getHours() + 1);
        
        const endH = String(endDate.getHours()).padStart(2, '0');
        const endM = String(endDate.getMinutes()).padStart(2, '0');

        document.getElementById('multi-end-time').value = `${endH}:${endM}`;
        document.getElementById('multi-notes').value = '';

        multiModal.style.display = 'block';
    }

    // --- Event Listeners ---

    document.getElementById('multi-select-toggle').onclick = () => {
        const toggleButton = document.getElementById('multi-select-toggle');

        isMultiSelectMode = !isMultiSelectMode;
        
        if (isMultiSelectMode) {
            toggleButton.dataset.active = 'true';
            toggleButton.classList.add('active');
            toggleButton.textContent = 'Exit Multi-Select Mode';
            
            if(selectedGroup) {
                selectedGroup.findOne('.main-table').stroke('#000');
                selectedGroup = null;
            }
            
            layer.find('Group').forEach(group => group.draggable(false));

        } else {
            toggleButton.dataset.active = 'false';
            toggleButton.classList.remove('active');
            toggleButton.textContent = 'Start Multi-Select Mode';
            
            selectedMultiTables.clear();
            multiBookButton.style.display = 'none';

            layer.find('Group').forEach(group => group.draggable(true));
        }

        updateTableVisuals();
    };

    // NEW: Multi-Book Button Event Listener
    document.getElementById('multi-book-button').onclick = () => {
        showMultiBookingModal();
    };

    // NEW: Multi-Booking Form Submission
    document.getElementById('multi-booking-form').onsubmit = async (e) => {
        e.preventDefault();
        
        const startTime = document.getElementById('multi-start-time').value;
        const endTime = document.getElementById('multi-end-time').value;
        const notes = document.getElementById('multi-notes').value;
        const tableIds = Array.from(selectedMultiTables);

        if (tableIds.length === 0) {
            alert("No tables selected for booking.");
            return;
        }

        await createBulkBooking(tableIds, startTime, endTime, notes);
        multiModal.style.display = 'none';
        
        // Clear multi-select after successful bulk booking
        selectedMultiTables.clear();
        document.getElementById('multi-select-toggle').click(); // Exit multi-select mode
    };

    document.getElementById('load-bookings').onclick = async () => {
        currentSelectedDate = document.getElementById('booking-date').value;
        currentSelectedTime = document.getElementById('booking-time').value;
        await loadBookings();
    };

    document.getElementById('booking-form').onsubmit = async (e) => {
        e.preventDefault();
        
        const tableId = document.getElementById('modal-table-id').value; 
        const startTime = document.getElementById('start-time').value;
        const endTime = document.getElementById('end-time').value;
        const notes = document.getElementById('notes').value;

        const success = await createBooking(tableId, startTime, endTime, notes);
        if (success) { 
            singleModal.style.display = 'none';
            await loadBookings(); 
        }
    };


    document.getElementById('rotate').onclick = () => {
        if (isMultiSelectMode) {
            selectedMultiTables.forEach(tableId => {
                const group = layer.findOne('#g-' + tableId);
                if (group) {
                    group.rotation(group.rotation() + 90);
                }
            });
            layer.draw();
        } else if(selectedGroup){
            selectedGroup.rotation(selectedGroup.rotation()+90);
            layer.draw();
        }
    };

    document.getElementById('save').onclick = async () => {
        const updates = tables.map(t=>{
            const g = layer.findOne('#g-'+t.id);
            if (!g) return null; 
            
            const tableRect = g.findOne('.main-table');
            const finalX = g.x() - tableRect.width()/2;
            const finalY = g.y() - tableRect.height()/2;
            const finalRotation = g.rotation();
            return { id:t.id, x:finalX, y:finalY, rotation: finalRotation };
        }).filter(t => t !== null);
        
        const { data, error } = await _supa.from('tables').upsert(updates).select('*, rotation');
        if(error){ alert('Save failed: '+error.message); } else { tables = data; alert('Layout saved!'); }
    };

    // --- Initialization ---
    setDefaultDateTime();
    loadBackground(loadTables);
</script>
