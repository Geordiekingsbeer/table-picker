<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin – Drag Tables</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #fafafa;
      margin: 20px;
      text-align: center;
    }
    h3 {
      margin-bottom: 20px;
    }
    button {
      margin: 5px;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      background-color: #4caf50;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background-color: #45a049;
    }
    #container {
      margin: 20px auto;
      width: 480px;
      height: 480px;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 12px;
    }
    #datetime-controls {
      margin-top: 10px;
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
      margin: 5px 10px;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      display: inline-block;
      border: 1px solid #999;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <h3>Admin Table Layout</h3>

  <div>
    <button id="save">Save Layout</button>
    <button id="rotate">Rotate 90°</button>
  </div>

  <div>
    <label for="booking-date">Date:</label>
    <input type="date" id="booking-date">
    <label for="booking-time">Time:</label>
    <input type="time" id="booking-time">
    <button id="check-bookings">Check Bookings</button>
  </div>

  <div id="container"></div>

  <div id="status-legend">
    <div class="legend-item"><span class="legend-color" style="background-color: #b7d7a8;"></span> Premium Available</div>
    <div class="legend-item"><span class="legend-color" style="background-color: #e0e0e0;"></span> Booked (Premium)</div>
    <div class="legend-item"><span class="legend-color" style="background-color: #ffffff;"></span> Staff Use Only</div>
  </div>

  <script>
    const STAGE_WIDTH = 480, STAGE_HEIGHT = 480;
    const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co';
    const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
    const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

    const TABLE_COLOR = '#b7d7a8', BOOKED = '#e0e0e0', STAFF = '#ffffff';
    const STAFF_IDS = [10, 13, 12, 14, 1];

    const container = document.getElementById('container');
    const stage = new Konva.Stage({ container: 'container', width: STAGE_WIDTH, height: STAGE_HEIGHT });
    const bgLayer = new Konva.Layer(), tblLayer = new Konva.Layer();
    stage.add(bgLayer); stage.add(tblLayer);

    let tableMap = new Map(), selectedTable = null, bookings = [];

    function timeToMin(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }

    function resizeStage() {
      const w = container.offsetWidth, scale = w / STAGE_WIDTH;
      stage.width(w); stage.height(STAGE_HEIGHT * scale);
      stage.scale({ x: scale, y: scale });
      container.style.height = STAGE_HEIGHT * scale + 'px';
      stage.draw();
    }

    function loadBackground(cb) {
      const img = new Image();
      img.onload = () => {
        bgLayer.add(new Konva.Image({ x: 0, y: 0, image: img, width: STAGE_WIDTH, height: STAGE_HEIGHT }));
        bgLayer.draw(); resizeStage(); if (cb) cb();
      };
      img.src = 'floorplan.png?v=' + Date.now();
    }

    const baseTables = [
      { id: 1, x: 235, y: 110, w: 90, h: 30, rotation: 0 }, { id: 2, x: 100, y: 30, w: 90, h: 30, rotation: 0 },
      { id: 3, x: 100, y: 150, w: 30, h: 30, rotation: 0 }, { id: 4, x: 140, y: 220, w: 30, h: 30, rotation: 0 },
      { id: 5, x: 180, y: 300, w: 50, h: 30, rotation: 90 }, { id: 6, x: 250, y: 330, w: 30, h: 30, rotation: 0 },
      { id: 7, x: 30, y: 300, w: 50, h: 30, rotation: 90 }, { id: 8, x: 400, y: 100, w: 30, h: 30, rotation: 0 },
      { id: 9, x: 20, y: 180, w: 30, h: 50, rotation: 0 }, { id: 10, x: 300, y: 240, w: 30, h: 30, rotation: 0 },
      { id: 11, x: 40, y: 80, w: 30, h: 30, rotation: 0 }, { id: 12, x: 350, y: 350, w: 50, h: 30, rotation: 0 },
      { id: 13, x: 400, y: 280, w: 30, h: 30, rotation: 0 }, { id: 14, x: 250, y: 180, w: 30, h: 30, rotation: 0 },
      { id: 18, x: 140, y: 280, w: 30, h: 30, rotation: 0 }, { id: 19, x: 220, y: 280, w: 30, h: 30, rotation: 0 },
      { id: 20, x: 300, y: 280, w: 30, h: 30, rotation: 0 }, { id: 21, x: 300, y: 180, w: 50, h: 30, rotation: 90 }
    ];

    async function loadTables() {
      tblLayer.destroyChildren(); tableMap.clear();

      try {
        const { data: dbData } = await _supa.from('tables').select('id,x,y,rotation').order('id');
        const positionMap = new Map((dbData || []).map(t => [t.id, t]));
        const tables = baseTables.map(t => positionMap.get(t.id) ? { ...t, ...positionMap.get(t.id) } : t);

        tables.forEach(t => drawTable(t));
        await loadBookings();
      } catch (e) {
        console.error("Error loading tables:", e);
      }
    }

    function drawTable(t) {
      const g = new Konva.Group({ id: 'g-' + t.id, table_id: t.id, x: t.x, y: t.y });
      tblLayer.add(g);

      const isStaff = STAFF_IDS.includes(t.id);
      const r = new Konva.Rect({
        width: t.w, height: t.h, fill: isStaff ? STAFF : TABLE_COLOR,
        stroke: '#000', strokeWidth: 1, name: 'main-table'
      });
      g.add(r);

      g.offset({ x: r.width() / 2, y: r.height() / 2 });
      g.x(t.x + r.width() / 2);
      g.y(t.y + r.height() / 2);
      g.rotation(t.rotation || 0);
      g.draggable(true);

      g.on('click tap', () => selectedTable = t.id);
      tableMap.set(t.id, { id: t.id, group: g, rect: r });
      tblLayer.draw();
    }

    async function loadBookings() {
      const date = document.getElementById('booking-date').value;
      const time = document.getElementById('booking-time').value;
      if (!date || !time) return;

      const { data, error } = await _supa.from('premium_slots').select('*').eq('date', date);
      if (error) { console.error(error); return; }

      const m = timeToMin(time);
      bookings = data.filter(b => m >= timeToMin(b.start_time) && m < timeToMin(b.end_time));
      updateVisual();
    }

    function updateVisual() {
      tableMap.forEach(t => {
        const booked = bookings.some(b => Number(b.table_id) === t.id);
        if (STAFF_IDS.includes(t.id)) t.rect.fill(STAFF);
        else t.rect.fill(booked ? BOOKED : TABLE_COLOR);
      });
      tblLayer.draw();
    }

    document.getElementById('save').onclick = async () => {
      const updates = Array.from(tableMap.values()).map(t => ({
        id: t.id,
        x: t.group.x() - t.rect.width() / 2,
        y: t.group.y() - t.rect.height() / 2,
        rotation: t.group.rotation()
      }));

      const { error } = await _supa.from('tables').upsert(updates);
      if (error) alert("Save failed: " + error.message);
      else alert("Layout saved successfully!");
    };

    document.getElementById('check-bookings').onclick = loadBookings;

    function setDefaultDateTime() {
      const today = new Date();
      const y = today.getFullYear(), m = String(today.getMonth() + 1).padStart(2, '0'), d = String(today.getDate()).padStart(2, '0');
      document.getElementById('booking-date').value = `${y}-${m}-${d}`;
      document.getElementById('booking-time').value = '19:00';
    }

    setDefaultDateTime();
    loadBackground(loadTables);
    window.addEventListener('resize', resizeStage);

    // --- AUTO REFRESH BOOKINGS every 60 seconds ---
    setInterval(async () => {
      try {
        await loadBookings();
        console.log("Bookings auto-refreshed at", new Date().toLocaleTimeString());
      } catch (err) {
        console.error("Auto-refresh failed:", err);
      }
    }, 60000);
  </script>
</body>
</html>
